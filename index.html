<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLCEK WH - MAKASSAR</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>

/* Membuat area badge menempel di bawah layar */
.sticky-badge {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #000; /* Hitam */
    color: #ff0; /* Kuning */
    text-align: center;
    padding: 15px 0;
    font-weight: bold;
    font-size: 14px;
    border-top: 2px dashed #ff0;
    z-index: 9999; /* Pastikan paling depan */
    cursor: pointer;
}

/* Beri jarak bawah pada main_app supaya konten paling bawah tidak tertutup badge */
#main_app {
    padding-bottom: 70px; 
}

        /* Tombol Close Pojok Kanan Atas */
        .btn-close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 20001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        :root { --green: #70ad47; --orange: #e67e22; --blue: #2980b9; --red: #c0392b; }
        * { box-sizing: border-box; font-family: 'Arial Black', sans-serif; }
        body { background: #b0b0b0; padding: 15px; margin: 0; }
        
        #login_screen {
            position: fixed; inset: 0; background: #2c3e50; z-index: 30000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        .login-box {
            background: white; padding: 25px; border-radius: 10px; width: 100%; max-width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .login-box h2 { text-align: center; margin-bottom: 20px; color: #333; font-size: 18px; }

        .user-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #34495e; color: white; padding: 5px 15px;
            border-radius: 5px; margin-bottom: 10px; font-size: 12px;
        }
        .btn-logout {
            background: var(--red); color: white; border: none; padding: 5px 10px;
            border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 10px;
        }

        .header { background: black; color: white; text-align: center; padding: 12px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
        .input-row { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
        .label { width: 110px; padding: 10px; font-size: 10px; color: white; border-radius: 5px; font-weight: bold; background: var(--green); text-transform: uppercase; }
        input, select { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #777; font-size: 13px; font-weight: bold; }
        input[readonly] { background: #dcdcdc; color: #333; }
        .footer { display: flex; gap: 8px; margin-top: 15px; }
        .btn-main { flex: 1; padding: 15px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; }
        #loader {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7); /* Background gelap transparan */
    /* Z-INDEX HARUS LEBIH TINGGI DARI MODAL (biasanya modal itu 1000-2000) */
    z-index: 99999; 
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: white;
}

/* Tambahkan animasi putar agar lebih jelas sedang proses */
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/*CSS khusus tabel monitoring*/
    .table-monitor { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
    .table-monitor th { background: #2c3e50; color: white; padding: 8px; border: 1px solid #ddd; }
    .table-monitor td { padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; }
    .table-monitor tr:nth-child(even) { background-color: #f2f2f2; }
    .status-match { color: #27ae60; }
    .status-pending { color: #e67e22; }


.circle-loader {
  width: 48px;
  height: 48px;
  border: 5px solid rgba(255,255,255,0.3);
  border-top: 5px solid #ffffff;
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

.my-swal-z-index {
    z-index: 99999 !important; /* Angka tertinggi agar tidak tertutup apapun */
}

/* Tambahkan di bagian <style> */
.antrian-footer {
    position: sticky;
    bottom: 0;
    background: black;
    color: yellow;
    text-align: center;
    padding: 10px;
    font-size: 11px;
    margin-top: 10px;
    border-radius: 5px 5px 0 0;
    cursor: pointer;
    border: 1px dashed yellow;
    z-index: 100;
}

.nav-grid-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* Membagi 3 kolom sama rata */
    gap: 8px;                              /* Jarak antar tombol */
    margin-top: 15px;
    width: 100%;
    box-sizing: border-box;
}

.btn-nav {
    height: 50px;           /* Tinggi yang nyaman untuk jempol */
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: bold;
    font-size: 11px;        /* Ukuran teks optimal */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.btn-nav:active {
    transform: scale(0.95);
    opacity: 0.8;
}

</style>

</head>
<body onload="loadInitialData()">

<div id="modal_monitor" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20000; overflow-y:auto; padding:10px;">
    <div style="background:white; border-radius:10px; padding:15px; min-height:100%; position: relative;">
        <button class="btn-close-modal" onclick="document.getElementById('modal_monitor').style.display='none'">Ã—</button>
        
        <h3 style="text-align:center; margin-top:0; color: #2c3e50;">MONITORING POLCEK</h3>

<p id="monitor_date" style="text-align:center; font-size:10px; font-weight:bold; margin-top:-10px; color: #555;"></p>
<button onclick="refreshMonitoringData()" style="background: #27ae60; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">
                ðŸ”„ Sync Data
            </button>
        <p id="monitor_date" style="text-align:center; font-size:12px; font-weight:bold;"></p>
        
        <hr>

        <div id="monitor_content" style="overflow-x:auto;">
             </div>

        <div style="margin-top:20px;">
            <button class="btn-main" style="background:#34495e; width: 100%;" onclick="document.getElementById('modal_monitor').style.display='none'">TUTUP MONITORING</button>
        </div>
    </div>
</div>

<div id="loader"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.75); z-index:9999;
            display:flex; flex-direction:column; justify-content:center; align-items:center;">

  <div class="circle-loader"></div>

  <p style="margin-top:15px; font-size:14px; font-weight:bold; color:#ffffff;">
    Update data master, mohon tunggu...
  </p>
</div>

<div id="modal_antrian" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20000; overflow-y:auto; padding:10px;">
    <div style="background:white; border-radius:10px; padding:15px; min-height:100%; position: relative;">
        <button class="btn-close-modal" onclick="document.getElementById('modal_antrian').style.display='none'">Ã—</button>
        <h3 style="text-align:center; margin-top:0; color: #2c3e50;">ANTRIAN BELUM FINAL</h3>
        <hr>
        <div style="overflow-x:auto;">
            <table border="1" style="width:100%; border-collapse:collapse; font-size:10px; text-align:center;">
                <thead style="background:#eee;">
                    <tr>
                        <th>URPICK</th>
                        <th>TOKO</th>
                        <th>KONT / DOS / MN</th>
                        <th>ACTION</th>
                    </tr>
                </thead>
                <tbody id="antrian_body">
                    </tbody>
            </table>
        </div>
        <button class="btn-main" style="background:#34495e; width: 100%; margin-top: 20px;" onclick="document.getElementById('modal_antrian').style.display='none'">TUTUP</button>
    </div>
</div>

<div id="login_screen">
    <div class="login-box">
        <div style="text-align: center; font-size: 12px; color: #7f8c8d; margin-bottom: 5px; font-family: monospace;">
            V.01.02.26@ mks-bersatu
        </div>
        <h2>LOGIN POLCEK</h2>
        <div class="input-row"><input type="text" id="l_nik" placeholder="NIK" onchange="checkNIK()"></div>
        <div class="input-row"><input type="text" id="l_nama" placeholder="NAMA" readonly></div>
        <div class="input-row"><input type="password" id="l_pass" placeholder="PASSWORD"></div>
        <button class="btn-main" style="background:var(--green); width:100%; margin-top:10px;" onclick="doLogin()">MASUK APLIKASI</button>
<div style="text-align:center; margin-top:15px;">
    <a href="javascript:void(0)" onclick="openResetModal()" style="color: #2980b9; font-size: 13px; text-decoration: none; font-weight: bold;">Update Password?</a>
</div>

    </div>
</div>

<div id="main_app" style="display:none;">
    <div class="header">POLCEK - WH MAKASSAR <br><span style="font-size: 9px; color: yellow;">V.01.02.26@ mks-bersatu</span></div>
    <div class="user-bar"><span>User: <b id="display_user">---</b></span><button class="btn-logout" onclick="doLogout()">LOGOUT</button></div>

<div id="group_header" style="display: block;">
        <div class="input-row"><div class="label">TGL PROSES</div><input type="date" id="p_tgl" onchange="setFocus('p_jenis')"></div>
        <div class="input-row">
            <div class="label" style="background:var(--blue)">JENIS</div>
            <select id="p_jenis" onchange="handleJenisChange()">
                <option value="">-- PILIH JENIS --</option>
                <option value="KONTAINER">KONTAINER</option>
                <option value="DOS">DOS</option>
            <option value="MANUAL">MANUAL</option>
            <option value="TAG I">TAG I</option>
            <option value="NON-LOKASI">NON-LOKASI</option>
            <option value="TELUR">TELUR</option>
            <option value="MKT">MKT</option>
            <option value="ATK GS">ATK GS</option>
            <option value="MATERAI">MATERAI</option>

                </select>
        </div>
        <div class="input-row"><div class="label">KD TOKO</div><input type="text" id="p_kode" placeholder="Scan/Ketik..." onchange="processStoreInput()"></div>
        <div class="input-row"><div class="label">NAMA TOKO</div><input type="text" id="p_nama" readonly></div>
        <div class="input-row"><div class="label">URPICK</div><input type="text" id="p_urpick" readonly></div>
        <div class="input-row"><div class="label">NO FAKTUR</div><select id="p_faktur" onchange="toggleKeScan()"><option value="">-- PILIH FAKTUR --</option></select></div>
    </div>

    <div id="group_scan" style="display:none;">
        <hr style="border: 1px solid #999; margin: 15px 0;">
        <div class="input-row" id="row_scan_label"><div class="label" style="background: var(--orange);">SCAN LABEL</div><input type="text" id="p_scan_label" placeholder="Scan Label..." onchange="validateScanLabel()"></div>
        <div id="area_fisik" style="display:none; border: 2px solid var(--red); padding: 10px; border-radius: 5px; margin-bottom: 8px;">
            <div class="input-row"><div class="label" style="background: var(--red);">SCAN FISIK</div><input type="text" id="p_scan_fisik" placeholder="Scan Barcode Produk..." onchange="validateScanFisik()"></div>
        </div>
        <div class="input-row"><div class="label">PLU</div><input type="text" id="p_plu" readonly></div>
        <div class="input-row"><div class="label">DESCP</div><input type="text" id="p_descp" readonly></div>
        <div class="input-row"><div class="label">ZONA</div><input type="text" id="p_zona" readonly></div>
        <div class="input-row"><div class="label" style="background: #2c3e50;">QTY SCAN</div><input type="number" id="p_qty_input" placeholder="0" readonly></div>
        <input type="hidden" id="p_qty_data">
    </div>

    <div class="nav-grid-container" style="margin-top: 20px;">
        <button class="btn-nav" style="background:#2ecc71" onclick="saveData()">SIMPAN</button>
        <button class="btn-nav" style="background:#8e44ad" onclick="showReport()">FINAL</button>
        <button class="btn-nav" style="background:#34495e" onclick="toggleArea('HEADER')">HEADER</button>
        <button class="btn-nav" style="background:#34495e" onclick="clearAllFields()">CLEAR</button>
        <button class="btn-nav" style="background:#2c3e50; border: 1px solid yellow; color: yellow;" onclick="showMonitoring()">MONITOR</button>
        <button class="btn-nav" style="background:#d35400" onclick="showAntrianModal()">
            ANTRIAN (<span id="badge_small">0</span>)
        </button>
    </div>
    </div>


<div id="modal_report" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20000; overflow-y:auto; padding:10px;">
    <div style="background:white; border-radius:10px; padding:15px; min-height:100%; position: relative;">
        <button class="btn-close-modal" onclick="closeMonitoring()">Ã—</button>
        <h3 id="report_title" style="text-align:center; margin-top:0;">DATA COMPARE</h3>
        <div id="report_info" style="font-size:12px; margin-bottom:10px; border-bottom:1px solid #ccc; padding-bottom:5px;"></div>
        <div id="report_container" style="overflow-x:auto;">
            <table border="1" style="width:100%; border-collapse:collapse; font-size:11px; text-align:center;">
                <thead id="report_head">
                    <tr style="background:#eee;"><th>KONTAINER</th><th>QTY</th><th>POLCEK</th><th>STATUS</th></tr>
                </thead>
                <tbody id="report_body"></tbody>
            </table>
        </div>
        <div id="report_footer" style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-main" style="background:#34495e" onclick="closeMonitoring()">TUTUP</button>
            <button id="btn_finalisasi" class="btn-main" style="background:#27ae60" onclick="prosesFinalisasi()">FINALISASI</button>
        </div>
    </div>
</div>

<div id="modal_reset" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:30000; display:none; justify-content:center; align-items:center; padding:20px;">
    <div style="background:white; border-radius:15px; padding:20px; width:100%; max-width:350px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); position:relative;">
        <h3 style="text-align:center; color: #2c3e50; margin-top:0;">UPDATE PASSWORD</h3>
        <hr style="border:0; border-top:1px solid #eee; margin-bottom:15px;">
        
        <div style="margin-bottom: 12px;">
            <label style="font-size:12px; font-weight:bold; color:#7f8c8d;">NIK :</label>
            <input type="text" id="r_nik" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;" placeholder="Masukkan NIK">
        </div>
        <div style="margin-bottom: 12px;">
            <label style="font-size:12px; font-weight:bold; color:#7f8c8d;">PASSWORD LAMA :</label>
            <input type="password" id="r_pass_lama" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;" placeholder="******">
        </div>
        <div style="margin-bottom: 20px;">
            <label style="font-size:12px; font-weight:bold; color:#7f8c8d;">PASSWORD BARU :</label>
            <input type="password" id="r_pass_baru" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;" placeholder="******">
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="closeResetModal()" style="flex:1; background:#95a5a6; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">BATAL</button>
            <button onclick="processResetPassword()" style="flex:1; background:#2ecc71; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">SIMPAN</button>
        </div>
    </div>
</div>

<script>
history.pushState(null, null, location.href);
window.onpopstate = function() {
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    if (isLoggedIn === "true") {
        // Jika user tekan Back saat login, paksa tetap di halaman ini
        history.pushState(null, null, location.href);
        // Tampilkan peringatan kecil (Toast)
        const Toast = Swal.mixin({
            toast: true,
            position: 'top',
            showConfirmButton: false,
            timer: 2000
        });
        Toast.fire({
            icon: 'warning',
            title: 'Gunakan tombol LOGOUT untuk keluar'
        });
    }
};

// 2. Mencegah browser ditutup atau di-reload tanpa sengaja
window.onbeforeunload = function(e) {
    if (localStorage.getItem("isLoggedIn") === "true") {
        e.preventDefault();
        e.returnValue = ''; // Munculkan dialog konfirmasi browser
    }
};


const G_GITHUB_URL = "https://raw.githubusercontent.com/Monitoring-MKS/Polcek-1/refs/heads/main/database_polcek.json";

const G_URL = "https://script.google.com/macros/s/AKfycbzu8ordKpRTekAdiapIerB7Su63nw2WYhoxBK4C-RxpFmR43skm9fLGSKO-nTH2bGo/exec";

let dbPickAuto = [];
let dbMasterBarcode = [];
let dbManual = [];
let dbSudahPolcek = [];
var currentUser = "";
var CACHED_DATA = null;



async function initApp() {
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    if (isLoggedIn === "true") {
        currentUser = localStorage.getItem("loggedUser");
        document.getElementById('display_user').innerText = currentUser;
        document.getElementById('login_screen').style.display = 'none';
        document.getElementById('main_app').style.display = 'block';
    }

    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'flex';

    console.log("Mencoba mengambil data dari GitHub...");

    try {
        // AMBIL DARI GITHUB (LEBIH CEPAT)
        const res = await fetch(G_GITHUB_URL);
        if (!res.ok) throw new Error("Gagal ambil data GitHub");
        
        const out = await res.json();
        
        // Mapping data dari JSON GitHub
        dbPickAuto = out.pickAuto || [];
        dbMasterBarcode = out.masterBarcode || [];
        dbManual = out.dataManual || [];
        dbSudahPolcek = out.dataSudahPolcek || [];

        // Simpan ke LocalStorage agar bisa offline
        localStorage.setItem("db_pick_auto", JSON.stringify(dbPickAuto));
        localStorage.setItem("db_master_barcode", JSON.stringify(dbMasterBarcode));
        
        console.log("Data GitHub berhasil masuk! Total PickAuto:", dbPickAuto.length);

    } catch (e) {
        console.error("Gagal tarik GitHub, mencoba data lokal...", e);
        // Fallback ke data lokal jika internet/github bermasalah
        dbPickAuto = JSON.parse(localStorage.getItem("db_pick_auto") || "[]");
        dbMasterBarcode = JSON.parse(localStorage.getItem("db_master_barcode") || "[]");
        
        Swal.fire({
            icon: 'warning',
            title: 'Mode Offline',
            text: 'Gagal update data terbaru, menggunakan data lama.',
            timer: 2000
        });
    } finally {
        // MATIKAN LOADING APAPUN YANG TERJADI
        if (loader) loader.style.display = 'none';
        updateBadge();
    }
}

    const usersDB = [
    { nik: "10030732", nama: "URIP PRADIPTA", pass: "234" },
    { nik: "21084962", nama: "BASYUDIN KADRI", pass: "234" },
    { nik: "22116378", nama: "IRWAN", pass: "234" },
    { nik: "06081095", nama: "AHMAD DJAINUDIN", pass: "234" },
    { nik: "13023500", nama: "AAN SUBHAN", pass: "234" },
    { nik: "06080176", nama: "RUDIYANTO", pass: "234" },
    { nik: "12124371", nama: "ARFA", pass: "234" },
    { nik: "15044455", nama: "ABD KADIR", pass: "234" },
    { nik: "06040353", nama: "YUSUP", pass: "234" },
    { nik: "13104668", nama: "DENADA", pass: "234" },
    { nik: "15093836", nama: "WAHYU DARUS RAMADHAN", pass: "234" },
    { nik: "11126379", nama: "ABDUL WARIS", pass: "234" },
    { nik: "15034964", nama: "SYARIF", pass: "234" },
    { nik: "15042057", nama: "FAJAR ABU THALIB", pass: "234" },
    { nik: "15042969", nama: "JUMAING", pass: "234" },
    { nik: "15052579", nama: "FIRMAN", pass: "234" },
    { nik: "15117277", nama: "ASRIADI", pass: "234" },
    { nik: "16016211", nama: "AKBAR T", pass: "234" },
    { nik: "10093059", nama: "MUSLIMIN", pass: "234" },
    { nik: "15033310", nama: "RAMLI S", pass: "234" },
    { nik: "12068137", nama: "SUWANDI", pass: "234" },
    { nik: "12067459", nama: "PATAHUDDIN", pass: "234" },
    { nik: "15112754", nama: "MUH ARHAM YUBDAL", pass: "234" },
    { nik: "13052840", nama: "JAFAR", pass: "234" },
    { nik: "20015892", nama: "ASRAN. A", pass: "234" },
    { nik: "12092687", nama: "MAULANA YUSUP", pass: "234" },
    { nik: "04060256", nama: "ABDULAH K. MUTOHAR", pass: "234" },
    { nik: "18077047", nama: "GENIAL FADILAT ARASY", pass: "234" },
    { nik: "18124171", nama: "HASTOMO", pass: "234" },
    { nik: "19015561", nama: "ADETIANI KURNIYA PRAT", pass: "234" },
    { nik: "21055244", nama: "ELOY REMBON", pass: "234" },
    { nik: "21104196", nama: "ALHANNAS", pass: "234" },
    { nik: "13013523", nama: "ANDI AHMAD", pass: "234" },
    { nik: "13013538", nama: "NASRUN B", pass: "234" },
    { nik: "19088924", nama: "IBNU MUNSIR", pass: "234" },
    { nik: "19088919", nama: "MUH SABIR", pass: "234" },
    { nik: "11022706", nama: "MUH SIGIT A", pass: "234" },
    { nik: "22016350", nama: "IRWANSYAH", pass: "234" },
    { nik: "19103817", nama: "AMRI ADI", pass: "234" },
    { nik: "19103821", nama: "JOKO DWI ASTRAWAN", pass: "234" },
    { nik: "13023392", nama: "MUH ZAENAL", pass: "234" },
    { nik: "20032629", nama: "RAHMAT ZULKIFLI", pass: "234" },
    { nik: "20042761", nama: "AGUNG RAHMAT", pass: "234" },
    { nik: "21021951", nama: "NUR ANDIKA", pass: "234" },
    { nik: "20123889", nama: "SADDAM HUSAIN", pass: "234" },
    { nik: "22067161", nama: "ABD RAHMAN", pass: "234" },
    { nik: "21041579", nama: "MUHAMMAD RIJAL", pass: "234" },
    { nik: "13063625", nama: "MOCH. NURCAHYO Y.", pass: "234" },
    { nik: "21082748", nama: "NASRULLAH", pass: "234" },
    { nik: "13071183", nama: "HAKIM", pass: "234" },
    { nik: "13074665", nama: "ABDUL KHAIR", pass: "234" },
    { nik: "07060205", nama: "YUSUP ISKANDAR", pass: "234" },
    { nik: "11084748", nama: "MUH.HAEDIR", pass: "234" },
    { nik: "11085162", nama: "NUR AMAL", pass: "234" },
    { nik: "14032387", nama: "MUHAMAD FURQON", pass: "234" },
    { nik: "11095305", nama: "AHMAD", pass: "234" },
    { nik: "09040248", nama: "DICKI ISKANDAR ZULKAR", pass: "234" },
    { nik: "11095472", nama: "SYARIFUDDIN", pass: "234" },
    { nik: "14066101", nama: "MUH NUR", pass: "234" },
    { nik: "11124107", nama: "MUHAMMAD AMIR", pass: "234" },
    { nik: "12015655", nama: "AHMAD JUNAEDI", pass: "234" },
    { nik: "12021938", nama: "ALI NURHIDIN", pass: "234" },
    { nik: "01020239", nama: "ASBAR", pass: "234" },
    { nik: "19106316", nama: "TAUFIK HIDAYAT AMIN", pass: "234" },
    { nik: "14022759", nama: "MUHIDDIN", pass: "234" },
    { nik: "21091494", nama: "ARLAN", pass: "234" },
    { nik: "18012062", nama: "M. MIFTAHUL MUNIF", pass: "234" },
    { nik: "19032172", nama: "SUPRIADI", pass: "234" },
    { nik: "19085644", nama: "ABDUL JALIL", pass: "234" },
    { nik: "21126790", nama: "HAERUL", pass: "234" },
    { nik: "20121101", nama: "AHMAD TAUFIQ. L", pass: "234" },
    { nik: "20121097", nama: "MUH. ALIF FAJRING", pass: "234" },
    { nik: "11084798", nama: "RIZKI", pass: "234" },
    { nik: "03030112", nama: "IRWAN", pass: "234" },
    { nik: "01060319", nama: "BASUKI", pass: "234" },
    { nik: "10062381", nama: "REZKA SURYANTO", pass: "234" },
    { nik: "08081171", nama: "LINGGA OKTA", pass: "234" },
    { nik: "23120912", nama: "HAMKA", pass: "234" },
    { nik: "20085631", nama: "ABU BAKAR", pass: "234" },
    { nik: "23072735", nama: "FIRMAN", pass: "234" },
    { nik: "21045428", nama: "RISAL", pass: "234" },

];

async function loadInitialData() {
    // 1. Munculkan Loader (Pastikan ID-nya sesuai dengan di HTML Anda)
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'flex';

    console.log("Memulai penarikan data dari GitHub...");

try {
        const res = await fetch(G_GITHUB_URL);
        if (!res.ok) throw new Error("Gagal ambil data GitHub");
        
        const out = await res.json();
        
        dbPickAuto = out.pickAuto || [];
        dbMasterBarcode = out.masterBarcode || [];
        dbManual = out.dataManual || [];
        dbSudahPolcek = out.dataSudahPolcek || [];

        // ðŸ”¥ HAPUS ATAU KOMENTARI BARIS DI BAWAH INI:
        // localStorage.setItem("db_pick_auto", JSON.stringify(dbPickAuto));
        // localStorage.setItem("db_master_barcode", JSON.stringify(dbMasterBarcode));
        
        console.log("Data GitHub berhasil dimuat ke RAM!");

    } catch (e) {
        console.error("Gagal tarik GitHub", e);
        // Jika gagal, biarkan variabel kosong atau ambil dari cache RAM jika ada
        Swal.fire({
            icon: 'warning',
            title: 'Koneksi Bermasalah',
            text: 'Gagal update data terbaru dari GitHub.',
            timer: 2000
        });
    } finally {
        if (loader) loader.style.display = 'none';        
        if (typeof updateBadge === "function") updateBadge();
        
        console.log("Proses loading selesai.");
    }
}
    // ==========================================
    // AUTHENTICATION FUNCTIONS
    // ==========================================
    function checkNIK() {
        const nikInput = document.getElementById('l_nik').value;
        const user = usersDB.find(u => u.nik === nikInput);
        if (user) {
            document.getElementById('l_nama').value = user.nama;
            setFocus('l_pass');
        } else {
            document.getElementById('l_nama').value = "";
            Swal.fire("Error", "NIK Tidak Terdaftar!", "error");
        }
    }

function doLogin() {
    const nik = document.getElementById('l_nik').value;
    const pass = document.getElementById('l_pass').value;
    const user = usersDB.find(u => u.nik === nik && u.pass === pass);
    
    if (user) {
        aktifkanFullScreen();
        
        // --- PENYESUAIAN DI SINI ---
        localStorage.setItem("isLoggedIn", "true");
        localStorage.setItem("activeUser", user.nama); // Disamakan agar saveData bisa baca
        currentUser = user.nama; // Update variabel global di memori
        // ---------------------------
        
        document.getElementById('login_screen').style.display = 'none';
        document.getElementById('main_app').style.display = 'block';
        document.getElementById('display_user').innerText = user.nama;
        
        history.pushState(null, null, location.href);
        loadInitialData(); 
    } else {
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'none';

        Swal.fire({ 
            title: "Gagal", 
            text: "Kombinasi NIK dan Password Salah", 
            icon: "error",
            confirmButtonColor: '#c0392b',
            didOpen: () => {
                Swal.getContainer().style.zIndex = "100000";
            }
        });
    }
}
function aktifkanFullScreen() {
    let doc = window.document;
    let docEl = doc.documentElement;

    let requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
    
    if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
        requestFullScreen.call(docEl);
    }
}

    function doLogout() {
    Swal.fire({
        title: "Logout?",
        text: "Anda akan keluar dari sesi kerja ini.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        confirmButtonText: "Ya, Keluar"
    }).then((result) => {
        if (result.isConfirmed) {
            // Hapus semua kunci login
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("loggedUser");
            
            // Kembalikan tampilan
            document.getElementById('main_app').style.display = 'none';
            document.getElementById('login_screen').style.display = 'block';
            
            // Opsional: Bersihkan form login
            document.getElementById('l_nik').value = "";
            document.getElementById('l_pass').value = "";
            document.getElementById('l_nama').value = "";
        }
    });
}

function handleJenisChange() {
    const jenis = document.getElementById('p_jenis').value;
    const kelompokNonScan = ["NON-LOKASI", "TELUR", "MKT", "ATK GS", "MATERAI"];
    const areaFisik = document.getElementById('area_fisik');
    const rowScanLabel = document.getElementById('row_scan_label');
    const qtyInp = document.getElementById('p_qty_input');
    
    // Poin 1: Sembunyikan Area Fisik jika bukan DOS/MANUAL
    areaFisik.style.display = (jenis === "DOS" || jenis === "MANUAL") ? 'block' : 'none';
    
    // Kontainer & Tag I hanya butuh Label, Non-Scan tidak butuh keduanya
    if (kelompokNonScan.includes(jenis)) {
        if(rowScanLabel) rowScanLabel.style.display = 'none';
        qtyInp.readOnly = false;
        qtyInp.style.background = "white";
    } else {
        if(rowScanLabel) rowScanLabel.style.display = 'flex';
        qtyInp.readOnly = true;
        qtyInp.style.background = "#eeeeee";
    }

    // Reset fields (Sesuai kode asli Anda)
    const idsToClear = ['p_kode', 'p_nama', 'p_urpick', 'p_scan_label', 'p_scan_fisik', 'p_plu', 'p_descp', 'p_zona', 'p_qty_input', 'p_qty_data'];
    idsToClear.forEach(id => { if (document.getElementById(id)) document.getElementById(id).value = ""; });
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
    
    if (jenis !== "") setFocus('p_kode');
}

// Poin 2: Alur Fokus Faktur ke Qty (Untuk Non-Scan)
function toggleKeScan() {
    const jenis = document.getElementById('p_jenis').value;
    const faktur = document.getElementById('p_faktur').value;
    const kelompokNonScan = ["NON-LOKASI", "TELUR", "MKT", "ATK GS", "MATERAI"];
    
    if (!faktur) return;

    // Poin 3: Hide Header (Grup Header hilang saat mulai scan)
    document.getElementById('group_header').style.display = 'none';
    document.getElementById('group_scan').style.display = 'block';

    if (kelompokNonScan.includes(jenis)) {
        // Langsung ke Qty untuk Non-Scan
        setTimeout(() => { document.getElementById('p_qty_input').focus(); }, 300);
    } else if (jenis === "DOS" || jenis === "MANUAL") {
        // Ke Fisik untuk DOS/MANUAL
        setTimeout(() => { document.getElementById('p_scan_fisik').focus(); }, 300);
    } else {
        // Sisanya (Kontainer/Tag I) ke Label
        setTimeout(() => { document.getElementById('p_scan_label').focus(); }, 300);
    }
}

    function runFilter() {
    const tglRaw = document.getElementById('p_tgl').value;
    const jenis = document.getElementById('p_jenis').value;
    const kode = document.getElementById('p_kode').value.trim().toUpperCase();
    const fSelect = document.getElementById('p_faktur');
    
    if (!tglRaw || !kode || !jenis) return false;

    // Format tanggal untuk pencarian
    const d = new Date(tglRaw);
    const tglCheck = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
    
    // Pilih database berdasarkan jenis
    const currentDB = (jenis === "MANUAL") ? dbManual : dbPickAuto;

    // Cari data yang cocok
    const filtered = currentDB.filter(item => {
        return item.tglInput === tglCheck && item.kodeToko === kode;
    });

    if (filtered.length > 0) {
        // Isi Nama Toko dan Urpick secara otomatis
        document.getElementById('p_nama').value = filtered[0].namaToko;
        document.getElementById('p_urpick').value = filtered[0].urpick;

        // Isi Dropdown Faktur
        fSelect.innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
        const uniqueFakturs = [...new Set(filtered.map(i => i.faktur))];
        uniqueFakturs.forEach(f => { 
            fSelect.innerHTML += `<option value="${f}">${f}</option>`; 
        });
        
        return true; // Data ditemukan
    } else {
        // Reset jika tidak ketemu
        document.getElementById('p_nama').value = "";
        document.getElementById('p_urpick').value = "";
        fSelect.innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
        return false; // Data tidak ditemukan
    }
}

function hitungTotalTerScan(plu, faktur) {
    let total = 0;

    // 1. Cek di Database yang sudah terkirim (hasil sinkronisasi server)
    // Pastikan variabel dbSudahPolcek ada di aplikasi Anda
    if (typeof dbSudahPolcek !== 'undefined' && dbSudahPolcek.length > 0) {
        dbSudahPolcek.forEach(d => {
            if (String(d.plu).trim() === String(plu).trim() && d.faktur === faktur) {
                total += parseInt(d.qty_scan || 0);
            }
        });
    }

    // 2. Cek di Antrian Lokal (LocalStorage) yang belum di-finalisasi
    let antrian = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    antrian.forEach(a => {
        if (String(a.plu).trim() === String(plu).trim() && a.faktur === faktur) {
            total += parseInt(a.qty_scan || 0);
        }
    });

    return total;
}

function validateScanFisik() {
Â  Â  const scanFisik = document.getElementById('p_scan_fisik').value.trim();
Â  Â  const pluAktif = document.getElementById('p_plu').value;
Â  Â  const labelAktif = document.getElementById('p_scan_label').value;
Â  Â  const qtyInp = document.getElementById('p_qty_input');
Â  Â  const qtyTarget = parseInt(document.getElementById('p_qty_data').value || 0);
Â  Â  const fakturVal = document.getElementById('p_faktur').value;
Â  Â  const kodeToko = document.getElementById('p_kode').value.toUpperCase();
Â  Â  const jenisVal = document.getElementById('p_jenis').value;

Â  Â  if (!scanFisik) return;

Â  Â  // KONDISI A: TAMBAH QTY (Jika data sudah tampil)
Â  Â  if (pluAktif && pluAktif !== "-" && labelAktif !== "") {
Â  Â  Â  Â  const matchLanjutan = dbMasterBarcode.find(m =>Â 
Â  Â  Â  Â  Â  Â  (scanFisik === String(m.barcodeDos).trim() || scanFisik === String(m.barcodeItem).trim())Â 
Â  Â  Â  Â  Â  Â  && String(m.plu).trim() === String(pluAktif).trim()
Â  Â  Â  Â  );

Â  Â  Â  Â  if (matchLanjutan) {
Â  Â  Â  Â  Â  Â  // HITUNG AKUMULASI (Server + Antrian Lokal)
Â  Â  Â  Â  Â  Â  let sudahAda = hitungTotalTerScan(pluAktif, fakturVal);Â 
Â  Â  Â  Â  Â  Â  let sedangInput = parseInt(qtyInp.value) || 0;

Â  Â  Â  Â  Â  Â  // VALIDASI OVER QTY (Termasuk cek server)
Â  Â  Â  Â  Â  Â  if ((sudahAda + sedangInput) >= qtyTarget) {
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof playError === "function") playError();
Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon: "error",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: "OVER QTY / SUDAH FINAL!",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: `Target: ${qtyTarget}\nSudah Scan: ${sudahAda + sedangInput}`
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_fisik').value = "";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  qtyInp.value = sedangInput + 1;
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_fisik').value = "";
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_fisik').focus();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if (typeof playError === "function") playError();
Â  Â  Â  Â  Â  Â  Swal.fire("BARANG BERBEDA", "PLU fisik tidak sama dengan data di layar!", "warning");
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_fisik').value = "";
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // KONDISI B: SCAN PERTAMA (Ambil Data PLU ke Layar)
Â  Â  const matchMB = dbMasterBarcode.find(m =>Â 
Â  Â  Â  Â  scanFisik === String(m.barcodeDos).trim() || scanFisik === String(m.barcodeItem).trim()
Â  Â  );

Â  Â  if (matchMB) {
Â  Â  Â  Â  const foundPLU = String(matchMB.plu).trim();
Â  Â  Â  Â  let matchPicking;

Â  Â  Â  Â  if (jenisVal === "DOS") {
Â  Â  Â  Â  Â  Â  matchPicking = dbPickAuto.find(i => i.faktur === fakturVal && i.kodeToko === kodeToko && String(i.plu) === foundPLU);
Â  Â  Â  Â  } else if (jenisVal === "MANUAL") {
Â  Â  Â  Â  Â  Â  matchPicking = dbManual.find(i => i.faktur === fakturVal && String(i.plu) === foundPLU);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (matchPicking) {
Â  Â  Â  Â  Â  Â  // CEK APAKAH SUDAH TERPENUHI SEBELUM FILL DATA
Â  Â  Â  Â  Â  Â  let sudahTerpenuhi = hitungTotalTerScan(foundPLU, fakturVal);
Â  Â  Â  Â  Â  Â  // Ambil target qty asli dari picking
Â  Â  Â  Â  Â  Â  let targetAsli = parseInt(matchPicking.qtyData || 0);

Â  Â  Â  Â  Â  Â  if (sudahTerpenuhi >= targetAsli) {
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof playError === "function") playError();
Â  Â  Â  Â  Â  Â  Â  Â  Swal.fire("SUDAH LENGKAP", `PLU ${foundPLU} sudah discan sebanyak ${sudahTerpenuhi} dari target ${targetAsli}.`, "info");
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_fisik').value = "";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  fillData(matchPicking);Â 
Â  Â  Â  Â  Â  Â  qtyInp.value = 0;Â 
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_fisik').value = "";
Â  Â  Â  Â  Â  Â  setTimeout(() => { document.getElementById('p_scan_label').focus(); }, 300);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if (typeof playError === "function") playError();
Â  Â  Â  Â  Â  Â  notify(` PLU ${foundPLU} Tidak Ada di Faktur Ini!`, "error", "p_scan_fisik");
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_fisik').value = "";
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  if (typeof playError === "function") playError();
Â  Â  Â  Â  notify(" BARCODE TIDAK TERDAFTAR!", "error", "p_scan_fisik");
Â  Â  Â  Â  document.getElementById('p_scan_fisik').value = "";
Â  Â  }
}

function validateScanLabel() {
Â  Â  let rawScanVal = document.getElementById('p_scan_label').value;
Â  Â  const scanVal = rawScanVal.replace(/\s+/g, '').toUpperCase().trim();
Â  Â  document.getElementById('p_scan_label').value = scanVal;

Â  Â  const jenisVal = document.getElementById('p_jenis').value;
Â  Â  const kodeToko = document.getElementById('p_kode').value.toUpperCase();
Â  Â  const fakturVal = document.getElementById('p_faktur').value;
Â  Â  const pluAktif = String(document.getElementById('p_plu').value).trim();

Â  Â  if (!scanVal) return;

Â  Â  if (jenisVal === "DOS" || jenisVal === "MANUAL") {
Â  Â  Â  Â  if (!pluAktif || pluAktif === "-") {
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_label').value = "";
Â  Â  Â  Â  Â  Â  return Swal.fire("Urutan Salah", "Scan Barcode FISIK barang dulu!", "warning");
Â  Â  Â  Â  }

Â  Â  Â  Â  const parts = scanVal.split('-').filter(Boolean);
Â  Â  Â  Â  let pluLabel = (jenisVal === "DOS") ? parts[3] : parts[2];
Â  Â  Â  Â  let tokoLabel = (jenisVal === "DOS") ? (parts[2] || "").toUpperCase() : kodeToko;

Â  Â  Â  Â  if (jenisVal === "DOS" && tokoLabel !== kodeToko) {
Â  Â  Â  Â  Â  Â  if (typeof playError === "function") playError();
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_label').value = "";
Â  Â  Â  Â  Â  Â  return Swal.fire("SALAH TOKO", `Label: ${tokoLabel}, Aktif: ${kodeToko}`, "error");
Â  Â  Â  Â  }

Â  Â  Â  Â  if (String(pluLabel) === pluAktif) {
Â  Â  Â  Â  Â  Â  document.getElementById('p_qty_input').value = 1;
Â  Â  Â  Â  Â  Â  setTimeout(() => { document.getElementById('p_scan_fisik').focus(); }, 100);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if (typeof playError === "function") playError();
Â  Â  Â  Â  Â  Â  Swal.fire("PLU TIDAK COCOK", `Label: ${pluLabel} | Fisik: ${pluAktif}`, "error");
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_label').value = "";
Â  Â  Â  Â  }

Â  Â  } else if (jenisVal === "KONTAINER") {
Â  Â  Â  Â  const parts = scanVal.split('-').filter(Boolean);
Â  Â  Â  Â  const noKontainerLabel = parts[0] ? parts[0].toUpperCase() : "";
Â  Â  Â  Â  const kodeTokoLabel = parts[1] ? parts[1].toUpperCase() : "";

Â  Â  Â  Â  if (kodeTokoLabel !== kodeToko) {
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_label').value = "";
Â  Â  Â  Â  Â  Â  if (typeof playError === "function") playError();Â 
Â  Â  Â  Â  Â  Â  return Swal.fire({ icon: 'error', title: 'SALAH TOKO!', text: `Label Toko ${kodeTokoLabel}, Aktif Toko ${kodeToko}` });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- VALIDASI ANTI-DOUBLE KONTAINER (ANTRIAN + SERVER) ---
Â  Â  Â  Â  let antrian = JSON.parse(localStorage.getItem('q_polcek') || "[]");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. Cek Antrian Lokal
Â  Â  Â  Â  const diAntrian = antrian.find(item => item.faktur === fakturVal && item.kode === kodeToko && item.barcode.toUpperCase().includes(noKontainerLabel));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. Cek Database Server (dbSudahPolcek)
Â  Â  Â  Â  const diServer = dbSudahPolcek.find(item => item.faktur === fakturVal && item.kode === kodeToko && item.barcode.toUpperCase().includes(noKontainerLabel));

Â  Â  Â  Â  if (diAntrian || diServer) {
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_label').value = "";
Â  Â  Â  Â  Â  Â  if (typeof playError === "function") playError();
Â  Â  Â  Â  Â  Â  return Swal.fire({ icon: 'warning', title: 'SUDAH SCAN!', text: `Kontainer ${noKontainerLabel} sudah pernah discan/dikirim.` });
Â  Â  Â  Â  }

Â  Â  Â  Â  const match = dbPickAuto.find(i => i.faktur === fakturVal && i.kodeToko === kodeToko && (i.kontainer || "").toUpperCase() === noKontainerLabel);

Â  Â  Â  Â  if (match) {Â 
Â  Â  Â  Â  Â  Â  fillData(match);Â 
Â  Â  Â  Â  Â  Â  document.getElementById('p_qty_input').value = 1;Â 
Â  Â  Â  Â  Â  Â  document.getElementById('p_qty_input').readOnly = true;
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_label').value = scanVal.toUpperCase();
Â  Â  Â  Â  Â  Â  setTimeout(() => { saveData(); }, 300);
Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  if (typeof playError === "function") playError();
Â  Â  Â  Â  Â  Â  notify(" NO KONTAINER TIDAK ADA DI DATA!", "error", "p_scan_label");Â 
Â  Â  Â  Â  Â  Â  document.getElementById('p_scan_label').value = "";Â 
Â  Â  Â  Â  }
Â  Â Â 


Â  Â  // --- ALUR C: UNTUK TAG I ---
Â  Â  } else if (jenisVal === "TAG I") {
Â  Â  Â  Â  document.getElementById('p_plu').value = "TAG-I";
Â  Â  Â  Â  document.getElementById('p_qty_input').value = 1;
Â  Â  Â  Â  document.getElementById('p_qty_input').readOnly = false;
Â  Â  Â  Â  setFocus('p_qty_input');
Â  Â  }
}


// --- 3. FUNGSI FILL DATA ---
function fillData(m) {
    const jenis = document.getElementById('p_jenis').value;
    const faktur = document.getElementById('p_faktur').value;
    const kodeToko = document.getElementById('p_kode').value.toUpperCase();
    
    document.getElementById('p_plu').value = m.plu || "-";
    document.getElementById('p_descp').value = m.descp || "-";
    document.getElementById('p_zona').value = m.zona || "-";
    
    let totalTargetToko = 0;

    if (jenis === "KONTAINER") {
        totalTargetToko = 1; // Kontainer selalu 1
    } else {
        const currentDB = (jenis === "MANUAL") ? dbManual : dbPickAuto;
        // Cari di database asli untuk PLU ini di faktur & toko ini
        currentDB.forEach(item => { 
            if (String(item.faktur) === String(faktur) && 
                String(item.kodeToko) === String(kodeToko) && 
                String(item.plu) === String(m.plu)) {
                totalTargetToko += parseInt(item.qtyData || 0); 
            }
        });
    }
    
    document.getElementById('p_qty_data').value = totalTargetToko;
    document.getElementById('area_fisik').style.display = 'block';
}

// --- 4. FUNGSI SAVE DATA (BERSIHKAN SEMUA) ---
async function saveData() {
const petugasAktif = currentUser || localStorage.getItem('activeUser') || "Tanpa Nama";
    const qtyInp = document.getElementById('p_qty_input');
    const jenis = document.getElementById('p_jenis').value;
    const kodeToko = document.getElementById('p_kode').value.toUpperCase();
    const fakturVal = document.getElementById('p_faktur').value;
    
    if (!qtyInp.value || qtyInp.value <= 0) return notify("Isi Qty!", "error", "p_qty_input");

    const kelompokNonScan = ["NON-LOKASI","TELUR", "MKT", "ATK GS", "MATERAI"];
   updateBadge(); 
    // Jika masuk kelompok NON-SCAN, langsung kirim ke server (Point 9)
    if (kelompokNonScan.includes(jenis)) {
        const dataLangsung = [{
            tgl: document.getElementById('p_tgl').value,
            jenis: jenis,
            kode: kodeToko,
            nama: document.getElementById('p_nama').value,
            urpick: document.getElementById('p_urpick').value,
            faktur: fakturVal,
            zona: document.getElementById('p_zona').value || "-",
            barcode: "NON-SCAN",
            plu: document.getElementById('p_plu').value || "MANUAL",
            descp: document.getElementById('p_descp').value || "-",
            qty_data: 0,
            qty_scan: parseInt(qtyInp.value),
            keterangan: "",            
            petugas: petugasAktif
        }];

        await kirimDataLangsung(dataLangsung);
    } else {
        // Alur Biasa (DOS, MANUAL, KONTAINER) simpan ke LocalStorage dulu
        let q = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        q.push({
            tgl: document.getElementById('p_tgl').value,
            jenis: jenis,
            kode: kodeToko,
            nama: document.getElementById('p_nama').value,
            urpick: document.getElementById('p_urpick').value,
            faktur: fakturVal,
            zona: document.getElementById('p_zona').value,
            barcode: document.getElementById('p_scan_label').value,
            plu: document.getElementById('p_plu').value,
            descp: document.getElementById('p_descp').value,
            qty_data: parseInt(document.getElementById('p_qty_data').value || 0),
            qty_scan: parseInt(qtyInp.value),
	    keterangan: "",            
	    petugas: petugasAktif
        });
localStorage.setItem('q_polcek', JSON.stringify(q));
        updateBadge();

        // --- TAMBAHKAN PROSES RESET DI SINI ---
        const toReset = ['p_scan_label', 'p_scan_fisik', 'p_plu', 'p_descp', 'p_zona', 'p_qty_input', 'p_qty_data'];
        toReset.forEach(id => { 
            if(document.getElementById(id)) document.getElementById(id).value = ""; 
        });

        // Jalankan fungsi fokus dan pastikan area fisik tetap muncul
        afterSaveFocus(jenis); 
    }
}

async function kirimDataLangsung(data) {
    const loader = document.getElementById('loader');
    loader.style.display = 'flex'; 
    
    try {
        const res = await fetch(G_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: "syncBatch", data: data }) 
        });
        const out = await res.json();
        
        loader.style.display = 'none'; 
        
        if (out.status === "success") {
            // Update data monitoring di RAM agar langsung muncul di tabel tanpa reload
            data.forEach(d => dbSudahPolcek.push(d)); 
            
            await Swal.fire({
                icon: 'success',
                title: 'Berhasil',
                text: 'Data Non-Scan Terkirim!',
                timer: 1500 // Pop up hilang otomatis agar cepat
            });
            clearAllFieldsInternal(); 
        }
    } catch (e) {
        loader.style.display = 'none';
        Swal.fire("Gagal", "Cek Koneksi Server", "error");
    }
}

function afterSaveFocus(jenis) {
    const kelompokNonScan = ["NON-LOKASI", "TELUR", "MKT", "ATK GS", "MATERAI"];

    // 1. Reset field input
    ['p_scan_label', 'p_scan_fisik', 'p_plu', 'p_descp', 'p_zona', 'p_qty_input', 'p_qty_data'].forEach(id => {
        if (document.getElementById(id)) document.getElementById(id).value = "";
    });

    const qtyInp = document.getElementById('p_qty_input');
    const areaFisik = document.getElementById('area_fisik');

    // 2. Logika Berdasarkan Jenis
    if (kelompokNonScan.includes(jenis)) {
        // KHUSUS NON-SCAN: Sembunyikan area fisik & reset dropdown
        if (areaFisik) areaFisik.style.display = 'none';
        document.getElementById('p_jenis').value = "";
        setFocus('p_jenis');
        
    } else if (jenis === "DOS" || jenis === "MANUAL") {
        // KHUSUS DOS/MANUAL: Pastikan area fisik MUNCUL & fokus ke SCAN FISIK
        if (areaFisik) areaFisik.style.display = 'block';
        qtyInp.readOnly = true;
        qtyInp.style.background = "#eeeeee";
        
        setTimeout(() => {
            const inpFisik = document.getElementById('p_scan_fisik');
            if (inpFisik) inpFisik.focus();
        }, 300);

    } else {
        // UNTUK KONTAINER / TAG I: Sembunyikan fisik & fokus ke SCAN LABEL
        if (areaFisik) areaFisik.style.display = 'none';
        qtyInp.readOnly = (jenis === "KONTAINER"); // Kontainer terkunci, TAG I mungkin tidak
        
        setTimeout(() => {
            const inpLabel = document.getElementById('p_scan_label');
            if (inpLabel) inpLabel.focus();
        }, 300);
    }
}

async function prosesFinalisasi() {
    const jenisAktif = document.getElementById('p_jenis').value;
    const fakturAktif = document.getElementById('p_faktur').value;
    const kodeAktif = document.getElementById('p_kode').value;

    document.getElementById('modal_report').style.display = 'none';

    // Konfirmasi sebelum kirim
    const { isConfirmed } = await Swal.fire({ 
        title: 'Kirim Data?', 
        text: "Data akan langsung terkirim ke GSheet",
        icon: 'question', 
        showCancelButton: true,
        confirmButtonText: 'Ya, Kirim!',
        cancelButtonText: 'Cek Lagi'
    });

    if (isConfirmed) {
        const loader = document.getElementById('loader');
        loader.style.display = 'flex'; 

        try {
            // 1. Ambil data dari antrean lokal
            let allLocalData = JSON.parse(localStorage.getItem('q_polcek') || "[]");
            const dataToSend = allLocalData.filter(i => i.jenis === jenisAktif && i.faktur === fakturAktif && i.kode === kodeAktif);

            // 2. Kirim ke G_URL (Google Apps Script)
            const res = await fetch(G_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "syncBatch", data: dataToSend }) 
            });
            const out = await res.json();
            
            loader.style.display = 'none'; 

            if (out.status === "success") {
                // 3. Hapus data yang sudah terkirim dari antrean LocalStorage
                const sisaData = allLocalData.filter(i => !(i.jenis === jenisAktif && i.faktur === fakturAktif && i.kode === kodeAktif));
                localStorage.setItem('q_polcek', JSON.stringify(sisaData));
                
                // 4. UPDATE MONITORING LOKAL (Agar langsung centang hijau âœ… di HP petugas)
                dataToSend.forEach(d => dbSudahPolcek.push(d)); 
                
                updateBadge(); // Update angka antrean di UI

                // 5. TOAST SUCCESS (Cepat & Tanpa Jeda)
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true
                });
                
                Toast.fire({
                    icon: 'success',
                    title: 'Data Terkirim ke GSheet'
                });

                // 6. Reset Form untuk faktur berikutnya
                clearAllFieldsInternal(); 
                
            } else {
                throw new Error(out.message);
            }

        } catch (e) { 
            loader.style.display = 'none';
            Swal.fire("Gagal Kirim", "Koneksi bermasalah. Data tetap aman di antrean HP.", "error"); 
            document.getElementById('modal_report').style.display = 'block';
        }
    } else {
        document.getElementById('modal_report').style.display = 'block';
    }
}

function clearAllFieldsInternal() {
    // Kosongkan Jenis (kembali ke --PILIH JENIS--)
    document.getElementById('p_jenis').value = "";
    // Kosongkan semua field input
    const ids = ['p_kode','p_nama','p_urpick','p_faktur','p_scan_label','p_scan_fisik','p_plu','p_descp','p_zona','p_qty_input','p_qty_data'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            if(el.tagName === "SELECT") el.innerHTML = '<option value="">-- PILIH --</option>';
            else el.value = "";
        }
    });
    // Fokus ke Jenis sesuai permintaan point 9
    setFocus('p_jenis');
}

    // ==========================================
    // UI HELPER & MONITORING
    // ==========================================
    function setFocus(id) {
        setTimeout(() => {
            const el = document.getElementById(id);
            if (el) { el.focus(); if (typeof el.select === 'function') el.select(); }
        }, 350);
    }

    function notify(msg, type = 'success', nextId = 'p_scan_label') {
        Swal.fire({ title: msg, icon: type, timer: 1500, showConfirmButton: false, didClose: () => { setFocus(nextId); }});
    }

    function updateBadge() {
    try {
        const scanDB = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        const badgeEl = document.getElementById('badge');
        if (badgeEl) {
            badgeEl.innerText = scanDB.length;
        }
    } catch (e) {
        console.error("Gagal update badge", e);
    }
}

    function focusToNext() {
        resetScanField();
        const jenis = document.getElementById('p_jenis').value;
        if (["KONTAINER", "DOS", "MANUAL", "TAG I"].includes(jenis)) {
            setFocus('p_scan_label');
        } else {
            const qtyInp = document.getElementById('p_qty_input');
            qtyInp.readOnly = false; qtyInp.style.background = "white";
            document.getElementById('p_scan_label').value = "NON-SCAN";
            setFocus('p_qty_input');
        }
    }

    function clearAllFields() {
    // 1. Kosongkan semua ID input
    const idsToClear = [
        'p_kode', 'p_nama', 'p_urpick', 
        'p_scan_label', 'p_scan_fisik', 'p_plu', 
        'p_descp', 'p_zona', 'p_qty_input', 'p_qty_data'
    ];

    updateBadge();
    idsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
    });

    // 2. Reset Pilihan Dropdown
    const pJenis = document.getElementById('p_jenis');
    if (pJenis) pJenis.value = ""; 

    const pFaktur = document.getElementById('p_faktur');
    if (pFaktur) pFaktur.innerHTML = '<option value="">-- PILIH FAKTUR --</option>';

    // 3. Sembunyikan Area Fisik
    const areaFisik = document.getElementById('area_fisik');
    if (areaFisik) areaFisik.style.display = 'none';

    // 4. PINDAH LAYAR: Tampilkan Header, Sembunyikan Scan
    document.getElementById('group_header').style.display = 'block';
    document.getElementById('group_scan').style.display = 'none';

    // 5. FOKUS KURSOR KEMBALI KE JENIS
    setTimeout(() => {
        const inputJenis = document.getElementById('p_jenis');
        if (inputJenis) inputJenis.focus();
    }, 200);

    console.log("Form dibersihkan, kembali ke pemilihan Jenis.");
}

async function showMonitoring() {
    const tglRaw = document.getElementById('p_tgl').value;
    if (!tglRaw) {
        Swal.fire("Pilih Tanggal", "Tentukan tanggal proses", "warning");
        return;
    }

    // --- REALTIME: Ambil data terbaru dari server ---
    await sinkronDataServer();

    document.getElementById('monitor_date').innerHTML = `TANGGAL PROSES: <span style="color: #2980b9;">${tglRaw}</span>`;

    const clean = v => String(v || "").trim().toUpperCase();
    const tglTarget = tglRaw.substring(0, 10);

    let monitorMap = {};

    // 1ï¸âƒ£ TARGET DARI MASTER
    const masterData = [
        ...dbPickAuto.map(d => ({ ...d, src: 'PA' })),
        ...dbManual.map(d => ({ ...d, src: 'MN' }))
    ];

    masterData.forEach(item => {
        if (clean(item.tglInput) !== tglTarget) return;
        const kode = clean(item.kodeToko);
        if (!kode) return;

        if (!monitorMap[kode]) {
            monitorMap[kode] = {
                urpick: item.urpick || "",
                kode: kode,
                tKN: 0, tDS: 0, tMN: 0,
                sKN: 0, sDS: 0, sMN: 0,
                hasRemark: false, // Flag untuk status Paksa Final
                petugas: [] // Untuk mencatat siapa saja yang kerja di toko ini
            };
        }

        if (item.src === 'MN') {
            monitorMap[kode].tMN += parseInt(item.qtyData || 0);
        } else {
            const kont = clean(item.kontainer);
            if (kont.startsWith("DOS")) {
                monitorMap[kode].tDS += parseInt(item.qtyData || 0);
            } else if (kont !== "") {
                monitorMap[kode].tKN += 1;
            }
        }
    });

    // 2ï¸âƒ£ REALISASI DARI SCAN (dbSudahPolcek)
    dbSudahPolcek.forEach(s => {
        const tglScan = clean(s.tgl).substring(0, 10);
        if (tglScan !== tglTarget) return;

        const kode = clean(s.kode);
        const jenis = clean(s.jenis);
        const qty = parseInt(s.qty_scan || 0);
        const ket = clean(s.keterangan);
        const pgw = s.petugas || "Anonim";

        if (!kode) return;

        if (!monitorMap[kode]) {
            monitorMap[kode] = { urpick: "", kode: kode, tKN: 0, tDS: 0, tMN: 0, sKN: 0, sDS: 0, sMN: 0, hasRemark: false, petugas: [] };
        }

        // Hitung Realisasi
        if (jenis === "KONTAINER") monitorMap[kode].sKN += qty;
        else if (jenis === "DOS") monitorMap[kode].sDS += qty;
        else if (jenis === "MANUAL") monitorMap[kode].sMN += qty;

        // Cek apakah ada keterangan (Paksa Final)
        if (ket !== "") monitorMap[kode].hasRemark = true;

        // Catat petugas (unik)
        if (!monitorMap[kode].petugas.includes(pgw)) monitorMap[kode].petugas.push(pgw);
    });

    renderMonitorTable(monitorMap);
    document.getElementById('modal_monitor').style.display = 'block';
}


function renderMonitorTable(dataMap) {
    const container = document.getElementById('monitor_content');
    let html = `<table class="table-monitor" style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead>
            <tr style="background:#2c3e50; color:white;">
                <th>URPICK</th>
                <th>TOKO</th>
                <th>KN (T/S)</th>
                <th>DS (T/S)</th>
                <th>MN (T/S)</th>
                <th>USER</th>
                <th>STAT</th>
            </tr>
        </thead>
        <tbody>`;

    Object.values(dataMap).forEach(d => {
        const matchKN = d.tKN === d.sKN;
        const matchDS = d.tDS === d.sDS;
        const matchMN = d.tMN === d.sMN;
        const isAllMatch = matchKN && matchDS && matchMN;
        
        // Penentuan Status dan Warna Baris
        let rowBg = "white";
        let statusIcon = "â³";
        
        if (isAllMatch) {
            rowBg = "#d4edda"; // Hijau (Match Sempurna)
            statusIcon = "âœ…";
        } else if (d.hasRemark) {
            rowBg = "#ffeeba"; // Oranye/Kuning (Paksa Final/Ada Keterangan)
            statusIcon = "âš ï¸";
        }

        const formatTS = (t, s) => `<span style="color: ${t === s ? 'black' : 'red'}">${t}/${s}</span>`;

        html += `
            <tr style="background-color: ${rowBg}; border-bottom:1px solid #eee;">
                <td>${d.urpick}</td>
                <td style="text-align:left"><b>${d.kode}</b></td>
                <td>${formatTS(d.tKN, d.sKN)}</td>
                <td>${formatTS(d.tDS, d.sDS)}</td>
                <td>${formatTS(d.tMN, d.sMN)}</td>
                <td style="font-size:10px; color:#555;">${d.petugas.join(", ")}</td>
                <td title="${d.hasRemark ? 'Paksa Final dengan Keterangan' : ''}">${statusIcon}</td>
            </tr>`;
    });
    
    html += `</tbody></table>`;
    container.innerHTML = html;
}

    function closeMonitoring() {
        document.getElementById('modal_report').style.display = 'none';
        document.getElementById('report_head').style.display = ''; 
        document.getElementById('btn_finalisasi').style.display = 'block';
        document.getElementById('report_title').innerText = "DATA COMPARE";
    }

async function sinkronDataServer() {
    try {
        // Gunakan G_GITHUB_URL yang sudah Anda definisikan di atas
        const res = await fetch(G_GITHUB_URL + "?t=" + new Date().getTime());
        if (!res.ok) throw new Error("Gagal ambil data GitHub");

        const out = await res.json();
        
        // Update variabel global
        dbSudahPolcek = out.dataSudahPolcek || [];
        
        console.log("Sinkronisasi Realtime Berhasil. Data scan terupdate.");
        
        // PENTING: Nama fungsi harus renderMonitorTable (sesuai kode Anda)
        // Kita tidak memanggil render di sini karena showMonitoring akan memanggilnya nanti
        // Tapi jika Anda ingin tombol refresh sendiri, gunakan pengecekan ini:
        if (typeof renderMonitorTable === "function" && document.getElementById('modal_monitor').style.display === 'block') {
             // Re-render jika modal sedang terbuka
             showMonitoring(); 
        }

    } catch (e) {
        console.error("Gagal sinkron data server:", e);
    }
}
async function revisiQty(index) {
    // 1. Ambil data asli dari LocalStorage
    let allData = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    let item = allData[index];

    if (!item) return Swal.fire("Error", "Data tidak ditemukan!", "error");

    // 2. Tutup modal utama agar tidak menumpuk
    document.getElementById('modal_report').style.display = 'none';

    // 3. Minta OTP (Keamanan)
    const { value: otp } = await Swal.fire({ 
        title: 'Otoritas Revisi', 
        input: 'password', 
        inputLabel: 'Masukkan PIN Revisi (OTP)', 
        showCancelButton: true 
    });

    // Cek OTP
    if (otp !== "234") {
        if (otp !== undefined) await Swal.fire("Error", "OTP Salah!", "error");
        showReport(); // Kembalikan ke modal report
        return;
    }

    // 4. Jika OTP Benar, Munculkan Form Gabungan (Qty + Keterangan)
    const { value: formValues } = await Swal.fire({
        title: 'Form Revisi Data',
        html:
            `<div style="text-align:left; font-size:14px;">` +
            `<p>Item: <b>${item.descp || item.plu}</b></p>` +
            `<p>Target Faktur: <b>${item.qty_data}</b></p>` +
            `<hr>` +
            `<label><b>Qty Scan Baru:</b></label>` +
            `<input id="swal-qty" class="swal2-input" type="number" value="${item.qty_scan}">` +
            `<label><b>Keterangan Selisih:</b></label>` +
            `<textarea id="swal-ket" class="swal2-textarea" placeholder="Wajib diisi jika Qty Scan tidak sesuai Target">${item.keterangan || ""}</textarea>` +
            `</div>`,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Simpan Perubahan',
        preConfirm: () => {
            const nQty = parseInt(document.getElementById('swal-qty').value);
            const nKet = document.getElementById('swal-ket').value.trim();
            
            // Validasi 1: Qty tidak boleh lebih besar dari target (untuk DOS/MANUAL)
            if ((item.jenis === "DOS" || item.jenis === "MANUAL") && nQty > item.qty_data) {
                Swal.showValidationMessage(`Qty (${nQty}) melebihi target (${item.qty_data})!`);
                return false;
            }
            
            // Validasi 2: Wajib isi keterangan jika tidak match
            if (nQty !== item.qty_data && nKet === "") {
                Swal.showValidationMessage(`Keterangan wajib diisi jika ada selisih!`);
                return false;
            }
            
            return { qty: nQty, ket: nKet };
        }
    });

    // 5. Eksekusi Update Data
    if (formValues) {
        let qtyBaru = formValues.qty;
        let ketBaru = formValues.ket;

        if (item.jenis === "DOS" || item.jenis === "MANUAL") {
            // Logika anti-double: bersihkan baris lain dengan PLU & Faktur yang sama
            allData = allData.filter((val, idx) => {
                if (idx === index) return true; // Simpan baris ini
                return !(val.plu === item.plu && val.faktur === item.faktur);
            });
            
            // Update baris yang tersisa
            const targetIdx = allData.findIndex(x => x === item);
            if (targetIdx !== -1) {
                allData[targetIdx].qty_scan = qtyBaru;
                allData[targetIdx].keterangan = ketBaru;
            }
        } else {
            // Untuk KONTAINER dsb, update langsung berdasarkan index
            allData[index].qty_scan = qtyBaru;
            allData[index].keterangan = ketBaru;
        }

        // Simpan ke LocalStorage
        localStorage.setItem('q_polcek', JSON.stringify(allData));
        
        await Swal.fire({ icon: "success", title: "Berhasil", text: "Data diperbarui", timer: 1000, showConfirmButton: false });
    }

    // 6. Apapun hasilnya, kembali buka modal report
    showReport(); 
}

function showReport() {
    const tglRaw = document.getElementById('p_tgl').value;
    const kode = document.getElementById('p_kode').value.trim().toUpperCase();
    const jenis = document.getElementById('p_jenis').value;
    const faktur = document.getElementById('p_faktur').value;
    
    if (!tglRaw || !kode || !faktur) return Swal.fire("Peringatan", "Lengkapi data Toko dan Faktur!", "warning");

    // DATA ANTRIAN LOKAL SAJA (Untuk keperluan Revisi/Finalisasi)
    const scanDB = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    const aktualData = scanDB.filter(i => i.tgl === tglRaw && i.kode === kode && i.faktur === faktur && i.jenis === jenis);

    // LOGIKA PERBANDINGAN DATA (REPORT TABLE)
    const d = new Date(tglRaw);
    const tglCheck = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
    
    let reportMap = {};
    let isAllMatch = true; 
    let isComparisonType = ["KONTAINER", "DOS", "MANUAL"].includes(jenis);

    if (isComparisonType) {
        const currentDB = (jenis === "MANUAL") ? dbManual : dbPickAuto;
        const targetData = currentDB.filter(i => {
            if (!(i.tglInput === tglCheck && i.kodeToko === kode && i.faktur === faktur)) return false;
            const kVal = (i.kontainer || "").toUpperCase();
            const isD = kVal.includes("DOS");
            return jenis === "KONTAINER" ? !isD : (jenis === "DOS" ? isD : true);
        });

        targetData.forEach(item => {
            const kMaster = (item.kontainer || "MANUAL").toUpperCase();
            let key = (jenis === "KONTAINER") ? kMaster : (jenis === "DOS" ? `${kMaster} | ${item.plu}` : item.plu);
            if (!reportMap[key]) reportMap[key] = { desc: (jenis === "KONTAINER") ? "" : (item.descp || kMaster), target: 0, scan: 0 };
            reportMap[key].target += (jenis === "KONTAINER") ? 1 : parseInt(item.qtyData || 0);
        });

        aktualData.forEach(item => {
            const parts = (item.barcode || "").split('-').filter(Boolean);
            let keyScan = (jenis === "KONTAINER") ? (parts[0] || "ERR").toUpperCase() : (jenis === "DOS" ? `${parts[0]}-${parts[1]} | ${item.plu}`.toUpperCase() : (parts[parts.length - 1] || item.plu));
            if (reportMap[keyScan]) reportMap[keyScan].scan += parseInt(item.qty_scan || 0);
            else reportMap[keyScan] = { desc: item.descp || "OVER", target: 0, scan: parseInt(item.qty_scan || 0) };
        });
    } else {
        aktualData.forEach(item => {
            const key = item.barcode || item.plu || "ITEM";
            reportMap[key] = { desc: item.descp || "DATA INPUT", target: "N/A", scan: parseInt(item.qty_scan || 0) };
        });
    }

    // GENERATE HTML TABEL
    let html = "";
    Object.keys(reportMap).forEach(key => {
        const r = reportMap[key];
        const itemDitemukan = aktualData.find(i => (i.plu === key || (i.barcode && i.barcode.includes(key)) || (key.includes(' | ') && i.plu === key.split(' | ')[1])));
        const indexAsli = scanDB.findIndex(x => x === itemDitemukan);
        const itemPunyaKet = itemDitemukan && itemDitemukan.keterangan ? itemDitemukan.keterangan : "";

        let status;
        if (r.target === "N/A" || r.scan === r.target) status = "DONE";
        else if (itemPunyaKet !== "") status = "SELISIH"; 
        else status = (r.scan < r.target ? "PENDING" : "OVER");
        
        if (status !== "DONE" && status !== "SELISIH") isAllMatch = false; 
        
        const colorBg = status === 'DONE' ? '#d4edda' : (status === 'SELISIH' ? '#ffcc80' : (status === 'PENDING' ? '#f8d7da' : '#fff3cd'));
        const displayDesc = (jenis === "KONTAINER" || !r.desc) ? "" : `<br><small>${r.desc}</small>`;
        const ketTampil = itemPunyaKet ? `<br><i style="font-size:9px; color:brown;">Ket: ${itemPunyaKet}</i>` : "";

        html += `<tr style="background:${colorBg}">
            <td style="text-align:left; padding:5px;"><b>${key}</b>${displayDesc}${ketTampil}</td>
            <td>${r.target}</td>
            <td>${r.scan}</td>
            <td>
                <b>${status}</b><br>
                <button onclick="revisiQty(${indexAsli})" style="font-size:10px; background:#f39c12; color:white; border:none; border-radius:3px; padding:3px 8px;">REVISI</button>
            </td>
        </tr>`;
    });

    // --- BAGIAN UPDATE UI ---
    document.getElementById('report_info').innerHTML = `<b>${jenis}</b> | ${kode} | ${faktur}`;
    document.getElementById('report_body').innerHTML = html || "<tr><td colspan='4'>Belum ada data di antrian</td></tr>";
    document.getElementById('modal_report').style.display = 'block';

    // Update tombol Finalisasi
    const btnFin = document.getElementById('btn_finalisasi');
    if (btnFin) {
        btnFin.disabled = !(Object.keys(reportMap).length > 0 && isAllMatch);
        btnFin.style.opacity = btnFin.disabled ? "0.3" : "1";
    }

    // --- BAGIAN RIWAYAT (LIST ANTRIAN) ---
    // Dipindah ke elemen list_antrian (jika ada di dalam modal)
    const listAntrian = document.getElementById('list_antrian');
    if (listAntrian) {
        listAntrian.innerHTML = "";
        let gabungan = [...scanDB, ...dbSudahPolcek];
        gabungan.forEach((item) => {
            const namaPetugas = String(item.petugas || "ANONIM").toUpperCase();
            const userAktif = String(currentUser || "").toUpperCase();
            if (namaPetugas === userAktif) {
                let li = document.createElement('li');
                li.style.fontSize = "10px";
                li.innerHTML = `<b>${item.faktur}</b>: ${item.plu} (${item.qty_scan} pcs)`;
                listAntrian.appendChild(li);
            }
        });
    }
}

function processStoreInput() {
    const kodeInput = document.getElementById('p_kode');
    if (kodeInput && kodeInput.value.trim() !== "") {
        // --- AWAL TAMBAHAN: LOGIKA EKSTRAKSI BARCODE LABEL ---
        let rawVal = kodeInput.value.trim().toUpperCase();
        const parts = rawVal.split('-').filter(Boolean);

        if (parts.length > 1) {
            // Jika discan dari Label KONTAINER (Contoh: A0001-R665) -> Ambil R665
            if (rawVal.includes("KONTAINER") || parts.length === 2) {
                rawVal = parts[1];
            } 
            // Jika discan dari Label DOS (Contoh: DOS-C5-R665-432296) -> Ambil R665
            else if (rawVal.includes("DOS") || parts.length >= 4) {
                rawVal = parts[2];
            }
        }
        kodeInput.value = rawVal; // Masukkan hasil ekstraksi kembali ke kolom
        // --- AKHIR TAMBAHAN ---

        // Jalankan filter (Struktur asli tetap di bawah)
        const found = runFilter(); 

        if (found) {
            // Sesuai Tahap 8: Setelah input Kode Toko, fokus ke Faktur
            setFocus('p_faktur');
        } else {
            notify("âš ï¸ Toko tidak ditemukan!", "error", "p_kode");
        }
    }
}

function alurFokus(currentStep) {
    if (currentStep === 'tgl') {
        setFocus('p_jenis');
    } else if (currentStep === 'jenis') {
        setFocus('p_kode');
    } else if (currentStep === 'kode') {
        // runFilter() dipanggil di sini untuk mengisi No Faktur
        runFilter(); 
        setFocus('p_faktur');
    } else if (currentStep === 'faktur') {
        setFocus('p_scan_label');
    }
}

function clearAllFields(isManual = true) {
    if(isManual) {
        // Jika ditekan tombol Clear (Point 12)
        const yakin = confirm("Hapus Semua Inputan?");
        if(!yakin) return;
    }

    // Reset Dropdown ke default
    document.getElementById('p_jenis').value = "";
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
    
    // Kosongkan semua inputan teks
    const ids = ['p_kode','p_nama','p_urpick','p_scan_label','p_scan_fisik','p_plu','p_descp','p_zona','p_qty_input','p_qty_data'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = "";
    });

    // Reset area fisik & readonly qty
    document.getElementById('area_fisik').style.display = 'none';
    const qtyInp = document.getElementById('p_qty_input');
    qtyInp.readOnly = true; 
    qtyInp.style.background = "#dcdcdc";

    // Fokus kembali ke TGL atau JENIS
    setFocus('p_tgl');
}

// Tambahkan listener pada TGL dan JENIS untuk trigger reset (Point 9)
document.getElementById('p_tgl').addEventListener('change', () => {
    // Jika ganti tanggal, reset semua field di bawahnya
    ['p_kode','p_nama','p_urpick','p_scan_label'].forEach(id => document.getElementById(id).value = "");
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
});

async function refreshMonitoringData() {
    const loader = document.getElementById('loader');
    const modalMonitor = document.getElementById('modal_monitor');

    modalMonitor.style.display = 'none'; // Tutup dulu
    loader.style.display = 'flex';       // Muncul loader

    try {
        const res = await fetch(G_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "getAllData" })
        });
        const out = await res.json();

        if (out.status === "success") {
            // Update dbSudahPolcek
            dbSudahPolcek = (out.dataSudahPolcek || []).map(r => ({
                tgl: String(r.tgl || "").substring(0, 10),
                kode: String(r.kode || "").trim().toUpperCase(),
                jenis: String(r.jenis || "").trim().toUpperCase(),
                barcode: String(r.barcode || "").trim().toUpperCase(), 
                qty_scan: Number(r.qty_scan || 0)
            }));
            localStorage.setItem("db_sudah_polcek", JSON.stringify(dbSudahPolcek));
        }
    } catch (e) {
        Swal.fire("Gagal", "Koneksi Bermasalah", "error");
    } finally {
        loader.style.display = 'none'; // Matikan loader
        
        // JALANKAN INI UNTUK MEMBUKA KEMBALI MODAL
        showMonitoring(); 
    }
}

function openResetModal() {
    document.getElementById('modal_reset').style.display = 'flex';
}

function closeResetModal() {
    document.getElementById('modal_reset').style.display = 'none';
    document.getElementById('r_nik').value = "";
    document.getElementById('r_pass_lama').value = "";
    document.getElementById('r_pass_baru').value = "";
}

async function processResetPassword() {
    const nik = document.getElementById('r_nik').value;
    const passLama = document.getElementById('r_pass_lama').value;
    const passBaru = document.getElementById('r_pass_baru').value;

    if (!nik || !passLama || !passBaru) {
        return Swal.fire("Gagal", "Semua field harus diisi!", "error");
    }

    // Tampilkan Loader
    document.getElementById('loader').style.display = 'flex';

    try {
        const res = await fetch(G_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: "updatePassword", 
                nik: nik, 
                passLama: passLama, 
                passBaru: passBaru 
            })
        });
        const out = await res.json();

        if (out.status === "success") {
            Swal.fire("Berhasil", "Password berhasil diperbarui!", "success");
            closeResetModal();
        } else {
            Swal.fire("Gagal", out.message || "Password lama salah!", "error");
        }
    } catch (e) {
        Swal.fire("Error", "Koneksi ke server bermasalah", "error");
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
}

window.onbeforeunload = function() {
    if (localStorage.getItem("isLoggedIn") === "true") {
        return "Proses Polcek sedang berjalan. Anda yakin ingin menutup halaman?";
    }
};

// Fungsi untuk membunyikan suara peringatan/error
function playError() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    oscillator.type = 'sawtooth'; // Suara agak kasar untuk menandakan error
    oscillator.frequency.setValueAtTime(150, audioCtx.currentTime); // Nada rendah
    
    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);

    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.5); // Bunyi selama 0.5 detik
}

async function editItemAntrian(key) {
    // SEMBUNYIKAN MODAL REPORT TERLEBIH DAHULU
    document.getElementById('modal_report').style.display = 'none';

    // 1. Tanyakan Opsi Revisi
    const { value: opsi } = await Swal.fire({
        title: 'OPSI REVISI',
        text: `Pilih tindakan untuk item ${key}`,
        icon: 'question',
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: 'REVISI QTY',
        denyButtonText: 'FINAL SELISIH',
        cancelButtonText: 'BATAL',
        confirmButtonColor: '#3085d6',
        denyButtonColor: '#f39c12',
        allowOutsideClick: false // Mencegah klik luar agar modal report tidak "nyangkut"
    });

    // JIKA USER TEKAN BATAL / CANCEL
    if (opsi === undefined) {
        document.getElementById('modal_report').style.display = 'block';
        return;
    }

    // --- CABANG A: REVISI QTY ---
    if (opsi === true) { 
        const { value: otp } = await Swal.fire({
            title: 'VERIFIKASI OTP',
            input: 'password',
            inputPlaceholder: 'Masukkan OTP Supervisor',
            showCancelButton: true
        });

        if (otp === "1234") { 
            const { value: qtyBaru } = await Swal.fire({
                title: 'INPUT QTY BARU',
                input: 'number',
                inputAttributes: { min: 0 },
                showCancelButton: true
            });

            if (qtyBaru !== undefined) {
                updateQtyLokal(key, parseInt(qtyBaru), "");
                await Swal.fire('Berhasil', 'Qty telah diperbarui', 'success');
            }
        } else if (otp) {
            await Swal.fire('Gagal', 'OTP Salah!', 'error');
        }
    } 

    // --- CABANG B: FINAL SELISIH (PAKSA FINAL) ---
    else if (opsi === false) { 
        const { value: formValues } = await Swal.fire({
            title: 'FINAL SELISIH',
            html:
                '<input id="swal-otp" class="swal2-input" placeholder="OTP Supervisor" type="password">' +
                '<textarea id="swal-ket" class="swal2-textarea" placeholder="Keterangan Wajib (Pecah/Hilang/dll)"></textarea>',
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'OK PAKSA FINAL',
            preConfirm: () => {
                const otp = document.getElementById('swal-otp').value;
                const ket = document.getElementById('swal-ket').value;
                if (!otp || !ket) {
                    Swal.showValidationMessage('OTP dan Keterangan WAJIB diisi!');
                }
                return { otp: otp, ket: ket };
            }
        });

        if (formValues) {
            if (formValues.otp === "1234") {
                updateQtyLokal(key, null, formValues.ket);
                await Swal.fire('Tersimpan', 'Status: Paksa Final (Selisih)', 'warning');
            } else {
                await Swal.fire('Gagal', 'OTP Salah!', 'error');
            }
        }
    }

       showReport(); 
}

function updateQtyLokal(key, qtyBaru, keterangan) {
    let antrian = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    antrian.forEach(item => {
        if (item.plu === key || item.barcode === key || item.kontainer === key) {
            if (qtyBaru !== null) item.qty_scan = qtyBaru;
            if (keterangan) item.keterangan = keterangan;
        }
    });
    localStorage.setItem('q_polcek', JSON.stringify(antrian));
}

function handleScanToko(val) {
    if (!val) return;

    // Pecah barcode berdasarkan tanda strip '-'
    const parts = val.split('-').filter(Boolean);
    let hasilKode = val.toUpperCase().trim();

    // 1. Logika Ekstraksi Kode Toko
    if (parts.length > 1) {
        if (val.toUpperCase().includes("KONTAINER") || parts.length === 2) {
            // Contoh: A0001-R665 -> Toko di parts[1]
            hasilKode = parts[1].toUpperCase();
        } 
        else if (val.toUpperCase().includes("DOS") || parts.length >= 4) {
            // Contoh: DOS-C5-R665-432296 -> Toko di parts[2]
            hasilKode = parts[2].toUpperCase();
        }
    }

    // 2. Masukkan hasil ke input KD STORE
    document.getElementById('p_kode').value = hasilKode;

    // 3. Jalankan filter toko (agar list faktur terisi)
    if (typeof filterToko === "function") {
        filterToko(); 
    }

    // 4. PINDAHKAN FOKUS KE NO FAKTUR
    // Gunakan setTimeout sedikit agar browser sempat merender list faktur terlebih dahulu
    setTimeout(() => {
        const elFaktur = document.getElementById('p_faktur');
        if (elFaktur) {
            elFaktur.focus();
            // Jika p_faktur adalah dropdown/select, kita bisa memicu pembukaan list
            console.log("Fokus pindah ke No Faktur");
        }
    }, 300);
}


// Fungsi untuk menampilkan Area Scan dan menyembunyikan Header
function toggleAreaScan() {
    const tgl = document.getElementById('p_tgl').value;
    const kode = document.getElementById('p_kode').value;
    const faktur = document.getElementById('p_faktur').value;

    // Jika ketiga data utama sudah terisi
    if (tgl && kode && faktur) {
        document.getElementById('section_header').style.display = 'none'; // Sembunyikan Atas
        document.getElementById('section_scan').style.display = 'block'; // Tampilkan Bawah
        
        // Langsung fokuskan ke tempat scan label agar user tidak klik lagi
        setTimeout(() => {
            document.getElementById('p_scan_label').focus();
        }, 300);
    }
}

// Fungsi untuk kembali ke layar utama (setelah final atau klik tombol kembali)
function backToHeader() {
    document.getElementById('section_header').style.display = 'block'; // Tampilkan Atas
    document.getElementById('section_scan').style.display = 'none';   // Sembunyikan Bawah
    
    // Reset input agar bersih untuk input toko baru
    document.getElementById('p_kode').value = "";
    document.getElementById('p_nama').value = "";
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
}

function kembaliKeHeader() {
    document.getElementById('group_header').style.display = 'block';
    document.getElementById('group_scan').style.display = 'none';
    setFocus('p_faktur');
}

// Pastikan saat Clear data atau setelah Final, tampilan kembali ke Header
function resetTampilanLayar() {
    document.getElementById('group_header').style.display = 'block';
    document.getElementById('group_scan').style.display = 'none';
}

function showAntrianModal() {
    const scanDB = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    const tbody = document.getElementById('antrian_body');
    tbody.innerHTML = "";

    // 1. Bersihkan area tombol bawah agar tidak duplikat saat dibuka berkali-kali
    const oldContainer = document.getElementById('footer_antrian_action');
    if (oldContainer) oldContainer.remove();

    if (scanDB.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4' style='padding:20px;'>Tidak ada antrian data</td></tr>";
    } else {
        const grouped = {};
        scanDB.forEach(item => {
            if (!grouped[item.faktur]) {
                grouped[item.faktur] = {
                    urpick: item.urpick || "-",
                    kode: item.kode,
                    nama: item.nama || "",
                    tgl: item.tgl,
                    jenis: item.jenis
                };
            }
        });

        Object.keys(grouped).forEach(faktur => {
            const g = grouped[faktur];
            const row = `<tr>
                <td>${g.urpick}</td>
                <td style="text-align:left; padding:5px;"><b>${g.kode}</b><br>${g.nama}</td>
                <td>${g.jenis}</td>
                <td>
                    <div style="display:flex; flex-direction:column; gap:3px; padding:5px;">
                        <button onclick="pilihAntrian('${g.tgl}', '${g.kode}', '${faktur}', '${g.jenis}')" 
                                style="background:#27ae60; color:white; border:none; padding:5px; border-radius:3px; font-size:9px; cursor:pointer;">
                            PROSES FINAL
                        </button>
                        <button onclick="hapusSatuAntrian('${faktur}')" 
                                style="background:#e74c3c; color:white; border:none; padding:5px; border-radius:3px; font-size:9px; cursor:pointer;">
                            HAPUS
                        </button>
                    </div>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });

        // 2. LOGIKA TOMBOL BERDAMPINGAN
        // Cari tombol TUTUP asli
        const btnTutupAsli = document.querySelector('#modal_antrian .btn-main[onclick*="modal_antrian"]');
        
        if (btnTutupAsli) {
            // Sembunyikan tombol tutup yang lama agar kita pindahkan ke container baru
            btnTutupAsli.style.display = 'none';

            // Buat container flex
            const footerAction = document.createElement('div');
            footerAction.id = 'footer_antrian_action';
            footerAction.style = "display: flex; gap: 10px; margin-top: 20px;";

            // Buat tombol BERSIHKAN
            const btnClean = document.createElement('button');
            btnClean.innerHTML = "ðŸ—‘ï¸ BERSIHKAN";
            btnClean.className = "btn-main"; // Gunakan class yang sama agar style seragam
            btnClean.style = "background: #c0392b; flex: 1; padding: 12px; border-radius: 5px; color: white; border: none; font-weight: bold; cursor: pointer;";
            btnClean.onclick = hapusSemuaAntrian;

            // Buat ulang tombol TUTUP di sampingnya
            const btnClose = document.createElement('button');
            btnClose.innerHTML = "TUTUP";
            btnClose.className = "btn-main";
            btnClose.style = "background: #34495e; flex: 1; padding: 12px; border-radius: 5px; color: white; border: none; font-weight: bold; cursor: pointer;";
            btnClose.onclick = () => document.getElementById('modal_antrian').style.display = 'none';

            footerAction.appendChild(btnClean);
            footerAction.appendChild(btnClose);
            
            // Masukkan ke bawah tabel
            btnTutupAsli.parentNode.appendChild(footerAction);
        }
    }
    document.getElementById('modal_antrian').style.display = 'block';
}

// FUNGSI 1: Hapus per toko/faktur
function hapusSatuAntrian(faktur) {
    Swal.fire({
        title: 'Hapus Antrian?',
        text: `Faktur ${faktur} akan dihapus dari antrian.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Ya, Hapus!',
        didOpen: () => {
            const container = Swal.getContainer();
            if (container) {
                container.style.zIndex = '99999';
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            let db = JSON.parse(localStorage.getItem('q_polcek') || "[]");
            let filtered = db.filter(i => i.faktur !== faktur);
            localStorage.setItem('q_polcek', JSON.stringify(filtered));
            
            if (typeof updateBadge === "function") updateBadge();
            showAntrianModal();

            Swal.fire({
                title: 'Terhapus!',
                icon: 'success',
                timer: 800,
                showConfirmButton: false,
                didOpen: () => { Swal.getContainer().style.zIndex = '99999'; }
            });
        }
    });
}

function hapusSemuaAntrian() {
    Swal.fire({
        title: 'Kosongkan Antrian?',
        text: "Semua data akan dihapus untuk pembersihan data harian!",
        icon: 'warning', // Diubah dari 'danger' ke 'warning'
        showCancelButton: true,
        confirmButtonColor: '#c0392b',
        confirmButtonText: 'YA, BERSIHKAN!',
        // Memastikan z-index SweetAlert lebih tinggi dari modal (20000)
        didOpen: () => {
            const container = Swal.getContainer();
            if (container) {
                container.style.zIndex = '99999';
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            localStorage.removeItem('q_polcek');
            if (typeof updateBadge === "function") updateBadge();
            showAntrianModal(); 
            
            Swal.fire({
                title: 'Bersih!',
                text: 'Data antrian telah dikosongkan.',
                icon: 'success',
                didOpen: () => { Swal.getContainer().style.zIndex = '99999'; }
            });
        }
    });
}

function pilihAntrian(tgl, kode, faktur, jenis) {
    // 1. Masukkan data ke input header
    document.getElementById('p_tgl').value = tgl;
    document.getElementById('p_kode').value = kode;
    document.getElementById('p_jenis').value = jenis;
    
    // 2. Jalankan filter toko agar info nama muncul
    processStoreInput(); 
    
    // 3. Set No Faktur dan trigger tampil area scan/report
    setTimeout(() => {
        document.getElementById('p_faktur').value = faktur;
        document.getElementById('modal_antrian').style.display = 'none';
        
        // Langsung buka modal report (Final) untuk toko tersebut
        showReport();
    }, 500);
}

function toggleArea(target) {
    const header = document.getElementById('group_header');
    const scan = document.getElementById('group_scan');

    if (target === 'HEADER') {
        header.style.display = 'block';
        scan.style.display = 'none';
    } else {
        header.style.display = 'none';
        scan.style.display = 'block';
    }
}

</script>
</body>
</html>
