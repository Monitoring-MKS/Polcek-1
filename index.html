<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLCEK WH - MAKASSAR</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>

/* Membuat area badge menempel di bawah layar */
.sticky-badge {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #000; /* Hitam */
    color: #ff0; /* Kuning */
    text-align: center;
    padding: 15px 0;
    font-weight: bold;
    font-size: 14px;
    border-top: 2px dashed #ff0;
    z-index: 9999; /* Pastikan paling depan */
    cursor: pointer;
}

/* Beri jarak bawah pada main_app supaya konten paling bawah tidak tertutup badge */
#main_app {
    padding-bottom: 70px; 
}

        /* Tombol Close Pojok Kanan Atas */
        .btn-close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 20001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        :root { --green: #70ad47; --orange: #e67e22; --blue: #2980b9; --red: #c0392b; }
        * { box-sizing: border-box; font-family: 'Arial Black', sans-serif; }
        body { background: #b0b0b0; padding: 15px; margin: 0; }
        
        #login_screen {
            position: fixed; inset: 0; background: #2c3e50; z-index: 30000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        .login-box {
            background: white; padding: 25px; border-radius: 10px; width: 100%; max-width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .login-box h2 { text-align: center; margin-bottom: 20px; color: #333; font-size: 18px; }

        .user-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #34495e; color: white; padding: 5px 15px;
            border-radius: 5px; margin-bottom: 10px; font-size: 12px;
        }
        .btn-logout {
            background: var(--red); color: white; border: none; padding: 5px 10px;
            border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 10px;
        }

        .header { background: black; color: white; text-align: center; padding: 12px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
        .input-row { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
        .label { width: 110px; padding: 10px; font-size: 10px; color: white; border-radius: 5px; font-weight: bold; background: var(--green); text-transform: uppercase; }
        input, select { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #777; font-size: 13px; font-weight: bold; }
        input[readonly] { background: #dcdcdc; color: #333; }
        .footer { display: flex; gap: 8px; margin-top: 15px; }
        .btn-main { flex: 1; padding: 15px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; }
        #loader {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7); /* Background gelap transparan */
    /* Z-INDEX HARUS LEBIH TINGGI DARI MODAL (biasanya modal itu 1000-2000) */
    z-index: 99999; 
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: white;
}

/* Tambahkan animasi putar agar lebih jelas sedang proses */
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/*CSS khusus tabel monitoring*/
    .table-monitor { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
    .table-monitor th { background: #2c3e50; color: white; padding: 8px; border: 1px solid #ddd; }
    .table-monitor td { padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; }
    .table-monitor tr:nth-child(even) { background-color: #f2f2f2; }
    .status-match { color: #27ae60; }
    .status-pending { color: #e67e22; }


.circle-loader {
  width: 48px;
  height: 48px;
  border: 5px solid rgba(255,255,255,0.3);
  border-top: 5px solid #ffffff;
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

.my-swal-z-index {
    z-index: 99999 !important; /* Angka tertinggi agar tidak tertutup apapun */
}

/* Tambahkan di bagian <style> */
.antrian-footer {
    position: sticky;
    bottom: 0;
    background: black;
    color: yellow;
    text-align: center;
    padding: 10px;
    font-size: 11px;
    margin-top: 10px;
    border-radius: 5px 5px 0 0;
    cursor: pointer;
    border: 1px dashed yellow;
    z-index: 100;
}


</style>

</head>
<body onload="initApp()">

<div id="modal_monitor" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20000; overflow-y:auto; padding:10px;">
    <div style="background:white; border-radius:10px; padding:15px; min-height:100%; position: relative;">
        <button class="btn-close-modal" onclick="document.getElementById('modal_monitor').style.display='none'">Ã—</button>
        
        <h3 style="text-align:center; margin-top:0; color: #2c3e50;">MONITORING POLCEK</h3>

<p id="monitor_date" style="text-align:center; font-size:10px; font-weight:bold; margin-top:-10px; color: #555;"></p>
<button onclick="refreshMonitoringData()" style="background: #27ae60; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">
                ðŸ”„ Sync Data
            </button>
        <p id="monitor_date" style="text-align:center; font-size:12px; font-weight:bold;"></p>
        
        <hr>

        <div id="monitor_content" style="overflow-x:auto;">
             </div>

        <div style="margin-top:20px;">
            <button class="btn-main" style="background:#34495e; width: 100%;" onclick="document.getElementById('modal_monitor').style.display='none'">TUTUP MONITORING</button>
        </div>
    </div>
</div>

<div id="loader"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.75); z-index:9999;
            display:flex; flex-direction:column; justify-content:center; align-items:center;">

  <div class="circle-loader"></div>

  <p style="margin-top:15px; font-size:14px; font-weight:bold; color:#ffffff;">
    Update data master, mohon tunggu...
  </p>
</div>

<div id="modal_antrian" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20000; overflow-y:auto; padding:10px;">
    <div style="background:white; border-radius:10px; padding:15px; min-height:100%; position: relative;">
        <button class="btn-close-modal" onclick="document.getElementById('modal_antrian').style.display='none'">Ã—</button>
        <h3 style="text-align:center; margin-top:0; color: #2c3e50;">ANTRIAN BELUM FINAL</h3>
        <hr>
        <div style="overflow-x:auto;">
            <table border="1" style="width:100%; border-collapse:collapse; font-size:10px; text-align:center;">
                <thead style="background:#eee;">
                    <tr>
                        <th>URPICK</th>
                        <th>TOKO</th>
                        <th>KONT / DOS / MN</th>
                        <th>ACTION</th>
                    </tr>
                </thead>
                <tbody id="antrian_body">
                    </tbody>
            </table>
        </div>
        <button class="btn-main" style="background:#34495e; width: 100%; margin-top: 20px;" onclick="document.getElementById('modal_antrian').style.display='none'">TUTUP</button>
    </div>
</div>

<div id="login_screen">
    <div class="login-box">
        <div style="text-align: center; font-size: 12px; color: #7f8c8d; margin-bottom: 5px; font-family: monospace;">
            V.01.02.26@ mks-bersatu
        </div>
        <h2>LOGIN POLCEK</h2>
        <div class="input-row"><input type="text" id="l_nik" placeholder="NIK" onchange="checkNIK()"></div>
        <div class="input-row"><input type="text" id="l_nama" placeholder="NAMA" readonly></div>
        <div class="input-row"><input type="password" id="l_pass" placeholder="PASSWORD"></div>
        <button class="btn-main" style="background:var(--green); width:100%; margin-top:10px;" onclick="doLogin()">MASUK APLIKASI</button>
<div style="text-align:center; margin-top:15px;">
    <a href="javascript:void(0)" onclick="openResetModal()" style="color: #2980b9; font-size: 13px; text-decoration: none; font-weight: bold;">Update Password?</a>
</div>

    </div>
</div>

<div id="main_app" style="display:none;">
    <div class="header">POLCEK - WH MAKASSAR <br><span style="font-size: 9px; color: yellow;">V.01.02.26@ mks-bersatu</span></div>
    <div class="user-bar"><span>User: <b id="display_user">---</b></span><button class="btn-logout" onclick="doLogout()">LOGOUT</button></div>

    <div id="group_header">
        <div class="input-row"><div class="label">TGL PROSES</div><input type="date" id="p_tgl" onchange="setFocus('p_jenis')"></div>
        <div class="input-row">
            <div class="label" style="background:var(--blue)">JENIS</div>
            <select id="p_jenis" onchange="handleJenisChange()">
                <option value="">-- PILIH JENIS --</option>
                <option value="KONTAINER">KONTAINER</option>
                <option value="DOS">DOS</option>
                <option value="MANUAL">MANUAL</option>
                <option value="TAG I">TAG I</option>
                <option value="NON-LOKASI">NON-LOKASI</option>
                <option value="TELUR">TELUR</option>
                <option value="MKT">MKT</option>
                <option value="ATK GS">ATK GS</option>
                <option value="MATERAI">MATERAI</option>
            </select>
        </div>
        <div class="input-row"><div class="label">KD TOKO</div><input type="text" id="p_kode" placeholder="Scan/Ketik..." onchange="processStoreInput()"></div>
        <div class="input-row"><div class="label">NAMA TOKO</div><input type="text" id="p_nama" readonly></div>
        <div class="input-row"><div class="label">URPICK</div><input type="text" id="p_urpick" readonly></div>
        <div class="input-row"><div class="label">NO FAKTUR</div><select id="p_faktur" onchange="toggleKeScan()"><option value="">-- PILIH FAKTUR --</option></select></div>
    </div>

    <div id="group_scan" style="display:none;">
        <hr style="border: 1px solid #999; margin: 15px 0;">
        <div class="input-row" id="row_scan_label"><div class="label" style="background: var(--orange);">SCAN LABEL</div><input type="text" id="p_scan_label" placeholder="Scan Label..." onchange="validateScanLabel()"></div>
        <div id="area_fisik" style="display:none; border: 2px solid var(--red); padding: 10px; border-radius: 5px; margin-bottom: 8px;">

            <div class="input-row"><div class="label" style="background: var(--red);">SCAN FISIK</div><input type="text" id="p_scan_fisik" placeholder="Scan Barcode Produk..." onchange="validateScanFisik()"></div>
        </div>
        <div class="input-row"><div class="label">PLU</div><input type="text" id="p_plu" readonly></div>
        <div class="input-row"><div class="label">DESCP</div><input type="text" id="p_descp" readonly></div>
        <div class="input-row"><div class="label">ZONA</div><input type="text" id="p_zona" readonly></div>
        <div class="input-row"><div class="label" style="background: #2c3e50;">QTY SCAN</div><input type="number" id="p_qty_input" placeholder="0" readonly></div>
        <input type="hidden" id="p_qty_data">

<div class="footer">
            <button class="btn-main" style="background:#2ecc71" onclick="saveData()">SIMPAN</button>
            <button class="btn-main" style="background:#8e44ad" onclick="showReport()">FINAL</button>
            <button class="btn-main" style="background:#34495e" onclick="kembaliKeHeader()">HEADER</button>
            <button class="btn-main" style="background:#34495e" onclick="clearAllFields()">CLEAR</button>
            <button class="btn-main" style="background:#2c3e50; border: 1px solid yellow; color: yellow;" onclick="showMonitoring()">MONITOR</button>
            </div>
<div onclick="showAntrianModal()" class="antrian-footer">
    ðŸ“¦ KLIK LIHAT ANTRIAN: <span id="badge" style="font-weight:bold; font-size:14px;">0</span> ITEM
</div>
    </div>
        
</div> 

<div id="modal_report" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20000; overflow-y:auto; padding:10px;">
    <div style="background:white; border-radius:10px; padding:15px; min-height:100%; position: relative;">
        <button class="btn-close-modal" onclick="closeMonitoring()">Ã—</button>
        <h3 id="report_title" style="text-align:center; margin-top:0;">DATA COMPARE</h3>
        <div id="report_info" style="font-size:12px; margin-bottom:10px; border-bottom:1px solid #ccc; padding-bottom:5px;"></div>
        <div id="report_container" style="overflow-x:auto;">
            <table border="1" style="width:100%; border-collapse:collapse; font-size:11px; text-align:center;">
                <thead id="report_head">
                    <tr style="background:#eee;"><th>KONTAINER</th><th>QTY</th><th>POLCEK</th><th>STATUS</th></tr>
                </thead>
                <tbody id="report_body"></tbody>
            </table>
        </div>
        <div id="report_footer" style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-main" style="background:#34495e" onclick="closeMonitoring()">TUTUP</button>
            <button id="btn_finalisasi" class="btn-main" style="background:#27ae60" onclick="prosesFinalisasi()">FINALISASI</button>
        </div>
    </div>
</div>

<div id="modal_reset" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:30000; display:none; justify-content:center; align-items:center; padding:20px;">
    <div style="background:white; border-radius:15px; padding:20px; width:100%; max-width:350px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); position:relative;">
        <h3 style="text-align:center; color: #2c3e50; margin-top:0;">UPDATE PASSWORD</h3>
        <hr style="border:0; border-top:1px solid #eee; margin-bottom:15px;">
        
        <div style="margin-bottom: 12px;">
            <label style="font-size:12px; font-weight:bold; color:#7f8c8d;">NIK :</label>
            <input type="text" id="r_nik" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;" placeholder="Masukkan NIK">
        </div>
        <div style="margin-bottom: 12px;">
            <label style="font-size:12px; font-weight:bold; color:#7f8c8d;">PASSWORD LAMA :</label>
            <input type="password" id="r_pass_lama" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;" placeholder="******">
        </div>
        <div style="margin-bottom: 20px;">
            <label style="font-size:12px; font-weight:bold; color:#7f8c8d;">PASSWORD BARU :</label>
            <input type="password" id="r_pass_baru" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;" placeholder="******">
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="closeResetModal()" style="flex:1; background:#95a5a6; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">BATAL</button>
            <button onclick="processResetPassword()" style="flex:1; background:#2ecc71; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">SIMPAN</button>
        </div>
    </div>
</div>

<script>
history.pushState(null, null, location.href);
window.onpopstate = function() {
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    if (isLoggedIn === "true") {
        // Jika user tekan Back saat login, paksa tetap di halaman ini
        history.pushState(null, null, location.href);
        // Tampilkan peringatan kecil (Toast)
        const Toast = Swal.mixin({
            toast: true,
            position: 'top',
            showConfirmButton: false,
            timer: 2000
        });
        Toast.fire({
            icon: 'warning',
            title: 'Gunakan tombol LOGOUT untuk keluar'
        });
    }
};

// 2. Mencegah browser ditutup atau di-reload tanpa sengaja
window.onbeforeunload = function(e) {
    if (localStorage.getItem("isLoggedIn") === "true") {
        e.preventDefault();
        e.returnValue = ''; // Munculkan dialog konfirmasi browser
    }
};

const G_URL = "https://script.google.com/macros/s/AKfycbwKQHLb5lg3ebUaADolOQb9N8amhNqefAq2vmQkkh52rK3DNDhMbBSjDXWCJIV4sWU/exec";
    var dbPickAuto = [], dbMasterBarcode = [], dbManual = [], dbSudahPolcek = [];
var currentUser = "";
var CACHED_DATA = null;

    const usersDB = [
    { nik: "10030732", nama: "URIP PRADIPTA", pass: "234" },
    { nik: "21084962", nama: "BASYUDIN KADRI", pass: "234" },
    { nik: "22116378", nama: "IRWAN", pass: "234" },
    { nik: "06081095", nama: "AHMAD DJAINUDIN", pass: "234" },
    { nik: "13023500", nama: "AAN SUBHAN", pass: "234" },
    { nik: "06080176", nama: "RUDIYANTO", pass: "234" },
    { nik: "12124371", nama: "ARFA", pass: "234" },
    { nik: "15044455", nama: "ABD KADIR", pass: "234" },
    { nik: "06040353", nama: "YUSUP", pass: "234" },
    { nik: "13104668", nama: "DENADA", pass: "234" },
    { nik: "15093836", nama: "WAHYU DARUS RAMADHAN", pass: "234" },
    { nik: "11126379", nama: "ABDUL WARIS", pass: "234" },
    { nik: "15034964", nama: "SYARIF", pass: "234" },
    { nik: "15042057", nama: "FAJAR ABU THALIB", pass: "234" },
    { nik: "15042969", nama: "JUMAING", pass: "234" },
    { nik: "15052579", nama: "FIRMAN", pass: "234" },
    { nik: "15117277", nama: "ASRIADI", pass: "234" },
    { nik: "16016211", nama: "AKBAR T", pass: "234" },
    { nik: "10093059", nama: "MUSLIMIN", pass: "234" },
    { nik: "15033310", nama: "RAMLI S", pass: "234" },
    { nik: "12068137", nama: "SUWANDI", pass: "234" },
    { nik: "12067459", nama: "PATAHUDDIN", pass: "234" },
    { nik: "15112754", nama: "MUH ARHAM YUBDAL", pass: "234" },
    { nik: "13052840", nama: "JAFAR", pass: "234" },
    { nik: "20015892", nama: "ASRAN. A", pass: "234" },
    { nik: "12092687", nama: "MAULANA YUSUP", pass: "234" },
    { nik: "04060256", nama: "ABDULAH K. MUTOHAR", pass: "234" },
    { nik: "18077047", nama: "GENIAL FADILAT ARASY", pass: "234" },
    { nik: "18124171", nama: "HASTOMO", pass: "234" },
    { nik: "19015561", nama: "ADETIANI KURNIYA PRAT", pass: "234" },
    { nik: "21055244", nama: "ELOY REMBON", pass: "234" },
    { nik: "21104196", nama: "ALHANNAS", pass: "234" },
    { nik: "13013523", nama: "ANDI AHMAD", pass: "234" },
    { nik: "13013538", nama: "NASRUN B", pass: "234" },
    { nik: "19088924", density: "IBNU MUNSIR", pass: "234" },
    { nik: "19088919", nama: "MUH SABIR", pass: "234" },
    { nik: "11022706", nama: "MUH SIGIT A", pass: "234" },
    { nik: "22016350", nama: "IRWANSYAH", pass: "234" },
    { nik: "19103817", nama: "AMRI ADI", pass: "234" },
    { nik: "19103821", nama: "JOKO DWI ASTRAWAN", pass: "234" },
    { nik: "13023392", nama: "MUH ZAENAL", pass: "234" },
    { nik: "20032629", nama: "RAHMAT ZULKIFLI", pass: "234" },
    { nik: "20042761", nama: "AGUNG RAHMAT", pass: "234" },
    { nik: "21021951", nama: "NUR ANDIKA", pass: "234" },
    { nik: "20123889", nama: "SADDAM HUSAIN", pass: "234" },
    { nik: "22067161", nama: "ABD RAHMAN", pass: "234" },
    { nik: "21041579", nama: "MUHAMMAD RIJAL", pass: "234" },
    { nik: "13063625", nama: "MOCH. NURCAHYO Y.", pass: "234" },
    { nik: "21082748", nama: "NASRULLAH", pass: "234" },
    { nik: "13071183", nama: "HAKIM", pass: "234" },
    { nik: "13074665", nama: "ABDUL KHAIR", pass: "234" },
    { nik: "07060205", nama: "YUSUP ISKANDAR", pass: "234" },
    { nik: "11084748", nama: "MUH.HAEDIR", pass: "234" },
    { nik: "11085162", nama: "NUR AMAL", pass: "234" },
    { nik: "14032387", nama: "MUHAMAD FURQON", pass: "234" },
    { nik: "11095305", nama: "AHMAD", pass: "234" },
    { nik: "09040248", nama: "DICKI ISKANDAR ZULKAR", pass: "234" },
    { nik: "11095472", nama: "SYARIFUDDIN", pass: "234" },
    { nik: "14066101", nama: "MUH NUR", pass: "234" },
    { nik: "11124107", nama: "MUHAMMAD AMIR", pass: "234" },
    { nik: "12015655", nama: "AHMAD JUNAEDI", pass: "234" },
    { nik: "12021938", nama: "ALI NURHIDIN", pass: "234" },
    { nik: "01020239", nama: "ASBAR", pass: "234" },
    { nik: "19106316", nama: "TAUFIK HIDAYAT AMIN", pass: "234" },
    { nik: "14022759", nama: "MUHIDDIN", pass: "234" },
    { nik: "21091494", nama: "ARLAN", pass: "234" },
    { nik: "18012062", nama: "M. MIFTAHUL MUNIF", pass: "234" },
    { nik: "19032172", nama: "SUPRIADI", pass: "234" },
    { nik: "19085644", nama: "ABDUL JALIL", pass: "234" },
    { nik: "21126790", nama: "HAERUL", pass: "234" },
    { nik: "20121101", nama: "AHMAD TAUFIQ. L", pass: "234" },
    { nik: "20121097", nama: "MUH. ALIF FAJRING", pass: "234" },
    { nik: "11084798", nama: "RIZKI", pass: "234" },
    { nik: "03030112", nama: "IRWAN", pass: "234" },
    { nik: "01060319", nama: "BASUKI", pass: "234" },
    { nik: "10062381", nama: "REZKA SURYANTO", pass: "234" },
    { nik: "08081171", nama: "LINGGA OKTA", pass: "234" }
];

    async function initApp() {
const isLoggedIn = localStorage.getItem("isLoggedIn");
    
if (isLoggedIn === "true") {
        currentUser = localStorage.getItem("loggedUser");
        document.getElementById('display_user').innerText = currentUser;
        document.getElementById('login_screen').style.display = 'none';
        document.getElementById('main_app').style.display = 'block';
    }  
updateBadge();
  const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'flex';

    try {
        const res = await fetch(G_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: "getAllData" }),
            // Tambahkan mode cors jika perlu
            mode: 'cors'
        });
        
        if (!res.ok) throw new Error("Server bermasalah");
        
        const out = await res.json();
        
 if (out && out.status === "success") {
    dbPickAuto = out.pickAuto || [];
    dbMasterBarcode = out.masterBarcode || [];
    dbManual = out.dataManual || [];
    
    // Pastikan barcode ikut ditarik di sini juga
    dbSudahPolcek = (out.dataSudahPolcek || []).map(r => ({
        tgl: String(r.tgl).substring(0, 10),
        kode: String(r.kode).trim().toUpperCase(),
        jenis: String(r.jenis).trim().toUpperCase(),
        barcode: String(r.barcode || "").trim().toUpperCase(), 
        qty_scan: Number(r.qty_scan) || 0
    }));

            // Simpan ke memory fisik HP
            localStorage.setItem("db_pick_auto", JSON.stringify(dbPickAuto));
            localStorage.setItem("db_master_barcode", JSON.stringify(dbMasterBarcode));
            localStorage.setItem("db_manual", JSON.stringify(dbManual));
            localStorage.setItem("db_sudah_polcek", JSON.stringify(dbSudahPolcek));

            console.log("Data Berhasil Dimuat. Jumlah Data Scan:", dbSudahPolcek.length);
        }
    } catch (e) {
        console.error("Koneksi Error:", e);
        // Jika koneksi reset, ambil data terakhir dari memory HP agar monitoring tidak kosong
        dbSudahPolcek = JSON.parse(localStorage.getItem("db_sudah_polcek") || "[]");
        dbPickAuto = JSON.parse(localStorage.getItem("db_pick_auto") || "[]");
        
        Swal.fire("Koneksi Lemah", "Gagal mengambil data terbaru dari server. Menampilkan data lokal terakhir.", "warning");
    } finally {
        if (loader) loader.style.display = 'none';
        document.getElementById('p_tgl').valueAsDate = new Date();
        updateBadge();
    }
}

    async function loadInitialData(force = false) {
        if (CACHED_DATA && !force) return CACHED_DATA;
        try {
            // Menggunakan POST agar konsisten dengan Apps Script doPost(e)
            const res = await fetch(G_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "getAllData" }) 
            });
            CACHED_DATA = await res.json();
            return CACHED_DATA;
        } catch (e) {
            console.error("Gagal sinkron server:", e);
            // Fallback ke LocalStorage jika gagal fetch
            const local = localStorage.getItem("cache_master");
            if(local) {
                CACHED_DATA = JSON.parse(local);
                return CACHED_DATA;
            }
            return null;
        }
    }

    // ==========================================
    // AUTHENTICATION FUNCTIONS
    // ==========================================
    function checkNIK() {
        const nikInput = document.getElementById('l_nik').value;
        const user = usersDB.find(u => u.nik === nikInput);
        if (user) {
            document.getElementById('l_nama').value = user.nama;
            setFocus('l_pass');
        } else {
            document.getElementById('l_nama').value = "";
            Swal.fire("Error", "NIK Tidak Terdaftar!", "error");
        }
    }

function doLogin() {
    const nik = document.getElementById('l_nik').value;
    const pass = document.getElementById('l_pass').value;
    const user = usersDB.find(u => u.nik === nik && u.pass === pass);
    
    if (user) {
        aktifkanFullScreen();
        localStorage.setItem("isLoggedIn", "true");
        localStorage.setItem("loggedUser", user.nama);
        
        document.getElementById('login_screen').style.display = 'none';
        document.getElementById('main_app').style.display = 'block';
        document.getElementById('display_user').innerText = user.nama;
        
        history.pushState(null, null, location.href);
        initApp(); 
    } else {
        // --- UPDATE DI SINI ---
        // Pastikan loader ditutup jika user salah input agar tidak menghalangi modal error
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'none';

        Swal.fire({ 
            title: "Gagal", 
            text: "Kombinasi NIK dan Password Salah", 
            icon: "error",
            confirmButtonColor: '#c0392b',
            // Memaksa z-index di tingkat script (opsional tapi ampuh)
            didOpen: () => {
                Swal.getContainer().style.zIndex = "100000";
            }
        });
    }
}

function aktifkanFullScreen() {
    let doc = window.document;
    let docEl = doc.documentElement;

    let requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
    
    if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
        requestFullScreen.call(docEl);
    }
}

    function doLogout() {
    Swal.fire({
        title: "Logout?",
        text: "Anda akan keluar dari sesi kerja ini.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        confirmButtonText: "Ya, Keluar"
    }).then((result) => {
        if (result.isConfirmed) {
            // Hapus semua kunci login
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("loggedUser");
            
            // Kembalikan tampilan
            document.getElementById('main_app').style.display = 'none';
            document.getElementById('login_screen').style.display = 'block';
            
            // Opsional: Bersihkan form login
            document.getElementById('l_nik').value = "";
            document.getElementById('l_pass').value = "";
            document.getElementById('l_nama').value = "";
        }
    });
}

    // ==========================================
    // TRANSACTION LOGIC (SCAN & FILTER)
    // ==========================================
    function handleJenisChange() {
    const jenis = document.getElementById('p_jenis').value;
    
    // 1. Definisikan area scan yang butuh label/fisik
    const butuhScan = ["KONTAINER", "DOS", "MANUAL", "TAG I"];
    const rowScan = document.getElementById('row_scan_label');
    if(rowScan) rowScan.style.display = butuhScan.includes(jenis) ? 'flex' : 'none';

    // 2. KOSONGKAN SEMUA KOLOM (Point 8: Semua kontainer dikosongkan)
    // Kecuali Tanggal dan Jenis itu sendiri
    const idsToClear = ['p_kode', 'p_nama', 'p_urpick', 'p_scan_label', 'p_scan_fisik', 'p_plu', 'p_descp', 'p_zona', 'p_qty_input', 'p_qty_data'];
    idsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
    });

    // Reset dropdown faktur ke default
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';

    // Reset area fisik dan qty read-only
    document.getElementById('area_fisik').style.display = 'none';
    const qtyInp = document.getElementById('p_qty_input');
    qtyInp.readOnly = true;
    qtyInp.style.background = "#dcdcdc";

    // 3. FOKUS KURSOR KEMBALI KE KODE TOKO (Point 8)
    if (jenis !== "") {
        console.log("Jenis berubah ke " + jenis + ", kursor ke Kode Toko");
        setFocus('p_kode');
    }
}

    function runFilter() {
    const tglRaw = document.getElementById('p_tgl').value;
    const jenis = document.getElementById('p_jenis').value;
    const kode = document.getElementById('p_kode').value.trim().toUpperCase();
    const fSelect = document.getElementById('p_faktur');
    
    if (!tglRaw || !kode || !jenis) return false;

    // Format tanggal untuk pencarian
    const d = new Date(tglRaw);
    const tglCheck = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
    
    // Pilih database berdasarkan jenis
    const currentDB = (jenis === "MANUAL") ? dbManual : dbPickAuto;

    // Cari data yang cocok
    const filtered = currentDB.filter(item => {
        return item.tglInput === tglCheck && item.kodeToko === kode;
    });

    if (filtered.length > 0) {
        // Isi Nama Toko dan Urpick secara otomatis
        document.getElementById('p_nama').value = filtered[0].namaToko;
        document.getElementById('p_urpick').value = filtered[0].urpick;

        // Isi Dropdown Faktur
        fSelect.innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
        const uniqueFakturs = [...new Set(filtered.map(i => i.faktur))];
        uniqueFakturs.forEach(f => { 
            fSelect.innerHTML += `<option value="${f}">${f}</option>`; 
        });
        
        return true; // Data ditemukan
    } else {
        // Reset jika tidak ketemu
        document.getElementById('p_nama').value = "";
        document.getElementById('p_urpick').value = "";
        fSelect.innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
        return false; // Data tidak ditemukan
    }
}

function validateScanLabel() {
    // Ambil nilai asli
    let rawScanVal = document.getElementById('p_scan_label').value;
    
    // BERSIHKAN SPASI: Menghapus spasi di awal, akhir, dan di TENGAH (misal: "A- B" jadi "A-B")
    const scanVal = rawScanVal.replace(/\s+/g, '').toUpperCase().trim();
    
    // Update tampilan input agar user melihat data yang sudah bersih
    document.getElementById('p_scan_label').value = scanVal;

    const jenisVal = document.getElementById('p_jenis').value;
    const fakturVal = document.getElementById('p_faktur').value;
    const tglPilih = document.getElementById('p_tgl').value;
    const kodeToko = document.getElementById('p_kode').value.toUpperCase();

    if (!scanVal) return;

    // --- VALIDASI FINAL SERVER ---
    const sudahFinalDiServer = dbSudahPolcek.some(s => 
        s.tgl === tglPilih && s.kode === kodeToko && s.jenis === jenisVal
    );
    if (sudahFinalDiServer) {
        document.getElementById('p_scan_label').value = "";
        return Swal.fire({ icon: 'error', title: 'Akses Ditolak', text: `Toko ${kodeToko} sudah Final.` });
    }

    // Split parts menggunakan data yang sudah bersih dari spasi
    const parts = scanVal.split('-').filter(Boolean);

    if (jenisVal === "KONTAINER") {
        // parts[0] = A0001 (No Kontainer)
        // parts[1] = R665  (Kode Toko dari Label)
        const noKontainerLabel = parts[0] ? parts[0].toUpperCase() : "";
        const kodeTokoLabel = parts[1] ? parts[1].toUpperCase() : "";

        // 1. VALIDASI KODE TOKO
        if (kodeTokoLabel !== kodeToko) {
            document.getElementById('p_scan_label').value = "";
            if (typeof playError === "function") playError(); 
            return Swal.fire({
                icon: 'error',
                title: 'SALAH TOKO!',
                text: `Label ini untuk Toko ${kodeTokoLabel}, sedangkan Anda sedang memproses Toko ${kodeToko}`
            });
        }

        // 2. VALIDASI DOUBLE SCAN
        let antrian = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        if (antrian.some(item => item.barcode.toUpperCase().includes(noKontainerLabel) && item.kode === kodeToko && item.faktur === fakturVal)) {
            document.getElementById('p_scan_label').value = "";
            if (typeof playError === "function") playError();
            return notify("âš ï¸ SUDAH SCAN KOLI TERSEBUT!", "error", "p_scan_label");
        }

        // 3. VALIDASI NO KONTAINER KE DATA PICK AUTO
        const match = dbPickAuto.find(i => 
            i.faktur === fakturVal && 
            i.kodeToko === kodeToko && 
            (i.kontainer || "").toUpperCase() === noKontainerLabel
        );

        if (match) { 
            fillData(match); 
            document.getElementById('p_qty_input').value = 1; 
            document.getElementById('p_qty_input').readOnly = false;
            
            const elBarcode = document.getElementById('p_barcode');
            if (elBarcode) elBarcode.value = scanVal; 

            // --- LOGIKA AUTO SAVE ---
            setTimeout(() => {
                saveData(); 
                document.getElementById('p_scan_label').value = "";
                document.getElementById('p_scan_label').focus();
            }, 300);
        } else { 
            if (typeof playError === "function") playError();
            notify("âš ï¸ NO KONTAINER TIDAK ADA DI DATA!", "error", "p_scan_label"); 
            document.getElementById('p_scan_label').value = ""; 
        }

    } else if (jenisVal === "DOS" || jenisVal === "MANUAL") {
        if (jenisVal === "DOS") {
            const tokoLabel = parts[2] ? parts[2].toUpperCase() : "";
            const pluLabel = parts[3];

            if (tokoLabel !== kodeToko) {
                if (typeof playError === "function") playError(); 
                document.getElementById('p_scan_label').value = "";
                return Swal.fire({
                    icon: 'error',
                    title: 'DOS SALAH TOKO!',
                    text: `Label DOS milik Toko ${tokoLabel}, bukan Toko ${kodeToko}`
                });
            }

            const match = dbPickAuto.find(i => 
                i.faktur === fakturVal && 
                i.kodeToko === kodeToko && 
                String(i.plu) === String(pluLabel)
            );

            if (match) {
                fillData(match);
                document.getElementById('p_qty_input').value = ""; 
                document.getElementById('p_qty_input').readOnly = true; 
                document.getElementById('p_qty_input').style.background = "#eeeeee";
                document.getElementById('area_fisik').style.display = 'block';
                setTimeout(() => { document.getElementById('p_scan_fisik').focus(); }, 300);
            } else {
                if (typeof playError === "function") playError();
                notify("âš ï¸ PLU TIDAK ADA DI MASTER PICKING!", "error", "p_scan_label");
                document.getElementById('p_scan_label').value = "";
            }

        } else if (jenisVal === "MANUAL") {
            const prefixFaktur = parts[0] ? parts[0].toUpperCase() : ""; 
            const nomorFaktur  = parts[1] ? parts[1].toUpperCase() : ""; 
            const fakturLabel  = `${prefixFaktur}-${nomorFaktur}`; 
            const pluLabel = parts[2]; 

            if (fakturLabel !== fakturVal.toUpperCase()) {
                if (typeof playError === "function") playError();
                document.getElementById('p_scan_label').value = "";
                return Swal.fire({
                    icon: 'error',
                    title: 'FAKTUR BERBEDA!',
                    text: `Label: ${fakturLabel}\nAktif: ${fakturVal}`
                });
            }

            const match = dbManual.find(i => 
                i.faktur === fakturVal && 
                String(i.plu) === String(pluLabel)
            );

            if (match) {
                fillData(match);
                document.getElementById('p_qty_input').value = "";
                document.getElementById('p_qty_input').readOnly = true;
                document.getElementById('p_qty_input').style.background = "#eeeeee";
                document.getElementById('area_fisik').style.display = 'block';
                setTimeout(() => { 
                    document.getElementById('p_scan_fisik').value = "";
                    document.getElementById('p_scan_fisik').focus(); 
                }, 300);
            } else {
                if (typeof playError === "function") playError();
                notify(`âš ï¸ PLU ${pluLabel} TIDAK ADA DI DATA MANUAL FAKTUR INI!`, "error", "p_scan_label");
                document.getElementById('p_scan_label').value = "";
            }
        }

    } else if (jenisVal === "TAG I") {
        document.getElementById('p_plu').value = "TAG-I";
        document.getElementById('p_descp').value = "RECORD SCAN TAG I";
        document.getElementById('p_qty_input').readOnly = false;
        document.getElementById('p_qty_input').style.background = "white";
        setFocus('p_qty_input');
    }
}

function validateScanFisik() {
    const scanFisik = document.getElementById('p_scan_fisik').value.trim();
    const pluTarget = String(document.getElementById('p_plu').value).trim();
    const qtyInp = document.getElementById('p_qty_input');

    if (!scanFisik) return;
    if (!pluTarget || pluTarget === "-") {
        if (typeof playError === "function") playError();
        return notify("âš ï¸ SCAN LABEL DULU!", "error", "p_scan_label");
    }

    // Cari kecocokan di master barcode
    const match = dbMasterBarcode.find(m => 
        (scanFisik === String(m.barcodeDos).trim() || scanFisik === String(m.barcodeItem).trim()) 
        && String(m.plu).trim() === pluTarget
    );

    if (match) {
        // Tambah Qty otomatis
        let currentQty = parseInt(qtyInp.value) || 0;
        qtyInp.value = currentQty + 1; 
        
        // --- KUNCIAN MATI ---
        qtyInp.readOnly = true; 
        qtyInp.style.background = "#eeeeee"; // Warna abu-abu (tanda terkunci)
        qtyInp.style.color = "#000"; // Pastikan angka tetap jelas terbaca

        // Reset input scan fisik untuk barang berikutnya
        document.getElementById('p_scan_fisik').value = ""; 
        document.getElementById('p_scan_fisik').focus(); 
        
        // Opsional: Bunyi beep pendek tanda scan berhasil
        // playSuccessBeep(); 
    } else {
        if (typeof playError === "function") playError();
        notify("âš ï¸ FISIK SALAH / PLU TIDAK SESUAI!", "error", "p_scan_fisik");
        document.getElementById('p_scan_fisik').value = "";
    }
}
    function fillData(m) {
        const jenis = document.getElementById('p_jenis').value;
        const faktur = document.getElementById('p_faktur').value;
        const kodeToko = document.getElementById('p_kode').value.toUpperCase();
        document.getElementById('p_plu').value = m.plu || "-";
        document.getElementById('p_descp').value = m.descp || "-";
        document.getElementById('p_zona').value = m.zona || "-";
        let totalTargetToko = 0;
        const currentDB = (jenis === "MANUAL") ? dbManual : dbPickAuto;
        currentDB.forEach(item => { if (item.faktur === faktur && item.kodeToko === kodeToko && item.plu === m.plu) totalTargetToko += parseInt(item.qtyData || 0); });
        if (jenis === "KONTAINER") totalTargetToko = 1;
        document.getElementById('p_qty_data').value = totalTargetToko;
    }

async function saveData() {

    const qtyInp = document.getElementById('p_qty_input');
    const jenis = document.getElementById('p_jenis').value;
    const kodeToko = document.getElementById('p_kode').value.toUpperCase();
    const fakturVal = document.getElementById('p_faktur').value;
    
    if (!qtyInp.value || qtyInp.value <= 0) return notify("Isi Qty!", "error", "p_qty_input");

    const kelompokNonScan = ["NON-LOKASI","TELUR", "MKT", "ATK GS", "MATERAI"];
   updateBadge(); 
    // Jika masuk kelompok NON-SCAN, langsung kirim ke server (Point 9)
    if (kelompokNonScan.includes(jenis)) {
        const dataLangsung = [{
            tgl: document.getElementById('p_tgl').value,
            jenis: jenis,
            kode: kodeToko,
            nama: document.getElementById('p_nama').value,
            urpick: document.getElementById('p_urpick').value,
            faktur: fakturVal,
            zona: document.getElementById('p_zona').value || "-",
            barcode: "NON-SCAN",
            plu: document.getElementById('p_plu').value || "MANUAL",
            descp: document.getElementById('p_descp').value || "-",
            qty_data: 0,
            qty_scan: parseInt(qtyInp.value),
            petugas: currentUser
        }];

        await kirimDataLangsung(dataLangsung);
    } else {
        // Alur Biasa (DOS, MANUAL, KONTAINER) simpan ke LocalStorage dulu
        let q = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        q.push({
            tgl: document.getElementById('p_tgl').value,
            jenis: jenis,
            kode: kodeToko,
            nama: document.getElementById('p_nama').value,
            urpick: document.getElementById('p_urpick').value,
            faktur: fakturVal,
            zona: document.getElementById('p_zona').value,
            barcode: document.getElementById('p_scan_label').value,
            plu: document.getElementById('p_plu').value,
            descp: document.getElementById('p_descp').value,
            qty_data: parseInt(document.getElementById('p_qty_data').value || 0),
            qty_scan: parseInt(qtyInp.value),
            petugas: currentUser
        });
        localStorage.setItem('q_polcek', JSON.stringify(q));
        updateBadge();
        afterSaveFocus(jenis);
    }
}

// Fungsi pembantu untuk kirim data kelompok Non-Scan
async function kirimDataLangsung(data) {
    const loader = document.getElementById('loader');
    loader.style.display = 'flex'; // Loader jalan
    
    try {
        const res = await fetch(G_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: "syncBatch", data: data }) 
        });
        const out = await res.json();
        
        // POINT 10: TUTUP LOADER DULU SEBELUM POP-UP BERHASIL
        loader.style.display = 'none'; 
        
        if (out.status === "success") {
            await Swal.fire("Berhasil", "Data Non-Scan Terkirim!", "success");
            clearAllFieldsInternal(); // Reset semua kolom (Point 9)
        }
    } catch (e) {
        loader.style.display = 'none';
        Swal.fire("Gagal", "Cek Koneksi Server", "error");
    }
}

function afterSaveFocus(jenis) {
    const kelompokNonScan = ["NON-LOKASI","TELUR", "MKT", "ATK GS", "MATERAI"];

    // 1. Reset field input (Point 9)
    ['p_scan_label','p_scan_fisik','p_plu','p_descp','p_zona','p_qty_input','p_qty_data'].forEach(id => {
        if(document.getElementById(id)) document.getElementById(id).value = "";
    });

    if (kelompokNonScan.includes(jenis)) {
        // KHUSUS BARANG INI: Reset Dropdown Jenis ke default & Fokus ke Jenis
        document.getElementById('p_jenis').value = ""; 
        setFocus('p_jenis');
    } else {
        // DOS, MANUAL, KONTAINER, TAG I -> Tetap di Jenis yang sama, tapi Fokus ke Scan Label
        setFocus('p_scan_label');
    }
    
    document.getElementById('area_fisik').style.display = 'none';
    const qtyInp = document.getElementById('p_qty_input');
    qtyInp.readOnly = true; 
    qtyInp.style.background = "#dcdcdc";
}

    async function prosesFinalisasi() {
    const jenisAktif = document.getElementById('p_jenis').value;
    const fakturAktif = document.getElementById('p_faktur').value;
    const kodeAktif = document.getElementById('p_kode').value;

    document.getElementById('modal_report').style.display = 'none';

    const { isConfirmed } = await Swal.fire({ 
        title: 'Kirim Data?', 
        icon: 'question', 
        showCancelButton: true 
    });

    if (isConfirmed) {
        const loader = document.getElementById('loader');
        loader.style.display = 'flex'; 

        try {
            let allLocalData = JSON.parse(localStorage.getItem('q_polcek') || "[]");
            const dataToSend = allLocalData.filter(i => i.jenis === jenisAktif && i.faktur === fakturAktif && i.kode === kodeAktif);

     const res = await fetch(G_URL, { method: 'POST', body: JSON.stringify({ action: "syncBatch", data: dataToSend }) });
const out = await res.json();
    
    // POINT 10: PASTIKAN LOADER HILANG DI SINI
    loader.style.display = 'none'; 

    if (out.status === "success") {
        const sisaData = allLocalData.filter(i => !(i.jenis === jenisAktif && i.faktur === fakturAktif && i.kode === kodeAktif));
        localStorage.setItem('q_polcek', JSON.stringify(sisaData));
        updateBadge();

        // --- TAMBAHKAN DI SINI (SEBELUM SWAL) ---
        // Update cache lokal supaya Monitoring Real-time (Point 2)
        dataToSend.forEach(d => dbSudahPolcek.push(d)); 
        localStorage.setItem("db_sudah_polcek", JSON.stringify(dbSudahPolcek));
        // ----------------------------------------

        await Swal.fire("Berhasil", "Data Terkirim!", "success");
        clearAllFieldsInternal(); // Reset total
    }

        } catch (e) { 
            loader.style.display = 'none';
            Swal.fire("Gagal", "Koneksi Terputus", "error"); 
            document.getElementById('modal_report').style.display = 'block';
        }
    } else {
        document.getElementById('modal_report').style.display = 'block';
    }
}

function clearAllFieldsInternal() {
    // Kosongkan Jenis (kembali ke --PILIH JENIS--)
    document.getElementById('p_jenis').value = "";
    // Kosongkan semua field input
    const ids = ['p_kode','p_nama','p_urpick','p_faktur','p_scan_label','p_scan_fisik','p_plu','p_descp','p_zona','p_qty_input','p_qty_data'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            if(el.tagName === "SELECT") el.innerHTML = '<option value="">-- PILIH --</option>';
            else el.value = "";
        }
    });
    // Fokus ke Jenis sesuai permintaan point 9
    setFocus('p_jenis');
}

    // ==========================================
    // UI HELPER & MONITORING
    // ==========================================
    function setFocus(id) {
        setTimeout(() => {
            const el = document.getElementById(id);
            if (el) { el.focus(); if (typeof el.select === 'function') el.select(); }
        }, 350);
    }

    function notify(msg, type = 'success', nextId = 'p_scan_label') {
        Swal.fire({ title: msg, icon: type, timer: 1500, showConfirmButton: false, didClose: () => { setFocus(nextId); }});
    }

    function updateBadge() {
    try {
        const scanDB = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        const badgeEl = document.getElementById('badge');
        if (badgeEl) {
            badgeEl.innerText = scanDB.length;
        }
    } catch (e) {
        console.error("Gagal update badge", e);
    }
}

    function focusToNext() {
        resetScanField();
        const jenis = document.getElementById('p_jenis').value;
        if (["KONTAINER", "DOS", "MANUAL", "TAG I"].includes(jenis)) {
            setFocus('p_scan_label');
        } else {
            const qtyInp = document.getElementById('p_qty_input');
            qtyInp.readOnly = false; qtyInp.style.background = "white";
            document.getElementById('p_scan_label').value = "NON-SCAN";
            setFocus('p_qty_input');
        }
    }

    function clearAllFields() {
    // 1. Kosongkan semua ID input
    const idsToClear = [
        'p_kode', 'p_nama', 'p_urpick', 
        'p_scan_label', 'p_scan_fisik', 'p_plu', 
        'p_descp', 'p_zona', 'p_qty_input', 'p_qty_data'
    ];

    updateBadge();
    idsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
    });

    // 2. Reset Pilihan Dropdown
    const pJenis = document.getElementById('p_jenis');
    if (pJenis) pJenis.value = ""; 

    const pFaktur = document.getElementById('p_faktur');
    if (pFaktur) pFaktur.innerHTML = '<option value="">-- PILIH FAKTUR --</option>';

    // 3. Sembunyikan Area Fisik
    const areaFisik = document.getElementById('area_fisik');
    if (areaFisik) areaFisik.style.display = 'none';

    // 4. PINDAH LAYAR: Tampilkan Header, Sembunyikan Scan
    document.getElementById('group_header').style.display = 'block';
    document.getElementById('group_scan').style.display = 'none';

    // 5. FOKUS KURSOR KEMBALI KE JENIS
    setTimeout(() => {
        const inputJenis = document.getElementById('p_jenis');
        if (inputJenis) inputJenis.focus();
    }, 200);

    console.log("Form dibersihkan, kembali ke pemilihan Jenis.");
}

function showMonitoring() {
    const tglRaw = document.getElementById('p_tgl').value;
    if (!tglRaw) {
        Swal.fire("Pilih Tanggal", "Tentukan tanggal proses", "warning");
        return;
    }

document.getElementById('monitor_date').innerHTML = `TANGGAL PROSES: <span style="color: #2980b9;">${tglRaw}</span>`;

    const clean = v => String(v || "").trim().toUpperCase();
    const tglTarget = tglRaw.substring(0, 10);

    let monitorMap = {};

    /* ============================================================
       1ï¸âƒ£ TARGET â†’ DARI MASTER (PICK AUTO + MANUAL)
       ============================================================ */

    const masterData = [
        ...dbPickAuto.map(d => ({ ...d, src: 'PA' })),
        ...dbManual.map(d => ({ ...d, src: 'MN' }))
    ];

    masterData.forEach(item => {
        if (clean(item.tglInput) !== tglTarget) return;

        const kode = clean(item.kodeToko);
        if (!kode) return;

        // ðŸ”§ INISIALISASI TARGET
        if (!monitorMap[kode]) {
            monitorMap[kode] = {
                urpick: item.urpick || "",
                kode: kode,
                tKN: 0, tDS: 0, tMN: 0,
                sKN: 0, sDS: 0, sMN: 0
            };
        }

        // HITUNG TARGET
        if (item.src === 'MN') {
            monitorMap[kode].tMN += parseInt(item.qtyData || 0);
        } else {
            const kont = clean(item.kontainer);
            if (kont.startsWith("DOS")) {
                monitorMap[kode].tDS += parseInt(item.qtyData || 0);
            } else if (kont !== "") {
                monitorMap[kode].tKN += 1;
            }
        }
    });

    /* ============================================================
       2ï¸âƒ£ REALISASI â†’ DARI DATA POLCEK (SCAN)
       â— INI BAGIAN KRITIS YANG DIPERBAIKI
       ============================================================ */

    if (!Array.isArray(dbSudahPolcek) || dbSudahPolcek.length === 0) {
        Swal.fire("Monitoring Kosong", "Data scan belum tersedia", "warning");
        return;
    }

    dbSudahPolcek.forEach(s => {
        const tglScan = clean(s.tgl).substring(0, 10);
        if (tglScan !== tglTarget) return;

        const kode = clean(s.kode);
        const jenis = clean(s.jenis);
        const qty  = parseInt(s.qty_scan || 0);

        if (!kode || qty <= 0) return;

        // ðŸ”¥ PERBAIKAN UTAMA
        // Scan TIDAK BOLEH bergantung ke TARGET
        if (!monitorMap[kode]) {
            monitorMap[kode] = {
                urpick: "",
                kode: kode,
                tKN: 0, tDS: 0, tMN: 0,
                sKN: 0, sDS: 0, sMN: 0
            };
        }

        // HITUNG REALISASI
        if (jenis === "KONTAINER") monitorMap[kode].sKN += qty;
        else if (jenis === "DOS") monitorMap[kode].sDS += qty;
        else if (jenis === "MANUAL") monitorMap[kode].sMN += qty;
    });

    console.log("HASIL MONITORING FINAL:", monitorMap);

    renderMonitorTable(monitorMap);
    document.getElementById('modal_monitor').style.display = 'block';

}


function renderMonitorTable(dataMap) {
    const container = document.getElementById('monitor_content');
    let html = `<table class="table-monitor">
        <thead>
            <tr>
                <th>URPICK</th>
                <th>TOKO</th>
                <th>KN (T/S)</th>
                <th>DS (T/S)</th>
                <th>MN (T/S)</th>
                <th>STATUS</th>
            </tr>
        </thead>
        <tbody>`;

    Object.values(dataMap).forEach(d => {
        const isMatch = (d.tKN === d.sKN) && (d.tDS === d.sDS) && (d.tMN === d.sMN);
        
        // Fungsi pembantu untuk memberi warna merah jika belum match
        const formatTS = (t, s) => `<span style="color: ${t === s ? 'black' : 'red'}">${t}/${s}</span>`;

        html += `
            <tr>
                <td>${d.urpick}</td>
                <td style="text-align:left">${d.kode}</td>
                <td>${formatTS(d.tKN, d.sKN)}</td>
                <td>${formatTS(d.tDS, d.sDS)}</td>
                <td>${formatTS(d.tMN, d.sMN)}</td>
                <td>${isMatch ? "âœ…" : "â³"}</td>
            </tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}

    function closeMonitoring() {
        document.getElementById('modal_report').style.display = 'none';
        document.getElementById('report_head').style.display = ''; 
        document.getElementById('btn_finalisasi').style.display = 'block';
        document.getElementById('report_title').innerText = "DATA COMPARE";
    }

    async function revisiQty(key, barcode) {
    // 1. Tutup modal utama (Point 11)
    document.getElementById('modal_report').style.display = 'none';

    // 2. Minta OTP
    const { value: otp } = await Swal.fire({ 
        title: 'Minta OTP', 
        input: 'password', 
        inputLabel: 'Masukkan PIN Revisi', 
        showCancelButton: true 
    });

    if (otp === "234") {
        // 3. Input Qty Baru
        const { value: newQty } = await Swal.fire({ 
            title: 'Input Qty Baru', 
            input: 'number', 
            showCancelButton: true 
        });

        if (newQty !== null && newQty !== "") {
            let allData = JSON.parse(localStorage.getItem('q_polcek') || "[]");
            // Cari data berdasarkan barcode atau PLU
            const idx = allData.findIndex(i => 
                i.kode === document.getElementById('p_kode').value && 
                (i.barcode === barcode || i.plu === barcode || i.barcode.includes(barcode))
            );
            
            if (idx !== -1) { 
                allData[idx].qty_scan = parseInt(newQty); 
                localStorage.setItem('q_polcek', JSON.stringify(allData));
                
                // Notifikasi sukses sebelum balik ke modal
                await Swal.fire({ title: "Berhasil", text: "Qty Diperbarui", icon: "success", timer: 1000, showConfirmButton: false });
            }
        }
    } else if (otp !== undefined) {
        await Swal.fire("Error", "OTP Salah!", "error");
    }

    // 4. Otomatis kembali ke layar modal final (Point 11)
    showReport(); 
}

    function showReport() {
    const tglRaw = document.getElementById('p_tgl').value;
    const kode = document.getElementById('p_kode').value.trim().toUpperCase();
    const jenis = document.getElementById('p_jenis').value;
    const faktur = document.getElementById('p_faktur').value;
    if (!tglRaw || !kode || !faktur) return Swal.fire("Peringatan", "Lengkapi data Toko dan Faktur!", "warning");

    const scanDB = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    const aktualData = scanDB.filter(i => i.tgl === tglRaw && i.kode === kode && i.faktur === faktur && i.jenis === jenis);

    const d = new Date(tglRaw);
    const tglCheck = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
    
    let reportMap = {};
    let isAllMatch = true; // Akan tetap true jika semua "DONE"
    let isComparisonType = ["KONTAINER", "DOS", "MANUAL"].includes(jenis);

    if (isComparisonType) {
        const currentDB = (jenis === "MANUAL") ? dbManual : dbPickAuto;
        const targetData = currentDB.filter(i => {
            if (!(i.tglInput === tglCheck && i.kodeToko === kode && i.faktur === faktur)) return false;
            const kVal = (i.kontainer || "").toUpperCase();
            const isD = kVal.includes("DOS");
            return jenis === "KONTAINER" ? !isD : (jenis === "DOS" ? isD : true);
        });

        targetData.forEach(item => {
            const kMaster = (item.kontainer || "MANUAL").toUpperCase();
            let key = (jenis === "KONTAINER") ? kMaster : (jenis === "DOS" ? `${kMaster} | ${item.plu}` : item.plu);
            if (!reportMap[key]) reportMap[key] = { desc: (jenis === "KONTAINER") ? "" : (item.descp || kMaster), target: 0, scan: 0 };
            reportMap[key].target += (jenis === "KONTAINER") ? 1 : parseInt(item.qtyData || 0);
        });

        aktualData.forEach(item => {
            const parts = (item.barcode || "").split('-').filter(Boolean);
            let keyScan = (jenis === "KONTAINER") ? parts[0].toUpperCase() : (jenis === "DOS" ? `${parts[0]}-${parts[1]} | ${item.plu}`.toUpperCase() : (parts[parts.length - 1] || item.plu));
            if (reportMap[keyScan]) reportMap[keyScan].scan += parseInt(item.qty_scan || 0);
            else reportMap[keyScan] = { desc: item.descp || "OVER", target: 0, scan: parseInt(item.qty_scan || 0) };
        });
    } else {
        aktualData.forEach(item => {
            const key = item.barcode || item.plu || "ITEM";
            reportMap[key] = { desc: item.descp || "DATA INPUT", target: "N/A", scan: parseInt(item.qty_scan || 0) };
        });
    }

    let html = "";
    Object.keys(reportMap).forEach(key => {
        const r = reportMap[key];
        
        // AMBIL DATA DARI LOCALSTORAGE UNTUK CEK APAKAH SUDAH ADA KETERANGAN PAKSA FINAL
        // Kita cari apakah ada item di aktualData yang punya keterangan untuk PLU/Key ini
        const itemPunyaKet = aktualData.find(i => 
            (i.plu === key || i.barcode && i.barcode.includes(key) || (key.includes(' | ') && i.plu === key.split(' | ')[1]))
            && i.keterangan && i.keterangan !== ""
        );

        let status;
        if (r.target === "N/A" || r.scan === r.target) {
            status = "DONE";
        } else if (itemPunyaKet) {
            status = "SELISIH"; // Status khusus untuk yang sudah di-OTP & diberi keterangan
        } else {
            status = (r.scan < r.target ? "PENDING" : "OVER");
        }
        
        // Logika Tombol Finalisasi: Jika DONE atau SELISIH, maka dianggap valid untuk kirim
        if (status !== "DONE" && status !== "SELISIH") isAllMatch = false; 
        
        // Penentuan Warna: Tambahkan warna Orange untuk yang SELISIH (Sudah di-OTP)
        const colorBg = status === 'DONE' ? '#d4edda' : 
                        (status === 'SELISIH' ? '#ffcc80' : // Warna Orange muda
                        (status === 'PENDING' ? '#f8d7da' : '#fff3cd'));

        const displayDesc = (jenis === "KONTAINER" || !r.desc) ? "" : `<br><small>${r.desc}</small>`;
        const ketTampil = itemPunyaKet ? `<br><i style="font-size:9px; color:brown;">Ket: ${itemPunyaKet.keterangan}</i>` : "";

        html += `<tr style="background:${colorBg}">
            <td style="text-align:left; padding:5px;"><b>${key}</b>${displayDesc}${ketTampil}</td>
            <td>${r.target}</td>
            <td>${r.scan}</td>
            <td>
                <b>${status}</b><br>
                <button onclick="editItemAntrian('${key}')" style="font-size:10px; background:#f39c12; color:white; border:none; border-radius:3px; padding:3px 8px;">REVISI</button>
            </td>
        </tr>`;
    });

    document.getElementById('report_info').innerHTML = `<b>${jenis}</b> | ${kode} | ${faktur}`;
    document.getElementById('report_body').innerHTML = html || "<tr><td colspan='4'>Belum ada data</td></tr>";
    document.getElementById('modal_report').style.display = 'block';
    
    // Aktifkan tombol jika isAllMatch true dan data tidak kosong
    const btnFin = document.getElementById('btn_finalisasi');
    btnFin.disabled = !(Object.keys(reportMap).length > 0 && isAllMatch);
    btnFin.style.opacity = btnFin.disabled ? "0.3" : "1";
}

function processStoreInput() {
    const kodeInput = document.getElementById('p_kode');
    if (kodeInput && kodeInput.value.trim() !== "") {
        // --- AWAL TAMBAHAN: LOGIKA EKSTRAKSI BARCODE LABEL ---
        let rawVal = kodeInput.value.trim().toUpperCase();
        const parts = rawVal.split('-').filter(Boolean);

        if (parts.length > 1) {
            // Jika discan dari Label KONTAINER (Contoh: A0001-R665) -> Ambil R665
            if (rawVal.includes("KONTAINER") || parts.length === 2) {
                rawVal = parts[1];
            } 
            // Jika discan dari Label DOS (Contoh: DOS-C5-R665-432296) -> Ambil R665
            else if (rawVal.includes("DOS") || parts.length >= 4) {
                rawVal = parts[2];
            }
        }
        kodeInput.value = rawVal; // Masukkan hasil ekstraksi kembali ke kolom
        // --- AKHIR TAMBAHAN ---

        // Jalankan filter (Struktur asli tetap di bawah)
        const found = runFilter(); 

        if (found) {
            // Sesuai Tahap 8: Setelah input Kode Toko, fokus ke Faktur
            setFocus('p_faktur');
        } else {
            notify("âš ï¸ Toko tidak ditemukan!", "error", "p_kode");
        }
    }
}

function alurFokus(currentStep) {
    if (currentStep === 'tgl') {
        setFocus('p_jenis');
    } else if (currentStep === 'jenis') {
        setFocus('p_kode');
    } else if (currentStep === 'kode') {
        // runFilter() dipanggil di sini untuk mengisi No Faktur
        runFilter(); 
        setFocus('p_faktur');
    } else if (currentStep === 'faktur') {
        setFocus('p_scan_label');
    }
}

function clearAllFields(isManual = true) {
    if(isManual) {
        // Jika ditekan tombol Clear (Point 12)
        const yakin = confirm("Hapus Semua Inputan?");
        if(!yakin) return;
    }

    // Reset Dropdown ke default
    document.getElementById('p_jenis').value = "";
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
    
    // Kosongkan semua inputan teks
    const ids = ['p_kode','p_nama','p_urpick','p_scan_label','p_scan_fisik','p_plu','p_descp','p_zona','p_qty_input','p_qty_data'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = "";
    });

    // Reset area fisik & readonly qty
    document.getElementById('area_fisik').style.display = 'none';
    const qtyInp = document.getElementById('p_qty_input');
    qtyInp.readOnly = true; 
    qtyInp.style.background = "#dcdcdc";

    // Fokus kembali ke TGL atau JENIS
    setFocus('p_tgl');
}

// Tambahkan listener pada TGL dan JENIS untuk trigger reset (Point 9)
document.getElementById('p_tgl').addEventListener('change', () => {
    // Jika ganti tanggal, reset semua field di bawahnya
    ['p_kode','p_nama','p_urpick','p_scan_label'].forEach(id => document.getElementById(id).value = "");
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
});

async function refreshMonitoringData() {
    const loader = document.getElementById('loader');
    const modalMonitor = document.getElementById('modal_monitor');

    modalMonitor.style.display = 'none'; // Tutup dulu
    loader.style.display = 'flex';       // Muncul loader

    try {
        const res = await fetch(G_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "getAllData" })
        });
        const out = await res.json();

        if (out.status === "success") {
            // Update dbSudahPolcek
            dbSudahPolcek = (out.dataSudahPolcek || []).map(r => ({
                tgl: String(r.tgl || "").substring(0, 10),
                kode: String(r.kode || "").trim().toUpperCase(),
                jenis: String(r.jenis || "").trim().toUpperCase(),
                barcode: String(r.barcode || "").trim().toUpperCase(), 
                qty_scan: Number(r.qty_scan || 0)
            }));
            localStorage.setItem("db_sudah_polcek", JSON.stringify(dbSudahPolcek));
        }
    } catch (e) {
        Swal.fire("Gagal", "Koneksi Bermasalah", "error");
    } finally {
        loader.style.display = 'none'; // Matikan loader
        
        // JALANKAN INI UNTUK MEMBUKA KEMBALI MODAL
        showMonitoring(); 
    }
}

function openResetModal() {
    document.getElementById('modal_reset').style.display = 'flex';
}

function closeResetModal() {
    document.getElementById('modal_reset').style.display = 'none';
    document.getElementById('r_nik').value = "";
    document.getElementById('r_pass_lama').value = "";
    document.getElementById('r_pass_baru').value = "";
}

async function processResetPassword() {
    const nik = document.getElementById('r_nik').value;
    const passLama = document.getElementById('r_pass_lama').value;
    const passBaru = document.getElementById('r_pass_baru').value;

    if (!nik || !passLama || !passBaru) {
        return Swal.fire("Gagal", "Semua field harus diisi!", "error");
    }

    // Tampilkan Loader
    document.getElementById('loader').style.display = 'flex';

    try {
        const res = await fetch(G_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: "updatePassword", 
                nik: nik, 
                passLama: passLama, 
                passBaru: passBaru 
            })
        });
        const out = await res.json();

        if (out.status === "success") {
            Swal.fire("Berhasil", "Password berhasil diperbarui!", "success");
            closeResetModal();
        } else {
            Swal.fire("Gagal", out.message || "Password lama salah!", "error");
        }
    } catch (e) {
        Swal.fire("Error", "Koneksi ke server bermasalah", "error");
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
}

window.onbeforeunload = function() {
    if (localStorage.getItem("isLoggedIn") === "true") {
        return "Proses Polcek sedang berjalan. Anda yakin ingin menutup halaman?";
    }
};

// Fungsi untuk membunyikan suara peringatan/error
function playError() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    oscillator.type = 'sawtooth'; // Suara agak kasar untuk menandakan error
    oscillator.frequency.setValueAtTime(150, audioCtx.currentTime); // Nada rendah
    
    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);

    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.5); // Bunyi selama 0.5 detik
}

async function editItemAntrian(key) {
    // SEMBUNYIKAN MODAL REPORT TERLEBIH DAHULU
    document.getElementById('modal_report').style.display = 'none';

    // 1. Tanyakan Opsi Revisi
    const { value: opsi } = await Swal.fire({
        title: 'OPSI REVISI',
        text: `Pilih tindakan untuk item ${key}`,
        icon: 'question',
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: 'REVISI QTY',
        denyButtonText: 'FINAL SELISIH',
        cancelButtonText: 'BATAL',
        confirmButtonColor: '#3085d6',
        denyButtonColor: '#f39c12',
        allowOutsideClick: false // Mencegah klik luar agar modal report tidak "nyangkut"
    });

    // JIKA USER TEKAN BATAL / CANCEL
    if (opsi === undefined) {
        document.getElementById('modal_report').style.display = 'block';
        return;
    }

    // --- CABANG A: REVISI QTY ---
    if (opsi === true) { 
        const { value: otp } = await Swal.fire({
            title: 'VERIFIKASI OTP',
            input: 'password',
            inputPlaceholder: 'Masukkan OTP Supervisor',
            showCancelButton: true
        });

        if (otp === "1234") { 
            const { value: qtyBaru } = await Swal.fire({
                title: 'INPUT QTY BARU',
                input: 'number',
                inputAttributes: { min: 0 },
                showCancelButton: true
            });

            if (qtyBaru !== undefined) {
                updateQtyLokal(key, parseInt(qtyBaru), "");
                await Swal.fire('Berhasil', 'Qty telah diperbarui', 'success');
            }
        } else if (otp) {
            await Swal.fire('Gagal', 'OTP Salah!', 'error');
        }
    } 

    // --- CABANG B: FINAL SELISIH (PAKSA FINAL) ---
    else if (opsi === false) { 
        const { value: formValues } = await Swal.fire({
            title: 'FINAL SELISIH',
            html:
                '<input id="swal-otp" class="swal2-input" placeholder="OTP Supervisor" type="password">' +
                '<textarea id="swal-ket" class="swal2-textarea" placeholder="Keterangan Wajib (Pecah/Hilang/dll)"></textarea>',
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'OK PAKSA FINAL',
            preConfirm: () => {
                const otp = document.getElementById('swal-otp').value;
                const ket = document.getElementById('swal-ket').value;
                if (!otp || !ket) {
                    Swal.showValidationMessage('OTP dan Keterangan WAJIB diisi!');
                }
                return { otp: otp, ket: ket };
            }
        });

        if (formValues) {
            if (formValues.otp === "1234") {
                updateQtyLokal(key, null, formValues.ket);
                await Swal.fire('Tersimpan', 'Status: Paksa Final (Selisih)', 'warning');
            } else {
                await Swal.fire('Gagal', 'OTP Salah!', 'error');
            }
        }
    }

       showReport(); 
}

function updateQtyLokal(key, qtyBaru, keterangan) {
    let antrian = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    antrian.forEach(item => {
        if (item.plu === key || item.barcode === key || item.kontainer === key) {
            if (qtyBaru !== null) item.qty_scan = qtyBaru;
            if (keterangan) item.keterangan = keterangan;
        }
    });
    localStorage.setItem('q_polcek', JSON.stringify(antrian));
}

function handleScanToko(val) {
    if (!val) return;

    // Pecah barcode berdasarkan tanda strip '-'
    const parts = val.split('-').filter(Boolean);
    let hasilKode = val.toUpperCase().trim();

    // 1. Logika Ekstraksi Kode Toko
    if (parts.length > 1) {
        if (val.toUpperCase().includes("KONTAINER") || parts.length === 2) {
            // Contoh: A0001-R665 -> Toko di parts[1]
            hasilKode = parts[1].toUpperCase();
        } 
        else if (val.toUpperCase().includes("DOS") || parts.length >= 4) {
            // Contoh: DOS-C5-R665-432296 -> Toko di parts[2]
            hasilKode = parts[2].toUpperCase();
        }
    }

    // 2. Masukkan hasil ke input KD STORE
    document.getElementById('p_kode').value = hasilKode;

    // 3. Jalankan filter toko (agar list faktur terisi)
    if (typeof filterToko === "function") {
        filterToko(); 
    }

    // 4. PINDAHKAN FOKUS KE NO FAKTUR
    // Gunakan setTimeout sedikit agar browser sempat merender list faktur terlebih dahulu
    setTimeout(() => {
        const elFaktur = document.getElementById('p_faktur');
        if (elFaktur) {
            elFaktur.focus();
            // Jika p_faktur adalah dropdown/select, kita bisa memicu pembukaan list
            console.log("Fokus pindah ke No Faktur");
        }
    }, 300);
}


// Fungsi untuk menampilkan Area Scan dan menyembunyikan Header
function toggleAreaScan() {
    const tgl = document.getElementById('p_tgl').value;
    const kode = document.getElementById('p_kode').value;
    const faktur = document.getElementById('p_faktur').value;

    // Jika ketiga data utama sudah terisi
    if (tgl && kode && faktur) {
        document.getElementById('section_header').style.display = 'none'; // Sembunyikan Atas
        document.getElementById('section_scan').style.display = 'block'; // Tampilkan Bawah
        
        // Langsung fokuskan ke tempat scan label agar user tidak klik lagi
        setTimeout(() => {
            document.getElementById('p_scan_label').focus();
        }, 300);
    }
}

// Fungsi untuk kembali ke layar utama (setelah final atau klik tombol kembali)
function backToHeader() {
    document.getElementById('section_header').style.display = 'block'; // Tampilkan Atas
    document.getElementById('section_scan').style.display = 'none';   // Sembunyikan Bawah
    
    // Reset input agar bersih untuk input toko baru
    document.getElementById('p_kode').value = "";
    document.getElementById('p_nama').value = "";
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
}

function toggleKeScan() {
    const faktur = document.getElementById('p_faktur').value;
    if (faktur !== "") {
        // Sembunyikan Header, Tampilkan Area Scan
        document.getElementById('group_header').style.display = 'none';
        document.getElementById('group_scan').style.display = 'block';
        
        // Langsung fokus ke Scan Label agar petugas tidak klik layar lagi
        setTimeout(() => {
            document.getElementById('p_scan_label').focus();
        }, 200);
    }
}

function kembaliKeHeader() {
    // Tampilkan kembali Header untuk ganti Toko/Faktur
    document.getElementById('group_header').style.display = 'block';
    document.getElementById('group_scan').style.display = 'none';
}

// Pastikan saat Clear data atau setelah Final, tampilan kembali ke Header
function resetTampilanLayar() {
    document.getElementById('group_header').style.display = 'block';
    document.getElementById('group_scan').style.display = 'none';
}

function showAntrianModal() {
    const scanDB = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    const tbody = document.getElementById('antrian_body');
    tbody.innerHTML = "";

    if (scanDB.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4'>Tidak ada antrian data</td></tr>";
    } else {
        // Kelompokkan data berdasarkan No Faktur
        const grouped = {};
        scanDB.forEach(item => {
            if (!grouped[item.faktur]) {
                grouped[item.faktur] = {
                    urpick: item.urpick || "-",
                    kode: item.kode,
                    nama: item.nama || "",
                    tgl: item.tgl,
                    jenis: item.jenis,
                    items: 0
                };
            }
            grouped[item.faktur].items++;
        });

        // Tampilkan ke Tabel
        Object.keys(grouped).forEach(faktur => {
            const g = grouped[faktur];
            const row = `<tr>
                <td>${g.urpick}</td>
                <td style="text-align:left; padding:5px;"><b>${g.kode}</b><br>${g.nama}</td>
                <td>${g.jenis}</td>
                <td>
                    <button onclick="pilihAntrian('${g.tgl}', '${g.kode}', '${faktur}', '${g.jenis}')" 
                            style="background:#27ae60; color:white; border:none; padding:5px; border-radius:3px; font-size:9px;">
                        PROSES FINAL
                    </button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }
    document.getElementById('modal_antrian').style.display = 'block';
}

function pilihAntrian(tgl, kode, faktur, jenis) {
    // 1. Masukkan data ke input header
    document.getElementById('p_tgl').value = tgl;
    document.getElementById('p_kode').value = kode;
    document.getElementById('p_jenis').value = jenis;
    
    // 2. Jalankan filter toko agar info nama muncul
    processStoreInput(); 
    
    // 3. Set No Faktur dan trigger tampil area scan/report
    setTimeout(() => {
        document.getElementById('p_faktur').value = faktur;
        document.getElementById('modal_antrian').style.display = 'none';
        
        // Langsung buka modal report (Final) untuk toko tersebut
        showReport();
    }, 500);
}

</script>
</body>
</html>
