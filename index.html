<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLCEK VALIDASI WH</title>
    <style>
        :root { --green: #70ad47; --orange: #e67e22; --blue: #2980b9; --red: #c0392b; }
        * { box-sizing: border-box; font-family: 'Arial Black', sans-serif; }
        body { background: #b0b0b0; padding: 15px; margin: 0; }
        .header { background: black; color: white; text-align: center; padding: 12px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
        .input-row { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
        .label { width: 110px; padding: 10px; font-size: 10px; color: white; border-radius: 5px; font-weight: bold; background: var(--green); text-transform: uppercase; }
        input, select { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #777; font-size: 13px; font-weight: bold; }
        input[readonly] { background: #dcdcdc; color: #333; }
        .footer { display: flex; gap: 8px; margin-top: 15px; }
        .btn-main { flex: 1; padding: 15px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; }
        #loader { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; color: white; }
    </style>
</head>
<body onload="initApp()">

<div id="loader"><p>SINKRONISASI DATA...</p></div>
<div class="header">VALIDASI PENYIAPAN BARANG</div>

<div class="input-row"><div class="label">TGL PROSES</div><input type="date" id="p_tgl" onchange="runFilter()"></div>
<div class="input-row"><div class="label">KD TOKO</div><input type="text" id="p_kode" placeholder="R860" oninput="runFilter()"></div>
<div class="input-row"><div class="label">NAMA TOKO</div><input type="text" id="p_nama" readonly></div>
<div class="input-row"><div class="label">URPICK</div><input type="text" id="p_urpick" readonly></div>

<div class="input-row">
    <div class="label" style="background:var(--blue)">JENIS</div>
    <select id="p_jenis" onchange="runFilter()">
        <option value="KONTAINER">KONTAINER</option>
        <option value="DOS">DOS</option>
    </select>
</div>

<div class="input-row">
    <div class="label">NO FAKTUR</div>
    <select id="p_faktur" onchange="resetScanField()"><option value="">-- PILIH FAKTUR --</option></select>
</div>

<hr style="border: 1px solid #999; margin: 15px 0;">

<div class="input-row">
    <div class="label" style="background: var(--orange);">1. SCAN LABEL</div>
    <input type="text" id="p_scan_label" placeholder="Scan Barcode Label..." onchange="validateScanLabel()">
</div>

<div id="area_fisik" style="display:none; border: 2px solid var(--red); padding: 10px; border-radius: 5px; margin-bottom: 8px;">
    <div class="input-row">
        <div class="label" style="background: var(--red);">2. SCAN FISIK</div>
        <input type="text" id="p_scan_fisik" placeholder="Scan Barcode Produk..." onchange="validateScanFisik()">
    </div>
</div>

<div class="input-row"><div class="label">PLU</div><input type="text" id="p_plu" readonly></div>
<div class="input-row"><div class="label">BARANG</div><input type="text" id="p_descp" readonly></div>
<div class="input-row"><div class="label">ZONA</div><input type="text" id="p_zona" readonly></div>

<div class="input-row">
    <div class="label" style="background: #2c3e50;">QTY SCAN</div>
    <input type="number" id="p_qty_input" placeholder="0" readonly>
</div>

<input type="hidden" id="p_qty_data">

<div class="footer">
    <button class="btn-main" style="background:#2ecc71" onclick="saveData()">SIMPAN</button>
    <button class="btn-main" style="background:red" onclick="syncToServer()">ðŸš€ KIRIM (<span id="badge">0</span>)</button>
</div>

<script>
    const G_URL = "https://script.google.com/macros/s/AKfycbyQcJnA4-d9EUJ4u5nuaVkNjYPeY8e7g_UtpVKYeBku_cTnJWLKDlchbF84o3QJgg/exec"; 
    let dbPickAuto = [];
    let dbMasterBarcode = [];

    async function initApp() {
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('p_tgl').valueAsDate = new Date();
        try {
            const res = await fetch(G_URL, { method: 'POST', body: JSON.stringify({ action: "getAllData" }) });
            const out = await res.json(); // out dideklarasikan di sini
            
            if (out.status === "success") {
                dbPickAuto = out.pickAuto;
                dbMasterBarcode = out.masterBarcode;
                console.log("Data PickAuto:", dbPickAuto.length);
                console.log("Data MasterBarcode:", dbMasterBarcode.length);
            } else {
                alert("Error: " + out.message);
            }
        } catch (e) { 
            console.error(e);
            alert("Gagal Sinkronisasi!"); 
        }
        document.getElementById('loader').style.display = 'none';
        updateBadge();
    }

    function runFilter() {
        const tglRaw = document.getElementById('p_tgl').value;
        const kode = document.getElementById('p_kode').value.trim().toUpperCase();
        const jenis = document.getElementById('p_jenis').value;
        const fSelect = document.getElementById('p_faktur');

        if (!tglRaw || !kode) return;

        const d = new Date(tglRaw);
        const tglCheck = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);

        const matchToko = dbPickAuto.find(i => i.tglInput === tglCheck && i.kodeToko === kode);

        if (matchToko) {
            document.getElementById('p_nama').value = matchToko.namaToko;
            document.getElementById('p_urpick').value = matchToko.urpick;
            
            const filteredFaktur = dbPickAuto.filter(item => {
                const isMatch = (item.tglInput === tglCheck && item.kodeToko === kode);
                const isDos = item.kontainer.toUpperCase().includes("DOS");
                return jenis === "KONTAINER" ? (isMatch && !isDos) : (isMatch && isDos);
            });

            fSelect.innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
            [...new Set(filteredFaktur.map(i => i.faktur))].forEach(f => {
                fSelect.innerHTML += `<option value="${f}">${f}</option>`;
            });
        } else {
            document.getElementById('p_nama').value = "DATA TIDAK DITEMUKAN";
        }
    }

// TAHAP 1: VALIDASI LABEL
function validateScanLabel() {
    const scanVal = document.getElementById('p_scan_label').value.trim();
    const jenisVal = document.getElementById('p_jenis').value;
    const fakturVal = document.getElementById('p_faktur').value;
    const kodeTokoPilihan = document.getElementById('p_kode').value.toUpperCase();

    if (!fakturVal) { 
        alert("Pilih Faktur terlebih dahulu!"); 
        document.getElementById('p_scan_label').value = "";
        return; 
    }

    // --- LOGIKA KHUSUS KONTAINER ---
    if (jenisVal === "KONTAINER") {
        const inputRaw = scanVal.toUpperCase(); 

        // 1. Cek Duplikasi di antrian lokal
        let antrian = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        if (antrian.some(item => item.barcode.toUpperCase() === inputRaw && item.faktur === fakturVal)) {
            alert("âš ï¸ KONTAINER SUDAH DI SCAN!");
            document.getElementById('p_scan_label').value = "";
            return;
        }

        // 2. Bedah input "-K0001-R860" menjadi "K0001" dan "R860"
        const parts = inputRaw.split('-').filter(p => p !== ""); 
        const kontainerMurni = parts[0]; 
        const tokoLabel = parts[1];      

        // 3. Validasi Toko
        if (tokoLabel !== kodeTokoPilihan) {
            alert("âš ï¸ BARCODE TIDAK COCOK " );
            document.getElementById('p_scan_label').value = "";
            return;
        }

        // 4. Cari di Database
        const match = dbPickAuto.find(i => {
            const dbKontainer = String(i.kontainer || "").trim().toUpperCase();
            const dbToko = String(i.kodeToko || "").trim().toUpperCase();
            return i.faktur === fakturVal && dbKontainer === kontainerMurni && dbToko === kodeTokoPilihan;
        });

        if (match) {
            document.getElementById('p_plu').value = match.plu || "-";
            document.getElementById('p_descp').value = match.descp || "-";
            document.getElementById('p_zona').value = match.zona;
            document.getElementById('p_qty_data').value = match.qtyData;
            document.getElementById('p_qty_input').value = 1;
            document.getElementById('p_qty_input').readOnly = true;
            
            setTimeout(() => { saveData(); }, 500);
        } else {
            alert("âš ï¸ DATA TIDAK DITEMUKAN!\nKontainer '" + kontainerMurni + "' tidak ada di faktur ini.");
            document.getElementById('p_scan_label').value = "";
        }
    } 
    // --- AKHIR LOGIKA KONTAINER ---
    else {
        // --- LOGIKA DOS (Tahap 1: Scan Label) ---
        const partsDos = scanVal.split('-');
        const pluLabel = partsDos[partsDos.length - 1];
        
        const matchDos = dbPickAuto.find(i => i.faktur === fakturVal && i.plu === pluLabel);

        if (matchDos) {
            document.getElementById('p_plu').value = matchDos.plu || "-";
            document.getElementById('p_descp').value = matchDos.descp || "-";
            document.getElementById('p_zona').value = matchDos.zona;
            document.getElementById('p_qty_data').value = matchDos.qtyData;
            document.getElementById('area_fisik').style.display = 'block';
            document.getElementById('p_scan_fisik').focus();
        } else {
            alert("BARCODE DOS TIDAK COCOK!");
            document.getElementById('p_scan_label').value = "";
        }
    }
} 

    // TAHAP 2: VALIDASI FISIK
    function validateScanFisik() {
        const scanFisik = document.getElementById('p_scan_fisik').value.trim();
        const pluTarget = document.getElementById('p_plu').value;

        const isMatch = dbMasterBarcode.find(m => 
            (m.barcodeDos === scanFisik || m.barcodeItem === scanFisik) && m.plu === pluTarget
        );

        if (isMatch) {
            document.getElementById('p_qty_input').readOnly = false;
            document.getElementById('p_qty_input').focus();
            document.getElementById('p_qty_input').style.background = "white";
        } else {
            alert("BARCODE FISIK TIDAK SESUAI PLU!");
            document.getElementById('p_scan_fisik').value = "";
        }
    }

    function resetScanField() {
        ['p_scan_label','p_scan_fisik','p_plu','p_descp','p_zona','p_qty_input','p_qty_data'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = "";
        });
        document.getElementById('area_fisik').style.display = 'none';
        document.getElementById('p_qty_input').readOnly = true;
        document.getElementById('p_qty_input').style.background = "#dcdcdc";
    }

    function saveData() {
        const scanLabel = document.getElementById('p_scan_label').value;
        const qtyS = document.getElementById('p_qty_input').value;
        if (!scanLabel || !qtyS) return alert("Lengkapi Scan & Qty!");

        let q = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        q.push({
            tgl: document.getElementById('p_tgl').value,
            jenis: document.getElementById('p_jenis').value,
            kode: document.getElementById('p_kode').value,
            nama: document.getElementById('p_nama').value,
            urpick: document.getElementById('p_urpick').value,
            faktur: document.getElementById('p_faktur').value,
            zona: document.getElementById('p_zona').value,
            barcode: scanLabel,
            plu: document.getElementById('p_plu').value,
            descp: document.getElementById('p_descp').value,
            qty_data: document.getElementById('p_qty_data').value,
            qty_scan: qtyS
        });
        localStorage.setItem('q_polcek', JSON.stringify(q));
        resetScanField();
        updateBadge();
        document.getElementById('p_scan_label').focus();
    }

    async function syncToServer() {
        const q = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        if (q.length === 0) return;
        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(G_URL, { method: 'POST', body: JSON.stringify({ action: "syncBatch", data: q }) });
            const resJson = await res.json();
            if (resJson.status === "success") {
                localStorage.setItem('q_polcek', "[]");
                updateBadge();
                alert("Data Berhasil Terkirim!");
            }
        } catch (e) { alert("Gagal Kirim!"); }
        document.getElementById('loader').style.display = 'none';
    }

    function updateBadge() { document.getElementById('badge').innerText = JSON.parse(localStorage.getItem('q_polcek') || "[]").length; }
</script>
</body>
</html>
