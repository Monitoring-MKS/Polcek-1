<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLCEK WH - MAKASSAR</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>

/* Membuat area badge menempel di bawah layar */
.sticky-badge {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #000; /* Hitam */
    color: #ff0; /* Kuning */
    text-align: center;
    padding: 15px 0;
    font-weight: bold;
    font-size: 14px;
    border-top: 2px dashed #ff0;
    z-index: 9999; /* Pastikan paling depan */
    cursor: pointer;
}

/* Beri jarak bawah pada main_app supaya konten paling bawah tidak tertutup badge */
#main_app {
    padding-bottom: 70px; 
}

        /* Tombol Close Pojok Kanan Atas */
        .btn-close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 20001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        :root { --green: #70ad47; --orange: #e67e22; --blue: #2980b9; --red: #c0392b; }
        * { box-sizing: border-box; font-family: 'Arial Black', sans-serif; }
        body { background: #b0b0b0; padding: 15px; margin: 0; }
        
        #login_screen {
            position: fixed; inset: 0; background: #2c3e50; z-index: 30000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        .login-box {
            background: white; padding: 25px; border-radius: 10px; width: 100%; max-width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .login-box h2 { text-align: center; margin-bottom: 20px; color: #333; font-size: 18px; }

        .user-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #34495e; color: white; padding: 5px 15px;
            border-radius: 5px; margin-bottom: 10px; font-size: 12px;
        }
        .btn-logout {
            background: var(--red); color: white; border: none; padding: 5px 10px;
            border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 10px;
        }

        .header { background: black; color: white; text-align: center; padding: 12px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
        .input-row { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
        .label { width: 110px; padding: 10px; font-size: 10px; color: white; border-radius: 5px; font-weight: bold; background: var(--green); text-transform: uppercase; }
        input, select { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #777; font-size: 13px; font-weight: bold; }
        input[readonly] { background: #dcdcdc; color: #333; }
        .footer { display: flex; gap: 8px; margin-top: 15px; }
        .btn-main { flex: 1; padding: 15px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; }
        #loader {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7); /* Background gelap transparan */
    /* Z-INDEX HARUS LEBIH TINGGI DARI MODAL (biasanya modal itu 1000-2000) */
    z-index: 99999; 
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: white;
}

/* Tambahkan animasi putar agar lebih jelas sedang proses */
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/*CSS khusus tabel monitoring*/
    .table-monitor { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
    .table-monitor th { background: #2c3e50; color: white; padding: 8px; border: 1px solid #ddd; }
    .table-monitor td { padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; }
    .table-monitor tr:nth-child(even) { background-color: #f2f2f2; }
    .status-match { color: #27ae60; }
    .status-pending { color: #e67e22; }


.circle-loader {
  width: 48px;
  height: 48px;
  border: 5px solid rgba(255,255,255,0.3);
  border-top: 5px solid #ffffff;
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

.my-swal-z-index {
    z-index: 99999 !important; /* Angka tertinggi agar tidak tertutup apapun */
}

/* Tambahkan di bagian <style> */
.antrian-footer {
    position: sticky;
    bottom: 0;
    background: black;
    color: yellow;
    text-align: center;
    padding: 10px;
    font-size: 11px;
    margin-top: 10px;
    border-radius: 5px 5px 0 0;
    cursor: pointer;
    border: 1px dashed yellow;
    z-index: 100;
}

.nav-grid-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* Membagi 3 kolom sama rata */
    gap: 8px;                              /* Jarak antar tombol */
    margin-top: 15px;
    width: 100%;
    box-sizing: border-box;
}

.btn-nav {
    height: 50px;           /* Tinggi yang nyaman untuk jempol */
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: bold;
    font-size: 11px;        /* Ukuran teks optimal */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.btn-nav:active {
    transform: scale(0.95);
    opacity: 0.8;
}

.swal2-container {
    z-index: 99999 !important;
}


/* Pastikan sticky bekerja dengan baik */
.sticky-header {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: white;
}

/* Untuk modal monitoring */
#modal_monitor .sticky-top {
    position: sticky;
    top: 0;
    z-index: 100;
    background: white;
}

/* Agar konten bisa scroll dengan baik */
#modal_monitor > div {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

</style>

</head>
<body onload="loadInitialData()">

<div id="modal_monitor" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20000; overflow-y:auto; padding:10px;">
    <div style="background:white; border-radius:10px; height:95vh; display:flex; flex-direction:column; position:relative;">
        
        <!-- INI BAGIAN YANG AKAN STICKY DI ATAS -->
        <div style="position:sticky; top:0; z-index:100; background:white; border-radius:10px 10px 0 0;">
            
            <!-- Judul dengan Background Biru -->
            <div style="background:#2c3e50; color:white; padding:12px 15px; border-radius:10px 10px 0 0; text-align:center; position:relative;">
                <button class="btn-close-modal" onclick="document.getElementById('modal_monitor').style.display='none'" 
                        style="position:absolute; top:8px; right:10px; background:#c0392b; color:white; border:none; border-radius:50%; width:30px; height:30px; font-size:18px; cursor:pointer; display:flex; justify-content:center; align-items:center; z-index:101;">
                    Ã—
                </button>
                <h3 style="margin:0; font-size:16px;">MONITORING POLCEK</h3>
                <p id="monitor_date" style="margin:5px 0 0 0; font-size:11px; opacity:0.9;"></p>
            </div>
            
            <!-- Tombol Sync -->
            <div style="padding:8px 12px; background:#f8f9fa; border-bottom:1px solid #dee2e6;">
                <button onclick="refreshMonitoringData()" style="background:#27ae60; color:white; padding:10px; border:none; border-radius:5px; cursor:pointer; width:100%; font-size:12px; font-weight:bold;">
                    ðŸ”„ SYNC DATA
                </button>
            </div>
            
            <!-- Total Card Container - INI JUGA STICKY -->
            <div id="total_card_container" style="padding:8px 12px; background:white; border-bottom:2px solid #2c3e50;"></div>
            
        </div>
        
        <!-- CONTENT YANG BISA DI-SCROLL -->
        <div id="monitor_content" style="overflow-y: auto; padding:12px; flex:1; background:#f0f2f5;">
            <!-- Table akan dimasukkan di sini oleh JavaScript -->
        </div>
        
        <!-- FOOTER (TIDAK STICKY) -->
        <div style="padding:10px 12px; border-top:1px solid #dee2e6; background:white; border-radius:0 0 10px 10px;">
            <button class="btn-main" style="background:#34495e; width:100%; padding:12px; font-size:12px; border:none; border-radius:5px; color:white; font-weight:bold; cursor:pointer;" onclick="document.getElementById('modal_monitor').style.display='none'">
                TUTUP MONITORING
            </button>
        </div>
    </div>
</div>

<div id="loader"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.75); z-index:9999;
            display:flex; flex-direction:column; justify-content:center; align-items:center;">

  <div class="circle-loader"></div>

  <p style="margin-top:15px; font-size:14px; font-weight:bold; color:#ffffff;">
    Update data master, mohon tunggu...
  </p>
</div>

<div id="modal_antrian" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20000; overflow-y:auto; padding:10px;">
    <div style="background:white; border-radius:10px; padding:0; min-height:100%; position: relative; display:flex; flex-direction:column;">
        
        <!-- HEADER MODAL dengan X di kanan -->
        <div style="background:#2c3e50; color:white; padding:15px; border-radius:10px 10px 0 0; position:relative; text-align:center;">
            <h3 style="margin:0; font-size:16px;">ANTRIAN BELUM FINAL</h3>
            <p style="margin:5px 0 0 0; font-size:11px; opacity:0.8;" id="antrian_summary">Menampilkan data per toko & jenis</p>
            
            <!-- TOMBOL X di pojok kanan atas -->
            <button onclick="document.getElementById('modal_antrian').style.display='none'" 
                    style="position:absolute; top:12px; right:15px; background:#c0392b; color:white; border:none; border-radius:50%; width:32px; height:32px; font-size:18px; font-weight:bold; cursor:pointer; display:flex; justify-content:center; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.3);">
                Ã—
            </button>
        </div>
        
        <!-- CONTENT MODAL -->
        <div style="padding:15px; overflow-x:auto; flex:1;">
            <table border="1" style="width:100%; border-collapse:collapse; font-size:11px; text-align:center;">
                <thead style="background:#eee;">
                    <tr>
                        <th style="padding:8px;">URPICK</th>
                        <th style="padding:8px;">TOKO</th>
                        <th style="padding:8px;">JENIS / ITEM</th>
                        <th style="padding:8px;">ACTION</th>
                    </tr>
                </thead>
                <tbody id="antrian_body">
                    <!-- Diisi oleh JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- FOOTER MODAL -->
        <div style="padding:15px; border-top:1px solid #eee; background:#f8f9fa; border-radius:0 0 10px 10px;">
            <div id="footer_antrian_action" style="display: flex; gap: 10px;">
                <!-- Tombol akan diisi JavaScript -->
            </div>
        </div>
    </div>
</div>

<div id="login_screen">
    <div class="login-box">
        <div style="text-align: center; font-size: 12px; color: #7f8c8d; margin-bottom: 5px; font-family: monospace;">
            V.01.02.26@ mks-bersatu
        </div>
        <h2>LOGIN POLCEK</h2>
        <div class="input-row"><input type="text" id="l_nik" placeholder="NIK" onchange="checkNIK()"></div>
        <div class="input-row"><input type="text" id="l_nama" placeholder="NAMA" readonly></div>
        <div class="input-row"><input type="password" id="l_pass" placeholder="PASSWORD"></div>
        <button class="btn-main" style="background:var(--green); width:100%; margin-top:10px;" onclick="doLogin()">MASUK APLIKASI</button>
<div style="text-align:center; margin-top:15px;">
    <a href="javascript:void(0)" onclick="openResetModal()" style="color: #2980b9; font-size: 13px; text-decoration: none; font-weight: bold;">Update Password?</a>
</div>

    </div>
</div>

<div id="main_app" style="display:none;">
    <div class="header">POLCEK - WH MAKASSAR <br><span style="font-size: 9px; color: yellow;">V.01.02.26@ mks-bersatu</span></div>
    <div class="user-bar"><span>User: <b id="display_user">---</b></span><button class="btn-logout" onclick="doLogout()">LOGOUT</button></div>

<div id="group_header" style="display: block;">
        <div class="input-row"><div class="label">TGL PROSES</div><input type="date" id="p_tgl" onchange="setFocus('p_jenis')"></div>
        <div class="input-row">
            <div class="label" style="background:var(--blue)">JENIS</div>
            <select id="p_jenis" onchange="handleJenisChange()">
                <option value="">-- PILIH JENIS --</option>
                <option value="KONTAINER">KONTAINER</option>
                <option value="DOS">DOS</option>
            <option value="MANUAL">MANUAL</option>
            <option value="TAG I">TAG I</option>
            <option value="NON-PTL">NON-PTL</option>
            <option value="TELUR">TELUR</option>
            <option value="MKT">MKT</option>
            <option value="ATK GS">ATK GS</option>
            <option value="MATERAI">MATERAI</option>

                </select>
        </div>
        <div class="input-row"><div class="label">KD TOKO</div><input type="text" id="p_kode" placeholder="Scan/Ketik..." onchange="processStoreInput()"></div>
        <div class="input-row"><div class="label">NAMA TOKO</div><input type="text" id="p_nama" readonly></div>
        <div class="input-row"><div class="label">URPICK</div><input type="text" id="p_urpick" readonly></div>
        <div class="input-row"><div class="label">NO FAKTUR</div><select id="p_faktur" class="form-control" onchange="checkFakturFinal()">
    <option value="">-- PILIH FAKTUR --</option>
</select></div>
    </div>

    <div id="group_scan" style="display:none;">
        <hr style="border: 1px solid #999; margin: 15px 0;">
        <div class="input-row" id="row_scan_label"><div class="label" style="background: var(--orange);">SCAN LABEL</div><input type="text" id="p_scan_label" placeholder="Scan Label..." onchange="validateScanLabel()"></div>
        <div id="area_fisik" style="display:none; border: 2px solid var(--red); padding: 10px; border-radius: 5px; margin-bottom: 8px;">
            <div class="input-row"><div class="label" style="background: var(--red);">SCAN FISIK</div><input type="text" id="p_scan_fisik" placeholder="Scan Barcode Produk..." onchange="validateScanFisik()"></div>
        </div>
        <div class="input-row"><div class="label">PLU</div><input type="text" id="p_plu" readonly></div>
        <div class="input-row"><div class="label">DESCP</div><input type="text" id="p_descp" readonly></div>
        <div class="input-row"><div class="label">ZONA</div><input type="text" id="p_zona" readonly></div>
        <div class="input-row"><div class="label" style="background: #2c3e50;">QTY SCAN</div><input type="number" id="p_qty_input" placeholder="0" readonly></div>
        <input type="hidden" id="p_qty_data">
    </div>

    <div class="nav-grid-container" style="margin-top: 20px;">
        <button class="btn-nav" style="background:#2ecc71" onclick="saveData()">SIMPAN</button>
        <button class="btn-nav" style="background:#8e44ad" onclick="showReport()">FINAL</button>
        <button class="btn-nav" style="background:#34495e" onclick="toggleArea('HEADER')">HEADER</button>
        <button class="btn-nav" style="background:#34495e" onclick="clearAllFields()">CLEAR</button>
        <button class="btn-nav" style="background:#2c3e50; border: 1px solid yellow; color: yellow;" onclick="showMonitoring()">MONITOR</button>
        <button class="btn-nav" style="background:#d35400" onclick="showAntrianModal()">
            ANTRIAN (<span id="badge_small">0</span>)
        </button>
    </div>
    </div>


<div id="modal_report" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20000; overflow-y:auto; padding:10px;">
    <div style="background:white; border-radius:10px; padding:15px; min-height:100%; position: relative;">
        <button class="btn-close-modal" onclick="closeMonitoring()">Ã—</button>
        <h3 id="report_title" style="text-align:center; margin-top:0;">DATA COMPARE</h3>
        <div id="report_info" style="font-size:12px; margin-bottom:10px; border-bottom:1px solid #ccc; padding-bottom:5px;"></div>
        <div id="report_container" style="overflow-x:auto;">
            <table border="1" style="width:100%; border-collapse:collapse; font-size:11px; text-align:center;">
                <thead id="report_head">
                    <tr style="background:#eee;"><th>KONTAINER</th><th>QTY</th><th>POLCEK</th><th>STATUS</th></tr>
                </thead>
                <tbody id="report_body"></tbody>
            </table>
        </div>
        <div id="report_footer" style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-main" style="background:#34495e" onclick="closeMonitoring()">TUTUP</button>
            <button id="btn_finalisasi" class="btn-main" style="background:#27ae60" onclick="prosesFinalisasi()">FINALISASI</button>
        </div>
    </div>
</div>

<div id="modal_reset" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:30000; display:none; justify-content:center; align-items:center; padding:20px;">
    <div style="background:white; border-radius:15px; padding:20px; width:100%; max-width:350px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); position:relative;">
        <h3 style="text-align:center; color: #2c3e50; margin-top:0;">UPDATE PASSWORD</h3>
        <hr style="border:0; border-top:1px solid #eee; margin-bottom:15px;">
        
        <div style="margin-bottom: 12px;">
            <label style="font-size:12px; font-weight:bold; color:#7f8c8d;">NIK :</label>
            <input type="text" id="r_nik" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;" placeholder="Masukkan NIK">
        </div>
        <div style="margin-bottom: 12px;">
            <label style="font-size:12px; font-weight:bold; color:#7f8c8d;">PASSWORD LAMA :</label>
            <input type="password" id="r_pass_lama" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;" placeholder="******">
        </div>
        <div style="margin-bottom: 20px;">
            <label style="font-size:12px; font-weight:bold; color:#7f8c8d;">PASSWORD BARU :</label>
            <input type="password" id="r_pass_baru" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;" placeholder="******">
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="closeResetModal()" style="flex:1; background:#95a5a6; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">BATAL</button>
            <button onclick="processResetPassword()" style="flex:1; background:#2ecc71; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">SIMPAN</button>
        </div>
    </div>
</div>

<script>
history.pushState(null, null, location.href);
window.onpopstate = function() {
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    if (isLoggedIn === "true") {
        // Jika user tekan Back saat login, paksa tetap di halaman ini
        history.pushState(null, null, location.href);
        // Tampilkan peringatan kecil (Toast)
        const Toast = Swal.mixin({
            toast: true,
            position: 'top',
            showConfirmButton: false,
            timer: 2000
        });
        Toast.fire({
            icon: 'warning',
            title: 'Gunakan tombol LOGOUT untuk keluar'
        });
    }
};

// 2. Mencegah browser ditutup atau di-reload tanpa sengaja
window.onbeforeunload = function(e) {
    if (localStorage.getItem("isLoggedIn") === "true") {
        e.preventDefault();
        e.returnValue = ''; // Munculkan dialog konfirmasi browser
    }
};


const G_GITHUB_URL = "https://raw.githubusercontent.com/Monitoring-MKS/Polcek-1/refs/heads/main/database_polcek.json";

const G_URL = "https://script.google.com/macros/s/AKfycbxT8seg7faoEW_f-dY7UW7fZanEQ1hOehrXUdEdL6G3Kw70797-eeCEJjnsijOz4X4/exec";

let dbPickAuto = [];
let dbMasterBarcode = [];
let dbManual = [];
let dbSudahPolcek = [];
var currentUser = "";
var CACHED_DATA = null;



async function initApp() {
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    if (isLoggedIn === "true") {
        currentUser = localStorage.getItem("loggedUser");
        document.getElementById('display_user').innerText = currentUser;
        document.getElementById('login_screen').style.display = 'none';
        document.getElementById('main_app').style.display = 'block';
    }

    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'flex';

    console.log("Mencoba mengambil data dari GitHub...");

    try {
        // AMBIL DARI GITHUB (LEBIH CEPAT)
        const res = await fetch(G_GITHUB_URL);
        if (!res.ok) throw new Error("Gagal ambil data GitHub");
        
        const out = await res.json();
        
        // Mapping data dari JSON GitHub
        dbPickAuto = out.pickAuto || [];
        dbMasterBarcode = out.masterBarcode || [];
        dbManual = out.dataManual || [];
        dbSudahPolcek = out.dataSudahPolcek || [];

        // Simpan ke LocalStorage agar bisa offline
        localStorage.setItem("db_pick_auto", JSON.stringify(dbPickAuto));
        localStorage.setItem("db_master_barcode", JSON.stringify(dbMasterBarcode));
        
        console.log("Data GitHub berhasil masuk! Total PickAuto:", dbPickAuto.length);

    } catch (e) {
        console.error("Gagal tarik GitHub, mencoba data lokal...", e);
        // Fallback ke data lokal jika internet/github bermasalah
        dbPickAuto = JSON.parse(localStorage.getItem("db_pick_auto") || "[]");
        dbMasterBarcode = JSON.parse(localStorage.getItem("db_master_barcode") || "[]");
        
        Swal.fire({
            icon: 'warning',
            title: 'Mode Offline',
            text: 'Gagal update data terbaru, menggunakan data lama.',
            timer: 2000
        });
    } finally {
        // MATIKAN LOADING APAPUN YANG TERJADI
        if (loader) loader.style.display = 'none';
        updateBadge();
    }
}

    const usersDB = [
    { nik: "10030732", nama: "URIP PRADIPTA", pass: "234" },
    { nik: "21084962", nama: "BASYUDIN KADRI", pass: "234" },
    { nik: "22116378", nama: "IRWAN", pass: "234" },
    { nik: "06081095", nama: "AHMAD DJAINUDIN", pass: "234" },
    { nik: "13023500", nama: "AAN SUBHAN", pass: "234" },
    { nik: "06080176", nama: "RUDIYANTO", pass: "234" },
    { nik: "12124371", nama: "ARFA", pass: "234" },
    { nik: "15044455", nama: "ABD KADIR", pass: "234" },
    { nik: "06040353", nama: "YUSUP", pass: "234" },
    { nik: "13104668", nama: "DENADA", pass: "234" },
    { nik: "15093836", nama: "WAHYU DARUS RAMADHAN", pass: "234" },
    { nik: "11126379", nama: "ABDUL WARIS", pass: "234" },
    { nik: "15034964", nama: "SYARIF", pass: "234" },
    { nik: "15042057", nama: "FAJAR ABU THALIB", pass: "234" },
    { nik: "15042969", nama: "JUMAING", pass: "234" },
    { nik: "15052579", nama: "FIRMAN", pass: "234" },
    { nik: "15117277", nama: "ASRIADI", pass: "234" },
    { nik: "16016211", nama: "AKBAR T", pass: "234" },
    { nik: "10093059", nama: "MUSLIMIN", pass: "234" },
    { nik: "15033310", nama: "RAMLI S", pass: "234" },
    { nik: "12068137", nama: "SUWANDI", pass: "234" },
    { nik: "12067459", nama: "PATAHUDDIN", pass: "234" },
    { nik: "15112754", nama: "MUH ARHAM YUBDAL", pass: "234" },
    { nik: "13052840", nama: "JAFAR", pass: "234" },
    { nik: "20015892", nama: "ASRAN. A", pass: "234" },
    { nik: "12092687", nama: "MAULANA YUSUP", pass: "234" },
    { nik: "04060256", nama: "ABDULAH K. MUTOHAR", pass: "234" },
    { nik: "18077047", nama: "GENIAL FADILAT ARASY", pass: "234" },
    { nik: "18124171", nama: "HASTOMO", pass: "234" },
    { nik: "19015561", nama: "ADETIANI KURNIYA PRAT", pass: "234" },
    { nik: "21055244", nama: "ELOY REMBON", pass: "234" },
    { nik: "21104196", nama: "ALHANNAS", pass: "234" },
    { nik: "13013523", nama: "ANDI AHMAD", pass: "234" },
    { nik: "13013538", nama: "NASRUN B", pass: "234" },
    { nik: "19088924", nama: "IBNU MUNSIR", pass: "234" },
    { nik: "19088919", nama: "MUH SABIR", pass: "234" },
    { nik: "11022706", nama: "MUH SIGIT A", pass: "234" },
    { nik: "22016350", nama: "IRWANSYAH", pass: "234" },
    { nik: "19103817", nama: "AMRI ADI", pass: "234" },
    { nik: "19103821", nama: "JOKO DWI ASTRAWAN", pass: "234" },
    { nik: "13023392", nama: "MUH ZAENAL", pass: "234" },
    { nik: "20032629", nama: "RAHMAT ZULKIFLI", pass: "234" },
    { nik: "20042761", nama: "AGUNG RAHMAT", pass: "234" },
    { nik: "21021951", nama: "NUR ANDIKA", pass: "234" },
    { nik: "20123889", nama: "SADDAM HUSAIN", pass: "234" },
    { nik: "22067161", nama: "ABD RAHMAN", pass: "234" },
    { nik: "21041579", nama: "MUHAMMAD RIJAL", pass: "234" },
    { nik: "13063625", nama: "MOCH. NURCAHYO Y.", pass: "234" },
    { nik: "21082748", nama: "NASRULLAH", pass: "234" },
    { nik: "13071183", nama: "HAKIM", pass: "234" },
    { nik: "13074665", nama: "ABDUL KHAIR", pass: "234" },
    { nik: "07060205", nama: "YUSUP ISKANDAR", pass: "234" },
    { nik: "11084748", nama: "MUH.HAEDIR", pass: "234" },
    { nik: "11085162", nama: "NUR AMAL", pass: "234" },
    { nik: "14032387", nama: "MUHAMAD FURQON", pass: "234" },
    { nik: "11095305", nama: "AHMAD", pass: "234" },
    { nik: "09040248", nama: "DICKI ISKANDAR ZULKAR", pass: "234" },
    { nik: "11095472", nama: "SYARIFUDDIN", pass: "234" },
    { nik: "14066101", nama: "MUH NUR", pass: "234" },
    { nik: "11124107", nama: "MUHAMMAD AMIR", pass: "234" },
    { nik: "12015655", nama: "AHMAD JUNAEDI", pass: "234" },
    { nik: "12021938", nama: "ALI NURHIDIN", pass: "234" },
    { nik: "01020239", nama: "ASBAR", pass: "234" },
    { nik: "19106316", nama: "TAUFIK HIDAYAT AMIN", pass: "234" },
    { nik: "14022759", nama: "MUHIDDIN", pass: "234" },
    { nik: "21091494", nama: "ARLAN", pass: "234" },
    { nik: "18012062", nama: "M. MIFTAHUL MUNIF", pass: "234" },
    { nik: "19032172", nama: "SUPRIADI", pass: "234" },
    { nik: "19085644", nama: "ABDUL JALIL", pass: "234" },
    { nik: "21126790", nama: "HAERUL", pass: "234" },
    { nik: "20121101", nama: "AHMAD TAUFIQ. L", pass: "234" },
    { nik: "20121097", nama: "MUH. ALIF FAJRING", pass: "234" },
    { nik: "11084798", nama: "RIZKI", pass: "234" },
    { nik: "03030112", nama: "IRWAN", pass: "234" },
    { nik: "01060319", nama: "BASUKI", pass: "234" },
    { nik: "10062381", nama: "REZKA SURYANTO", pass: "234" },
    { nik: "08081171", nama: "LINGGA OKTA", pass: "234" },
    { nik: "23120912", nama: "HAMKA", pass: "234" },
    { nik: "20085631", nama: "ABU BAKAR", pass: "234" },
    { nik: "23072735", nama: "FIRMAN", pass: "234" },
    { nik: "21045428", nama: "RISAL", pass: "234" },

];

async function loadInitialData() {
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'flex';

    try {
        const res = await fetch(G_GITHUB_URL);
        if (!res.ok) throw new Error("Gagal ambil data GitHub");
        
        const out = await res.json();
        
        dbPickAuto = out.pickAuto || [];
        dbMasterBarcode = out.masterBarcode || [];
        dbManual = out.dataManual || [];
        
        // --- BAGIAN BARU: MERGE DATA SERVER + LOCAL ---
        let serverSudah = out.dataSudahPolcek || [];
        let localTemp = JSON.parse(localStorage.getItem('temp_final_polcek') || "[]");

        // Gabungkan keduanya ke RAM
        dbSudahPolcek = [...serverSudah, ...localTemp];

        // Pembersihan Otomatis: Hapus data lokal jika sudah ada di server
        const filteredLocal = localTemp.filter(l => 
            !serverSudah.some(s => s.faktur === l.faktur && s.kode === l.kode && s.jenis === l.jenis)
        );
        localStorage.setItem('temp_final_polcek', JSON.stringify(filteredLocal));
        // ----------------------------------------------
        
        console.log("Data berhasil disinkronkan!");

    } catch (e) {
        console.error("Gagal tarik GitHub, menggunakan cache lokal", e);
        // Jika gagal internet, tetap gunakan data kuncian lokal agar petugas tidak double scan
        dbSudahPolcek = JSON.parse(localStorage.getItem('temp_final_polcek') || "[]");
    } finally {
        if (loader) loader.style.display = 'none';        
        if (typeof updateBadge === "function") updateBadge();
    }
}

    function checkNIK() {
        const nikInput = document.getElementById('l_nik').value;
        const user = usersDB.find(u => u.nik === nikInput);
        if (user) {
            document.getElementById('l_nama').value = user.nama;
            setFocus('l_pass');
        } else {
            document.getElementById('l_nama').value = "";
            Swal.fire("Error", "NIK Tidak Terdaftar!", "error");
        }
    }

function doLogin() {
    const nik = document.getElementById('l_nik').value;
    const pass = document.getElementById('l_pass').value;
    const user = usersDB.find(u => u.nik === nik && u.pass === pass);
    
    if (user) {
        aktifkanFullScreen();
        
        // --- PENYESUAIAN DI SINI ---
        localStorage.setItem("isLoggedIn", "true");
        localStorage.setItem("activeUser", user.nama); // Disamakan agar saveData bisa baca
        currentUser = user.nama; // Update variabel global di memori
        // ---------------------------
        
        document.getElementById('login_screen').style.display = 'none';
        document.getElementById('main_app').style.display = 'block';
        document.getElementById('display_user').innerText = user.nama;
        
        history.pushState(null, null, location.href);
        loadInitialData(); 
    } else {
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'none';

        Swal.fire({ 
            title: "Gagal", 
            text: "Kombinasi NIK dan Password Salah", 
            icon: "error",
            confirmButtonColor: '#c0392b',
            didOpen: () => {
                Swal.getContainer().style.zIndex = "100000";
            }
        });
    }
}
function aktifkanFullScreen() {
    let doc = window.document;
    let docEl = doc.documentElement;

    let requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
    
    if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
        requestFullScreen.call(docEl);
    }
}

    function doLogout() {
    Swal.fire({
        title: "Logout?",
        text: "Sesi Anda akan berakhir dan data cadangan akan dibersihkan.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        confirmButtonText: "Ya, Keluar"
    }).then((result) => {
        if (result.isConfirmed) {
            // Bersihkan Sesi Login
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("loggedUser");
            
            // Bersihkan Cadangan Kuncian (Penting agar user lain tidak bingung)
            localStorage.removeItem("temp_final_polcek");
            
            // Paksa Reload ke halaman Login
            location.reload(); 
        }
    });
}

function handleJenisChange() {
    const jenis = document.getElementById('p_jenis').value;
    const kelompokNonScan = ["NON-PTL", "TELUR", "MKT", "ATK GS", "MATERAI"];
    const areaFisik = document.getElementById('area_fisik');
    const rowScanLabel = document.getElementById('row_scan_label');
    const qtyInp = document.getElementById('p_qty_input');
    
    // Poin 1: Sembunyikan Area Fisik jika bukan DOS/MANUAL
    areaFisik.style.display = (jenis === "DOS" || jenis === "MANUAL") ? 'block' : 'none';
    
    // Kontainer & Tag I hanya butuh Label, Non-Scan tidak butuh keduanya
    if (kelompokNonScan.includes(jenis)) {
        if(rowScanLabel) rowScanLabel.style.display = 'none';
        qtyInp.readOnly = false;
        qtyInp.style.background = "white";
    } else {
        if(rowScanLabel) rowScanLabel.style.display = 'flex';
        qtyInp.readOnly = true;
        qtyInp.style.background = "#eeeeee";
    }

    // Reset fields (Sesuai kode asli Anda)
    const idsToClear = ['p_kode', 'p_nama', 'p_urpick', 'p_scan_label', 'p_scan_fisik', 'p_plu', 'p_descp', 'p_zona', 'p_qty_input', 'p_qty_data'];
    idsToClear.forEach(id => { if (document.getElementById(id)) document.getElementById(id).value = ""; });
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
    
    if (jenis !== "") setFocus('p_kode');
}

// Poin 2: Alur Fokus Faktur ke Qty (Untuk Non-Scan)
function toggleKeScan() {
    const jenis = document.getElementById('p_jenis').value;
    const faktur = document.getElementById('p_faktur').value;
    const kelompokNonScan = ["NON-PTL", "TELUR", "MKT", "ATK GS", "MATERAI"];
    
    if (!faktur) return;

    // Poin 3: Hide Header (Grup Header hilang saat mulai scan)
    document.getElementById('group_header').style.display = 'none';
    document.getElementById('group_scan').style.display = 'block';

    if (kelompokNonScan.includes(jenis)) {
        // Langsung ke Qty untuk Non-Scan
        setTimeout(() => { document.getElementById('p_qty_input').focus(); }, 300);
    } else if (jenis === "DOS" || jenis === "MANUAL") {
        // Ke Fisik untuk DOS/MANUAL
        setTimeout(() => { document.getElementById('p_scan_fisik').focus(); }, 300);
    } else {
        // Sisanya (Kontainer/Tag I) ke Label
        setTimeout(() => { document.getElementById('p_scan_label').focus(); }, 300);
    }
}

function checkFakturFinal() {
    const tglRaw = document.getElementById('p_tgl').value;
    const jenis = document.getElementById('p_jenis').value;
    const kode = document.getElementById('p_kode').value.trim().toUpperCase();
    const faktur = document.getElementById('p_faktur').value;

    if (!tglRaw || !kode || !jenis || !faktur) return;

    // Format tanggal
    const d = new Date(tglRaw);
    const tglCheck = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);

    // Cari di database hasil final
    const sudahAda = dbSudahPolcek.some(item => 
        String(item.tgl).trim() === tglCheck &&
        String(item.kode).trim() === kode &&
        String(item.jenis).trim().toUpperCase() === jenis.toUpperCase() &&
        String(item.faktur).trim() === faktur
    );

    if (sudahAda) {
        if (typeof playError === "function") playError();
        Swal.fire({
            icon: 'error',
            title: 'SUDAH PERNAH SCAN!',
            text: `Faktur ${faktur} sudah final.`,
            confirmButtonColor: '#c0392b'
        }).then(() => {
            document.getElementById('p_kode').value = "";
            document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
            setTimeout(() => { document.getElementById('p_kode').focus(); }, 300);
        });
            // 1. Kosongkan input terkait toko dan faktur
            document.getElementById('p_kode').value = "";
            document.getElementById('p_nama').value = "";
            document.getElementById('p_urpick').value = "";
            document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';

    } else {
        // ðŸ”¥ JIKA LOLOS VALIDASI: OTOMATIS PINDAH KE SCAN
        // Memanggil fungsi bawaan Anda untuk pindah area
        toggleKeScan(); 
    }
}

    function runFilter() {
    const tglRaw = document.getElementById('p_tgl').value;
    const jenis = document.getElementById('p_jenis').value;
    const kode = document.getElementById('p_kode').value.trim().toUpperCase();
    const fSelect = document.getElementById('p_faktur');
    
    if (!tglRaw || !kode || !jenis) return false;

    // Format tanggal untuk pencarian
    const d = new Date(tglRaw);
    const tglCheck = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
    
    // Pilih database berdasarkan jenis
    const currentDB = (jenis === "MANUAL") ? dbManual : dbPickAuto;

    // Cari data yang cocok
    const filtered = currentDB.filter(item => {
        return item.tglInput === tglCheck && item.kodeToko === kode;
    });
const isSudahFinal = dbSudahPolcek.some(item => 
    item.faktur === fSelect.value && // fSelect adalah dropdown faktur
    item.kode === kode && 
    item.jenis === jenis
);

if (isSudahFinal) {
    Swal.fire("DITOLAK", "Faktur untuk toko ini sudah difinalisasi!", "error");
    return false; 
}

    if (filtered.length > 0) {
        // Isi Nama Toko dan Urpick secara otomatis
        document.getElementById('p_nama').value = filtered[0].namaToko;
        document.getElementById('p_urpick').value = filtered[0].urpick;

        // Isi Dropdown Faktur
        fSelect.innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
        const uniqueFakturs = [...new Set(filtered.map(i => i.faktur))];
        uniqueFakturs.forEach(f => { 
            fSelect.innerHTML += `<option value="${f}">${f}</option>`; 
        });
        
        return true; // Data ditemukan
    } else {
        // Reset jika tidak ketemu
        document.getElementById('p_nama').value = "";
        document.getElementById('p_urpick').value = "";
        fSelect.innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
        return false; // Data tidak ditemukan
    }
}

function hitungTotalTerScan(plu, faktur, kode, jenis) {
    let total = 0;

    // 1. Cek di Database yang sudah terkirim (Server/GitHub)
    if (typeof dbSudahPolcek !== 'undefined' && dbSudahPolcek.length > 0) {
        dbSudahPolcek.forEach(d => {
            if (String(d.plu).trim() === String(plu).trim() && 
                String(d.faktur).trim() === String(faktur).trim() &&
                String(d.kode).trim() === String(kode).trim() && // Tambah validasi Kode Toko
                String(d.jenis).trim() === String(jenis).trim()) { // Tambah validasi Jenis
                total += parseInt(d.qty_scan || 0);
            }
        });
    }

    // 2. Cek di Antrian Lokal (LocalStorage)
    let antrian = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    antrian.forEach(a => {
        if (String(a.plu).trim() === String(plu).trim() && 
            String(a.faktur).trim() === String(faktur).trim() &&
            String(a.kode).trim() === String(kode).trim() && // Tambah validasi Kode Toko
            String(a.jenis).trim() === String(jenis).trim()) { // Tambah validasi Jenis
            total += parseInt(a.qty_scan || 0);
        }
    });

    return total;
}

function validateScanFisik() {
    const rawVal = document.getElementById('p_scan_fisik').value.trim();
    if (!rawVal) return;

    const scanVal = rawVal.toUpperCase();
    const fakturVal = document.getElementById('p_faktur').value;
    const kodeToko = document.getElementById('p_kode').value.toUpperCase();
    const jenisVal = document.getElementById('p_jenis').value;

    // ðŸ”¥ FUNGSI: Normalisasi PLU (hapus leading zeros)
    const normalizePLU = (plu) => {
        if (!plu) return plu;
        // Hapus leading zeros, tapi jika semua nol, kembalikan "0"
        const normalized = String(plu).replace(/^0+/, '');
        return normalized === '' ? '0' : normalized;
    };

    // 1. IDENTIFIKASI PLU (Bisa Label, Barcode Dos, atau Barcode Item)
    let foundPLU = "";
    let originalBarcode = scanVal;
    
    if (scanVal.includes('-')) {
        // Alur Label (Contoh: 18996001401436-UNDEFINED)
        const parts = scanVal.split('-').filter(Boolean);
        foundPLU = (jenisVal === "DOS") ? parts[3] : parts[2];
    } else {
        // Alur Barcode Fisik / Barcode Dos (Murni Angka)
        const matchMB = dbMasterBarcode.find(m => {
            const barcodeDos = String(m.barcodeDos || "").trim();
            const barcodeItem = String(m.barcodeItem || "").trim();
            
            // ðŸ”¥ BANDINGKAN DENGAN DAN TANPA LEADING ZEROS
            // Normalisasi kedua sisi untuk perbandingan
            const normalizedScan = normalizePLU(scanVal);
            const normalizedDos = normalizePLU(barcodeDos);
            const normalizedItem = normalizePLU(barcodeItem);
            
            return scanVal === barcodeDos || 
                   scanVal === barcodeItem ||
                   normalizedScan === normalizedDos ||
                   normalizedScan === normalizedItem;
        });
        
        if (matchMB) {
            // Simpan PLU asli dari database (dengan leading zeros jika ada)
            foundPLU = String(matchMB.plu).trim();
            console.log("DEBUG Fisik - Match found:", {
                scanBarcode: scanVal,
                normalizedScan: normalizePLU(scanVal),
                dbBarcodeDos: matchMB.barcodeDos,
                dbBarcodeItem: matchMB.barcodeItem,
                dbPLU: foundPLU
            });
        }
    }

    // Jika PLU tidak ditemukan sama sekali
    if (!foundPLU) {
        if (typeof playError === "function") playError();
        notify("BARCODE TIDAK TERDAFTAR!", "error", "p_scan_fisik");
        document.getElementById('p_scan_fisik').value = "";
        return;
    }

    // 2. CARI DATA DI PICKING (DOS/MANUAL)
    let matchPicking;
    if (jenisVal === "DOS") {
        matchPicking = dbPickAuto.find(i => {
            if (i.faktur !== fakturVal || i.kodeToko !== kodeToko) return false;
            
            // ðŸ”¥ BANDINGKAN PLU DENGAN DAN TANPA LEADING ZEROS
            const dbPLU = String(i.plu || "").trim();
            const normalizedFound = normalizePLU(foundPLU);
            const normalizedDb = normalizePLU(dbPLU);
            
            return String(i.plu) === foundPLU || 
                   normalizedFound === normalizedDb;
        });
    } else if (jenisVal === "MANUAL") {
        matchPicking = dbManual.find(i => {
            if (i.faktur !== fakturVal) return false;
            
            // ðŸ”¥ BANDINGKAN PLU DENGAN DAN TANPA LEADING ZEROS
            const dbPLU = String(i.plu || "").trim();
            const normalizedFound = normalizePLU(foundPLU);
            const normalizedDb = normalizePLU(dbPLU);
            
            return String(i.plu) === foundPLU || 
                   normalizedFound === normalizedDb;
        });
    }

    if (matchPicking) {
        // ðŸ”¥ GUNAKAN PLU DARI DATABASE (untuk konsistensi)
        const pluDatabase = String(matchPicking.plu || "").trim();
        const targetAsli = parseInt(matchPicking.qtyData || 0);
        
        // Hitung dulu yang sudah masuk ke server/antrian lokal
        const sudahTerpenuhi = hitungTotalTerScan(pluDatabase, fakturVal, kodeToko, jenisVal);

        // CEK VALIDASI OVER
        if (sudahTerpenuhi >= targetAsli) {
            if (typeof playError === "function") playError();
            Swal.fire({
                icon: "warning",
                title: "SUDAH LENGKAP!",
                text: `PLU ${pluDatabase} sudah ter-scan ${sudahTerpenuhi} dari target ${targetAsli}`
            });
        } else {
            // ACTION: ISI DATA KE LAYAR
            fillData(matchPicking);
            
            // PAKSA QTY KE 1
            document.getElementById('p_qty_input').value = 1;
            
            // Simpan label sesuai apa yang di-scan
            document.getElementById('p_scan_label').value = scanVal;

            // Notifikasi sukses dengan informasi PLU
            Swal.fire({
                icon: 'success',
                title: 'Berhasil!',
                text: `PLU: ${pluDatabase}`,
                timer: 800,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });

            // Langsung simpan otomatis
            if (typeof saveData === "function") {
                saveData();
            }
        }
    } else {
        if (typeof playError === "function") playError();
        notify(`PLU ${foundPLU} tidak ada di faktur ini!`, "error", "p_scan_fisik");
    }

    document.getElementById('p_scan_fisik').value = "";
    document.getElementById('p_scan_fisik').focus();
}

function validateScanLabel() {
    let rawScanVal = document.getElementById('p_scan_label').value;
    
    // ðŸ”¥ NORMALISASI: Hapus spasi berlebih tapi pertahankan struktur
    const scanVal = rawScanVal
        .trim()
        .replace(/\s+/g, ' ')        // Ganti multiple spasi jadi 1 spasi
        .replace(/\s*-\s*/g, '-')     // Hapus spasi di sekitar tanda hubung
        .toUpperCase();
    
    document.getElementById('p_scan_label').value = scanVal;

    const jenisVal = document.getElementById('p_jenis').value;
    const kodeToko = document.getElementById('p_kode').value.toUpperCase();
    const fakturVal = document.getElementById('p_faktur').value;
    const pluAktif = String(document.getElementById('p_plu').value).trim();

    if (!scanVal) return;

    // ðŸ”¥ KHUSUS UNTUK MANUAL - DIPISAH AGAR TIDAK MENGGANGGU YANG LAIN
    if (jenisVal === "MANUAL") {
        if (!pluAktif || pluAktif === "-") {
            document.getElementById('p_scan_label').value = "";
            return Swal.fire({
                icon: 'warning',
                title: 'Urutan Salah',
                text: 'Scan Barcode FISIK barang dulu!',
                timer: 1500
            });
        }

        // ðŸ”¥ PERBAIKAN: Split dengan menangani spasi dan multiple separator
        // Ganti semua spasi dan multiple hubung menjadi single hubung
        const cleanBarcode = scanVal
            .replace(/\s+/g, '-')     // Ganti spasi dengan hubung
            .replace(/-+/g, '-');      // Ganti multiple hubung jadi single hubung
            
        const parts = cleanBarcode.split('-').filter(part => part.trim() !== '');
        
        console.log("DEBUG Manual - Raw scan:", rawScanVal);
        console.log("DEBUG Manual - Normalized:", scanVal);
        console.log("DEBUG Manual - Clean barcode:", cleanBarcode);
        console.log("DEBUG Manual - Parts:", parts);
        
        // ðŸ”¥ PERBAIKAN: Deteksi PLU dari bagian AKHIR dengan berbagai kemungkinan
        let pluDariBarcode = "";
        
        if (parts.length >= 2) {
            // Ambil part terakhir sebagai PLU
            pluDariBarcode = parts[parts.length - 1];
        }
        
        // ðŸ”¥ PERBAIKAN: Ambil bagian faktur (semua parts kecuali yang terakhir)
        const fakturDariBarcode = parts.slice(0, -1).join('-');
        
        console.log("DEBUG Manual - PLU barcode:", pluDariBarcode);
        console.log("DEBUG Manual - PLU aktif:", pluAktif);
        console.log("DEBUG Manual - Faktur barcode:", fakturDariBarcode);
        console.log("DEBUG Manual - Faktur aktif:", fakturVal);
        
        // ðŸ”¥ PERBAIKAN: Bandingkan PLU (sebagai string, tanpa menghilangkan angka 0 di depan)
        // Karena PLU bisa berupa angka panjang seperti 123235
        if (pluDariBarcode !== pluAktif) {
            if (typeof playError === "function") playError();
            Swal.fire({
                icon: 'error',
                title: 'PLU TIDAK COCOK',
                html: `Barcode: <b>${pluDariBarcode}</b><br>Fisik: <b>${pluAktif}</b>`,
                timer: 2000
            });
            document.getElementById('p_scan_label').value = "";
            return;
        }
        
        // ðŸ”¥ PERBAIKAN: Validasi faktur (cocokkan dengan berbagai kemungkinan)
        // Faktur aktif harus ada di dalam fakturDariBarcode ATAU sebaliknya
        const fakturAktifClean = fakturVal.replace(/\s+/g, '').toUpperCase();
        const fakturBarcodeClean = fakturDariBarcode.replace(/\s+/g, '').toUpperCase();
        
        const isFakturMatch = 
            fakturBarcodeClean.includes(fakturAktifClean) || 
            fakturAktifClean.includes(fakturBarcodeClean) ||
            fakturBarcodeClean === fakturAktifClean;
        
        if (!isFakturMatch) {
            if (typeof playError === "function") playError();
            Swal.fire({
                icon: 'error',
                title: 'FAKTUR TIDAK COCOK',
                html: `Barcode: <b>${fakturDariBarcode}</b><br>Aktif: <b>${fakturVal}</b>`,
                timer: 2000
            });
            document.getElementById('p_scan_label').value = "";
            return;
        }
        
        // SEMUA VALIDASI LOLOS
        document.getElementById('p_qty_input').value = 1;
        
        // Notifikasi sukses
        Swal.fire({
            icon: 'success',
            title: 'Valid!',
            text: `PLU ${pluAktif} cocok`,
            timer: 800,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
        });
        
        // Fokus ke scan fisik untuk lanjut
        setTimeout(() => { 
            const scanFisik = document.getElementById('p_scan_fisik');
            if (scanFisik) {
                scanFisik.focus();
                scanFisik.select();
            }
        }, 300);
        
        return; // PENTING: return agar tidak lanjut ke kode berikutnya
    }

    // ðŸ”¥ KODE ORIGINAL UNTUK DOS (TETAP SAMA)
    else if (jenisVal === "DOS") {
        // ... kode DOS tetap sama ...
        if (!pluAktif || pluAktif === "-") {
            document.getElementById('p_scan_label').value = "";
            return Swal.fire("Urutan Salah", "Scan Barcode FISIK barang dulu!", "warning");
        }

        const parts = scanVal.split('-').filter(Boolean);
        let pluLabel = parts[3];
        let tokoLabel = (parts[2] || "").toUpperCase();

        if (tokoLabel !== kodeToko) {
            if (typeof playError === "function") playError();
            document.getElementById('p_scan_label').value = "";
            return Swal.fire("SALAH TOKO", `Label: ${tokoLabel}, Aktif: ${kodeToko}`, "error");
        }

        if (String(pluLabel) === pluAktif) {
            document.getElementById('p_qty_input').value = 1;
            setTimeout(() => { document.getElementById('p_scan_fisik').focus(); }, 100);
        } else {
            if (typeof playError === "function") playError();
            Swal.fire("PLU TIDAK COCOK", `Label: ${pluLabel} | Fisik: ${pluAktif}`, "error");
            document.getElementById('p_scan_label').value = "";
        }
    }

    // ðŸ”¥ KODE ORIGINAL UNTUK KONTAINER (TETAP SAMA)
    else if (jenisVal === "KONTAINER") {
        // ... kode KONTAINER tetap sama ...
        const parts = scanVal.split('-').filter(Boolean);
        const noKontainerLabel = parts[0] ? parts[0].toUpperCase() : "";
        const kodeTokoLabel = parts[1] ? parts[1].toUpperCase() : "";

        if (kodeTokoLabel !== kodeToko) {
            document.getElementById('p_scan_label').value = "";
            if (typeof playError === "function") playError();Â 
            return Swal.fire({ icon: 'error', title: 'SALAH TOKO!', text: `Label Toko ${kodeTokoLabel}, Aktif Toko ${kodeToko}` });
        }

        let antrian = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        const diAntrian = antrian.find(item => item.faktur === fakturVal && item.kode === kodeToko && item.barcode.toUpperCase().includes(noKontainerLabel));
        const diServer = dbSudahPolcek.find(item => item.faktur === fakturVal && item.kode === kodeToko && item.barcode.toUpperCase().includes(noKontainerLabel));

        if (diAntrian || diServer) {
            document.getElementById('p_scan_label').value = "";
            if (typeof playError === "function") playError();
            return Swal.fire({ icon: 'warning', title: 'SUDAH SCAN!', text: `Kontainer ${noKontainerLabel} sudah pernah discan/dikirim.` });
        }

        const match = dbPickAuto.find(i => i.faktur === fakturVal && i.kodeToko === kodeToko && (i.kontainer || "").toUpperCase() === noKontainerLabel);

        if (match) {Â 
            fillData(match);Â 
            document.getElementById('p_qty_input').value = 1;Â 
            document.getElementById('p_qty_input').readOnly = true;
            document.getElementById('p_scan_label').value = scanVal.toUpperCase();
            setTimeout(() => { saveData(); }, 300);
        } else {Â 
            if (typeof playError === "function") playError();
            notify(" NO KONTAINER TIDAK ADA DI DATA!", "error", "p_scan_label");Â 
            document.getElementById('p_scan_label').value = "";Â 
        }
    }

    // ðŸ”¥ KODE ORIGINAL UNTUK TAG I (TETAP SAMA)
    else if (jenisVal === "TAG I") {
        document.getElementById('p_plu').value = "TAG-I";
        document.getElementById('p_scan_label').value = scanVal || "TAG-I";
        document.getElementById('p_descp').value = "PENDATAAN TAG I";
        document.getElementById('p_qty_input').value = 1;
        document.getElementById('p_qty_data').value = 0;
        document.getElementById('p_zona').value = "-";
        setTimeout(() => { saveData(); }, 300);
    }
}


function fillData(m) {
    const jenis = document.getElementById('p_jenis').value;
    const faktur = document.getElementById('p_faktur').value;
    const kodeToko = document.getElementById('p_kode').value.toUpperCase();
    
    document.getElementById('p_plu').value = m.plu || "-";
    document.getElementById('p_descp').value = m.descp || "-";
    document.getElementById('p_zona').value = m.zona || "-";
    
    let totalTargetToko = 0;

    if (jenis === "KONTAINER") {
        totalTargetToko = 1; // Kontainer selalu 1
    } else {
        const currentDB = (jenis === "MANUAL") ? dbManual : dbPickAuto;
        // Cari di database asli untuk PLU ini di faktur & toko ini
        currentDB.forEach(item => { 
            if (String(item.faktur) === String(faktur) && 
                String(item.kodeToko) === String(kodeToko) && 
                String(item.plu) === String(m.plu)) {
                totalTargetToko += parseInt(item.qtyData || 0); 
            }
        });
    }
    
    document.getElementById('p_qty_data').value = totalTargetToko;
    document.getElementById('area_fisik').style.display = 'block';
}

// --- 4. FUNGSI SAVE DATA (BERSIHKAN SEMUA) ---
async function saveData() {
    const petugasAktif = currentUser || localStorage.getItem('activeUser') || "Tanpa Nama";
    const qtyInp = document.getElementById('p_qty_input');
    const jenis = document.getElementById('p_jenis').value;
    const kodeToko = document.getElementById('p_kode').value.toUpperCase();
    const fakturVal = document.getElementById('p_faktur').value;
    const pluVal = document.getElementById('p_plu').value;
    const barcodeVal = document.getElementById('p_scan_label').value;
    
    if (!qtyInp.value || qtyInp.value <= 0) return notify("Isi Qty!", "error", "p_qty_input");

    // --- REVISI KHUSUS LOGIKA NO KONTAINER ---
    let noKontainer = "-"; 

    if (jenis === "KONTAINER") {
        // Ambil dari barcode: K0001-R540 atau -K0001-R540
        let bersih = barcodeVal.startsWith("-") ? barcodeVal.substring(1) : barcodeVal;
        noKontainer = bersih.split("-")[0].toUpperCase().trim();
    } 
    else if (jenis === "DOS") {
        // Ambil dari Lookup dbPickAuto
        const item = dbPickAuto.find(i => String(i.faktur).trim() === String(fakturVal).trim() && String(i.plu).trim() === String(pluVal).trim());
        noKontainer = item ? (item.kontainer || item[5] || "-") : "-";
    }
    // ------------------------------------------

    const kelompokNonScan = ["NON-PTL","TELUR", "MKT", "ATK GS", "MATERAI"];
    updateBadge(); 

    if (kelompokNonScan.includes(jenis)) {
        const dataLangsung = [{
            tgl: document.getElementById('p_tgl').value,
            jenis: jenis,
            kode: kodeToko,
            nama: document.getElementById('p_nama').value,
            urpick: document.getElementById('p_urpick').value,
            faktur: fakturVal,
            zona: document.getElementById('p_zona').value || "-",
            barcode: "NON-SCAN",
            plu: document.getElementById('p_plu').value || "MANUAL",
            descp: document.getElementById('p_descp').value || "-",
            qty_data: 0,
            qty_scan: parseInt(qtyInp.value),
            keterangan: "",            
            petugas: petugasAktif,
            kontainer: noKontainer // Masuk ke kolom P
        }];
        await kirimDataLangsung(dataLangsung);
    } else {
        let q = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        q.push({
            tgl: document.getElementById('p_tgl').value,
            jenis: jenis,
            kode: kodeToko,
            nama: document.getElementById('p_nama').value,
            urpick: document.getElementById('p_urpick').value,
            faktur: fakturVal,
            zona: document.getElementById('p_zona').value,
            barcode: document.getElementById('p_scan_label').value,
            plu: document.getElementById('p_plu').value,
            descp: document.getElementById('p_descp').value,
            qty_data: parseInt(document.getElementById('p_qty_data').value || 0),
            qty_scan: parseInt(qtyInp.value),
            keterangan: "",            
            petugas: petugasAktif,
            kontainer: noKontainer // Masuk ke kolom P
        });
        localStorage.setItem('q_polcek', JSON.stringify(q));
        updateBadge();

        const toReset = ['p_scan_label', 'p_scan_fisik', 'p_plu', 'p_descp', 'p_zona', 'p_qty_input', 'p_qty_data'];
        toReset.forEach(id => { 
            if(document.getElementById(id)) document.getElementById(id).value = ""; 
        });
        afterSaveFocus(jenis); 
    }
}

async function kirimDataLangsung(data) {
    const loader = document.getElementById('loader');
    loader.style.display = 'flex'; 
    
    // âœ… OPTIMASI: Set timeout 5 detik
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    
    try {
        const res = await fetch(G_URL, { 
            method: 'POST', 
            signal: controller.signal,
            body: JSON.stringify({ action: "syncBatch", data: data }) 
        });
        
        clearTimeout(timeoutId);
        
        // âœ… OPTIMASI: Optimistic update - langsung anggap sukses
        data.forEach(d => dbSudahPolcek.push(d)); 
        
        // âœ… OPTIMASI: Langsung sembunyikan loader tanpa nunggu response
        loader.style.display = 'none'; 
        
        // Proses response di background
        res.json().then(out => {
            if (out.status !== "success") {
                // Handle error di background
                console.log("Background sync issue:", out);
            }
        }).catch(err => {
            console.log("Background error:", err);
        });
        
        // âœ… LANGSUNG LANJUT tanpa nunggu
        Swal.fire({
            icon: 'success',
            title: 'Berhasil',
            text: 'Data terkirim!',
            timer: 1000,
            toast: true,
            position: 'top-end'
        });
        
        clearAllFieldsInternal(); 
        
    } catch (e) {
        clearTimeout(timeoutId);
        loader.style.display = 'none';
        
        if (e.name === 'AbortError') {
            // âœ… OPTIMASI: Timeout tapi data mungkin sudah masuk
            data.forEach(d => dbSudahPolcek.push(d));
            Swal.fire({
                icon: 'warning',
                title: 'Proses Background',
                text: 'Data sedang diproses, silakan lanjut',
                timer: 1500
            });
            clearAllFieldsInternal();
        } else {
            Swal.fire("Gagal", "Cek Koneksi Server", "error");
        }
    }
}

function afterSaveFocus(jenis) {
    const kelompokNonScan = ["NON-PTL", "TELUR", "MKT", "ATK GS", "MATERAI"];

    // 1. Reset field input
    ['p_scan_label', 'p_scan_fisik', 'p_plu', 'p_descp', 'p_zona', 'p_qty_input', 'p_qty_data'].forEach(id => {
        if (document.getElementById(id)) document.getElementById(id).value = "";
    });

    const qtyInp = document.getElementById('p_qty_input');
    const areaFisik = document.getElementById('area_fisik');

    // 2. Logika Berdasarkan Jenis
    if (kelompokNonScan.includes(jenis)) {
        // KHUSUS NON-SCAN: Sembunyikan area fisik & reset dropdown
        if (areaFisik) areaFisik.style.display = 'none';
        document.getElementById('p_jenis').value = "";
        setFocus('p_jenis');
        
    } else if (jenis === "DOS" || jenis === "MANUAL") {
        // KHUSUS DOS/MANUAL: Pastikan area fisik MUNCUL & fokus ke SCAN FISIK
        if (areaFisik) areaFisik.style.display = 'block';
        qtyInp.readOnly = true;
        qtyInp.style.background = "#eeeeee";
        
        setTimeout(() => {
            const inpFisik = document.getElementById('p_scan_fisik');
            if (inpFisik) inpFisik.focus();
        }, 300);

    } else {
        // UNTUK KONTAINER / TAG I: Sembunyikan fisik & fokus ke SCAN LABEL
        if (areaFisik) areaFisik.style.display = 'none';
        qtyInp.readOnly = (jenis === "KONTAINER"); // Kontainer terkunci, TAG I mungkin tidak
        
        setTimeout(() => {
            const inpLabel = document.getElementById('p_scan_label');
            if (inpLabel) inpLabel.focus();
        }, 300);
    }
}

async function prosesFinalisasi() {
    const jenisAktif = document.getElementById('p_jenis').value;
    const fakturAktif = document.getElementById('p_faktur').value;
    const kodeAktif = document.getElementById('p_kode').value;

    // 1. Sembunyikan modal antrean/report saat konfirmasi muncul
    const modalReport = document.getElementById('modal_report');
    if (modalReport) modalReport.style.display = 'none';

    const { isConfirmed } = await Swal.fire({ 
        title: 'Kirim Data?', 
        text: "Data akan masuk ke GSheet & Monitoring",
        icon: 'question', 
        showCancelButton: true,
        confirmButtonText: 'Ya, Kirim!',
        cancelButtonText: 'Batal'
    });

    // 2. JIKA BATAL: Munculkan kembali modal antrean agar user bisa edit/cek lagi
    if (!isConfirmed) {
        if (modalReport) modalReport.style.display = 'block';
        return;
    }

    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'flex'; 

    try {
        let allLocalData = JSON.parse(localStorage.getItem('q_polcek') || "[]");
        const dataToSend = allLocalData.filter(i => i.jenis === jenisAktif && i.faktur === fakturAktif && i.kode === kodeAktif);

        if (dataToSend.length === 0) throw new Error("Tidak ada data");

        const res = await fetch(G_URL, { 
            method: 'POST', 
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: "syncBatch", data: dataToSend }) 
        });
        
        const out = await res.json();
        if (loader) loader.style.display = 'none'; 

        if (out.status === "success") {
            // Logika Optimistic Update (Kuncian Lokal)
            let tempFinal = JSON.parse(localStorage.getItem('temp_final_polcek') || "[]");
            dataToSend.forEach(d => {
                const item = { tgl: d.tgl, kode: d.kode, jenis: d.jenis, faktur: d.faktur };
                dbSudahPolcek.push(item); 
                tempFinal.push(item);
            });
            localStorage.setItem('temp_final_polcek', JSON.stringify(tempFinal));

            // Hapus data dari antrean
            const sisaData = allLocalData.filter(i => !(i.jenis === jenisAktif && i.faktur === fakturAktif && i.kode === kodeAktif));
            localStorage.setItem('q_polcek', JSON.stringify(sisaData));
            
            // 3. TUTUP SEMUA MODAL SECARA PERMANEN
            if (modalReport) modalReport.style.display = 'none';
            
            updateBadge();
            clearAllFieldsInternal(); // Kembali ke Header & Fokus Kode Store

            Swal.fire({ 
                icon: 'success', 
                title: 'Terkirim!', 
                timer: 1000, 
                showConfirmButton: false, 
                toast: true, 
                position: 'top-end' 
            });
        }
    } catch (e) { 
        if (loader) loader.style.display = 'none';
        // JIKA GAGAL: Kembalikan modal agar user tahu data belum terkirim
        if (modalReport) modalReport.style.display = 'block';
        Swal.fire("Gagal", "Koneksi bermasalah, data tetap di antrean.", "error"); 
    }
}

function clearAllFieldsInternal() {
    // Tanggal dan Jenis TIDAK dikosongkan agar kerja lebih cepat
    document.getElementById('p_kode').value = "";
    document.getElementById('p_nama').value = "";
    document.getElementById('p_urpick').value = "";
    document.getElementById('p_faktur').value = "";
    
    // Langsung arahkan fokus ke Kode Toko jika Jenis sudah ada
    document.getElementById('p_kode').focus(); 
    
    toggleArea('HEADER');
}

    // ==========================================
    // UI HELPER & MONITORING
    // ==========================================
    function setFocus(id) {
        setTimeout(() => {
            const el = document.getElementById(id);
            if (el) { el.focus(); if (typeof el.select === 'function') el.select(); }
        }, 350);
    }

    function notify(msg, type = 'success', nextId = 'p_scan_label') {
        Swal.fire({ title: msg, icon: type, timer: 1500, showConfirmButton: false, didClose: () => { setFocus(nextId); }});
    }

    function updateBadge() {
    // Ambil data antrean dari LocalStorage
    const allLocalData = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    
    // ðŸ”¥ PERBAIKAN: Hitung berdasarkan kombinasi unik (faktur + kode + jenis)
    // Gunakan Set dengan composite key
    const uniqueGroups = new Set();
    
    allLocalData.forEach(item => {
        // Buat key unik: faktur|kode|jenis
        const compositeKey = `${item.faktur}|${item.kode}|${item.jenis}`;
        uniqueGroups.add(compositeKey);
    });
    
    // Jumlah antrean = jumlah group unik
    const jumlahAntrean = uniqueGroups.size;

    // Update angka di Badge Besar (jika ada)
    const badgeBesar = document.getElementById('antrian_badge');
    if (badgeBesar) {
        badgeBesar.innerText = jumlahAntrean > 0 ? `ANTREAN: ${jumlahAntrean} TOKO` : "BELUM ADA ANTREAN";
    }

    // Update angka di Tombol Navigasi (badge_small)
    const badgeKecil = document.getElementById('badge_small');
    if (badgeKecil) {
        badgeKecil.innerText = jumlahAntrean;
    }
    
    console.log(`Badge updated: ${jumlahAntrean} groups from ${allLocalData.length} items`);
}

    function focusToNext() {
        resetScanField();
        const jenis = document.getElementById('p_jenis').value;
        if (["KONTAINER", "DOS", "MANUAL", "TAG I"].includes(jenis)) {
            setFocus('p_scan_label');
        } else {
            const qtyInp = document.getElementById('p_qty_input');
            qtyInp.readOnly = false; qtyInp.style.background = "white";
            document.getElementById('p_scan_label').value = "NON-SCAN";
            setFocus('p_qty_input');
        }
    }

    function clearAllFields() {
    // 1. Kosongkan semua ID input
    const idsToClear = [
        'p_kode', 'p_nama', 'p_urpick', 
        'p_scan_label', 'p_scan_fisik', 'p_plu', 
        'p_descp', 'p_zona', 'p_qty_input', 'p_qty_data'
    ];

    updateBadge();
    idsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
    });

    // 2. Reset Pilihan Dropdown
    const pJenis = document.getElementById('p_jenis');
    if (pJenis) pJenis.value = ""; 

    const pFaktur = document.getElementById('p_faktur');
    if (pFaktur) pFaktur.innerHTML = '<option value="">-- PILIH FAKTUR --</option>';

    // 3. Sembunyikan Area Fisik
    const areaFisik = document.getElementById('area_fisik');
    if (areaFisik) areaFisik.style.display = 'none';

    // 4. PINDAH LAYAR: Tampilkan Header, Sembunyikan Scan
    document.getElementById('group_header').style.display = 'block';
    document.getElementById('group_scan').style.display = 'none';

    // 5. FOKUS KURSOR KEMBALI KE JENIS
    setTimeout(() => {
        const inputJenis = document.getElementById('p_jenis');
        if (inputJenis) inputJenis.focus();
    }, 200);

    console.log("Form dibersihkan, kembali ke pemilihan Jenis.");
}

async function showMonitoring() {
    const tglRaw = document.getElementById('p_tgl').value; 
    if (!tglRaw) {
        Swal.fire("Pilih Tanggal", "Tentukan tanggal proses", "warning");
        return;
    }

    await sinkronDataServer();

    const tglTarget = String(tglRaw).substring(0, 10).trim();
    document.getElementById('monitor_date').innerHTML = `TANGGAL PROSES: <span style="color: #2980b9;">${tglTarget}</span>`;

    const clean = v => String(v || "").trim().toUpperCase();
    let monitorMap = {};

    // MASTER DATA
    const masterData = [
        ...dbPickAuto.map(d => ({ ...d, src: 'PA' })),
        ...dbManual.map(d => ({ ...d, src: 'MN' }))
    ];

    masterData.forEach(item => {
        let tglM = item.tglInput || item.tgl; 
        const tglMaster = String(tglM || "").substring(0, 10).trim();

        if (tglMaster !== tglTarget) return; 

        const kode = clean(item.kodeToko);
        if (!kode) return;

        if (!monitorMap[kode]) {
    monitorMap[kode] = { 
        urpick: String(item.urpick || ""),
        kode: kode,
        namaToko: item.namaToko || "", // ðŸ”¥ TAMBAHKAN INI
        tKN: 0, tDS: 0, tMN: 0, 
        sKN: 0, sDS: 0, sMN: 0, 
        hasRemark: false,
        uKN: [], uDS: [], uMN: [] 
    };
}

        if (item.src === 'MN') {
            monitorMap[kode].tMN += parseInt(item.qtyData || 0);
        } else {
            const kont = clean(item.kontainer);
            if (kont.startsWith("DOS")) {
                monitorMap[kode].tDS += parseInt(item.qtyData || 0);
            } else if (kont !== "") {
                monitorMap[kode].tKN += 1;
            }
        }
    });

    // DATA SCAN
    dbSudahPolcek.forEach(s => {
        const tglScan = String(s.tgl || "").substring(0, 10).trim();
        if (tglScan !== tglTarget) return; 

        const kode = clean(s.kode);
        const jenis = clean(s.jenis);
        const pgw = s.petugas || "SAYA"; 

        if (monitorMap[kode]) {
            if (jenis === "KONTAINER") {
                monitorMap[kode].sKN += parseInt(s.qty_scan || 0);
                if (pgw && !monitorMap[kode].uKN.includes(pgw)) monitorMap[kode].uKN.push(pgw);
            } 
            else if (jenis === "DOS") {
                monitorMap[kode].sDS += parseInt(s.qty_scan || 0);
                if (pgw && !monitorMap[kode].uDS.includes(pgw)) monitorMap[kode].uDS.push(pgw);
            } 
            else if (jenis === "MANUAL") {
                monitorMap[kode].sMN += parseInt(s.qty_scan || 0);
                if (pgw && !monitorMap[kode].uMN.includes(pgw)) monitorMap[kode].uMN.push(pgw);
            }

            if (clean(s.keterangan) !== "") monitorMap[kode].hasRemark = true;
        }
    });

    
window.lastMonitorData = monitorMap;
    renderMonitorTable(monitorMap);
    
    document.getElementById('modal_monitor').style.display = 'block';
}

function renderMonitorTable(dataMap) {
    const totalContainer = document.getElementById('total_card_container');
    const contentContainer = document.getElementById('monitor_content');
    
    if (!totalContainer || !contentContainer) return;
    
    // Hitung total
    const total = Object.values(dataMap).reduce((acc, d) => {
        acc.tKN += d.tKN || 0;
        acc.sKN += d.sKN || 0;
        acc.tDS += d.tDS || 0;
        acc.sDS += d.sDS || 0;
        acc.tMN += d.tMN || 0;
        acc.sMN += d.sMN || 0;
        acc.totalToko++;
        return acc;
    }, { tKN:0, sKN:0, tDS:0, sDS:0, tMN:0, sMN:0, totalToko:0 });

    // Hitung progress
    const totalTarget = total.tKN + total.tDS + total.tMN;
    const totalScan = total.sKN + total.sDS + total.sMN;
    const progress = totalTarget > 0 ? Math.round((totalScan / totalTarget) * 100) : 0;
    const sisa = totalTarget - totalScan;

    // TOTAL CARD
    totalContainer.innerHTML = `
        <div style="text-align:center; margin-bottom:5px;">
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px; background:linear-gradient(135deg, #2c3e50, #34495e); color:white; padding:10px; border-radius:8px; margin-bottom:5px;">
                <div>
                    <div style="font-size:10px;">TOKO</div>
                    <div style="font-size:20px; font-weight:bold;">${total.totalToko}</div>
                </div>
                <div>
                    <div style="font-size:10px;">PROGRESS</div>
                    <div style="font-size:20px; font-weight:bold;">${progress}%</div>
                </div>
                <div>
                    <div style="font-size:10px;">SISA</div>
                    <div style="font-size:20px; font-weight:bold; color:#ffaa00;">${sisa}</div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px; background:#f8f9fa; padding:8px; border-radius:8px; font-size:12px;">
                <div><span style="font-weight:bold;">KN:</span> ${total.tKN}/${total.sKN}</div>
                <div><span style="font-weight:bold;">DOS:</span> ${total.tDS}/${total.sDS}</div>
                <div><span style="font-weight:bold;">MN:</span> ${total.tMN}/${total.sMN}</div>
            </div>
        </div>
    `;

    // Konversi ke array dan sortir berdasarkan URPICK
    let dataArray = Object.values(dataMap).map(d => ({
        ...d,
        urpick: String(d.urpick || ""),
        kode: String(d.kode || ""),
        // ðŸ”¥ Ambil nama toko dari dataMap (perlu ditambahkan di showMonitoring)
        namaToko: String(d.namaToko || ""),
        urpickNum: parseInt(String(d.urpick).replace(/[^0-9]/g, '')) || 0
    }));

    // Sorting default URPICK kecil ke besar
    dataArray.sort((a, b) => a.urpickNum - b.urpickNum);

    // ðŸ”¥ FUNGSI: Ambil inisial toko dari nama toko (4 huruf dalam [ ])
    const getInisialToko = (namaToko) => {
        if (!namaToko) return '';
        
        // Cari pola dalam kurung siku [INISIAL]
        const match = namaToko.match(/\[([^\]]+)\]/);
        if (match && match[1]) {
            // Ambil 4 huruf pertama dari dalam kurung
            return match[1].substring(0, 4).toUpperCase();
        }
        
        // Jika tidak ada kurung, ambil 4 huruf pertama dari nama
        return namaToko.replace(/[^A-Za-z]/g, '').substring(0, 4).toUpperCase();
    };

    // ðŸ”¥ FUNGSI: Ambil nama depan petugas
    const getNamaDepan = (namaLengkap) => {
        if (!namaLengkap) return '';
        return namaLengkap.split(' ')[0];
    };

    // ðŸ”¥ FUNGSI: Format user list di BARIS BARU
    const formatUserList = (users) => {
        if (!users || users.length === 0) return '';
        
        const unique = [...new Set(users)].filter(u => u && u.trim() !== '');
        if (unique.length === 0) return '';
        
        const namaDepan = unique.map(u => getNamaDepan(u));
        const displayNama = namaDepan.length > 1 
            ? namaDepan.join(' & ') 
            : namaDepan[0];
        
        return `<span style="color:#2c3e50; font-size:8px; display:block; margin-top:2px; font-weight:normal;">${displayNama}</span>`;
    };

    // TABLE HEADER
    let tableHtml = `
        <div style="background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-top:8px;">
            <table style="width:100%; border-collapse:collapse; font-size:11px;">
                <thead>
                    <tr style="background:#2c3e50; color:white;">
                        <th style="padding:8px 4px; text-align:center; width:10%;">URP</th>
                        <th style="padding:8px 4px; text-align:left; width:15%;">TOKO</th>
                        <th style="padding:8px 4px; text-align:center; width:20%;">KN</th>
                        <th style="padding:8px 4px; text-align:center; width:20%;">DOS</th>
                        <th style="padding:8px 4px; text-align:center; width:20%;">MN</th>
                        <th style="padding:8px 4px; text-align:center; width:5%;">ST</th>
                    </tr>
                </thead>
                <tbody>`;

    dataArray.forEach(d => {
        const tKN = d.tKN || 0;
        const sKN = d.sKN || 0;
        const tDS = d.tDS || 0;
        const sDS = d.sDS || 0;
        const tMN = d.tMN || 0;
        const sMN = d.sMN || 0;
        
        // ðŸ”¥ Ambil inisial toko
        const inisialToko = getInisialToko(d.namaToko);
        
        // Warna baris
        let rowBg = '#ffffff';
        let statusIcon = 'âœ…';
        let statusColor = '#27ae60';
        
        if (tKN === 0 && tDS === 0 && tMN === 0) {
            rowBg = '#f8f9fa';
            statusIcon = 'â¸ï¸';
            statusColor = '#7f8c8d';
        } else if (tKN === sKN && tDS === sDS && tMN === sMN) {
            rowBg = '#f0fff4';
            statusIcon = 'âœ…';
            statusColor = '#27ae60';
        } else if (d.hasRemark) {
            rowBg = '#fff9e6';
            statusIcon = 'âš ï¸';
            statusColor = '#f39c12';
        } else {
            rowBg = '#fff0f0';
            statusIcon = 'â³';
            statusColor = '#c0392b';
        }

        // Format angka + nama di bawah
        const formatAngka = (target, scan, users) => {
            if (target === 0) {
                return `<span style="color:#95a5a6;">0/0</span>`;
            }
            
            const color = target > scan ? '#c0392b' : '#27ae60';
            let html = `<span style="color:${color}; font-weight:bold;">${target}</span><span style="color:#7f8c8d;">/${scan}</span>`;
            html += formatUserList(users);
            return html;
        };

        tableHtml += `
            <tr style="background-color: ${rowBg}; border-bottom:1px solid #e9ecef;">
                <td style="padding:8px 4px; text-align:center; font-weight:bold;">${d.urpick || '-'}</td>
                <td style="padding:8px 4px; text-align:left;">
                    <b>${d.kode || '-'}</b>
                    ${inisialToko ? `<span style="color:#7f8c8d; font-size:8px; display:block; margin-top:2px;">${inisialToko}</span>` : ''}
                </td>
                <td style="padding:8px 4px; text-align:center;">${formatAngka(tKN, sKN, d.uKN)}</td>
                <td style="padding:8px 4px; text-align:center;">${formatAngka(tDS, sDS, d.uDS)}</td>
                <td style="padding:8px 4px; text-align:center;">${formatAngka(tMN, sMN, d.uMN)}</td>
                <td style="padding:8px 4px; text-align:center; font-size:16px; color:${statusColor};">${statusIcon}</td>
            </tr>`;
    });

    tableHtml += `</tbody></table></div>`;
    
    // Legenda
    tableHtml += `
        <div style="margin-top:10px; display:flex; gap:12px; justify-content:center; font-size:9px; padding:10px; background:white; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <span><span style="color:#27ae60;">âœ…</span> Komplit</span>
            <span><span style="color:#c0392b;">â³</span> Kurang</span>
            <span><span style="color:#f39c12;">âš ï¸</span> Selisih</span>
            <span><span style="color:#7f8c8d;">â¸ï¸</span> No Target</span>
        </div>`;

    contentContainer.innerHTML = tableHtml;
}

// ðŸ”¥ FUNGSI REFRESH (tanpa sorting)
async function refreshMonitoringData() {
    const loader = document.getElementById('loader');
    const modalMonitor = document.getElementById('modal_monitor');

    modalMonitor.style.display = 'none';
    loader.style.display = 'flex';

    try {
        const res = await fetch(G_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "getAllData" })
        });
        const out = await res.json();

        if (out.status === "success") {
            dbSudahPolcek = (out.dataSudahPolcek || []).map(r => ({
                tgl: String(r.tgl || "").substring(0, 10),
                kode: String(r.kode || "").trim().toUpperCase(),
                jenis: String(r.jenis || "").trim().toUpperCase(),
                barcode: String(r.barcode || "").trim().toUpperCase(), 
                qty_scan: Number(r.qty_scan || 0)
            }));
        }
    } catch (e) {
        Swal.fire("Gagal", "Koneksi Bermasalah", "error");
    } finally {
        loader.style.display = 'none';
        showMonitoring(); 
    }
}

function closeMonitoring() {
    // 1. Tutup semua modal
    if (document.getElementById('modal_report')) document.getElementById('modal_report').style.display = 'none';
    if (document.getElementById('modal_monitor')) document.getElementById('modal_monitor').style.display = 'none';

    // 2. Ambil data dengan proteksi Trim
    const fakturAktif = document.getElementById('p_faktur').value;
    const jenisRaw = document.getElementById('p_jenis').value;
    const jenis = String(jenisRaw || "").trim().toUpperCase();

    if (fakturAktif !== "") {
        // Tampilkan kontainer utama
        document.getElementById('group_header').style.display = 'none';
        document.getElementById('group_scan').style.display = 'block';
        
        // ðŸ”¥ PERBAIKAN: Ganti ID sesuai dengan HTML yang ada
        const rowScanLabel = document.getElementById('row_scan_label'); // â† ini yang benar
        const areaFisik = document.getElementById('area_fisik');         // â† ini yang benar
        // const divQty = document.getElementById('div_qty_manual');     // â† ini tidak ada di HTML

        // Sembunyikan SEMUA dulu untuk reset state
        if (rowScanLabel) rowScanLabel.style.display = 'none';
        if (areaFisik) areaFisik.style.display = 'none';
        
        // Untuk kelompok Non-Scan, kita atur qty_input bisa diedit
        const qtyInput = document.getElementById('p_qty_input');
        const kelompokNonScan = ["NON-PTL", "TELUR", "MKT", "ATK GS", "MATERAI"];

        // LOGIKA BARU: Sesuai dengan struktur HTML yang ada
        if (jenis === "DOS" || jenis === "MANUAL") {
            // Untuk DOS/MANUAL: Tampilkan area fisik
            if (areaFisik) {
                areaFisik.style.display = 'block';
                console.log("DEBUG: Menampilkan area_fisik untuk jenis " + jenis);
            }
            // Label juga perlu ditampilkan karena row_scan_label berisi input scan_label
            if (rowScanLabel) {
                rowScanLabel.style.display = 'flex'; // Pakai flex karena di CSS pakai display:flex
            }
            
            // Atur qty_input readonly
            if (qtyInput) {
                qtyInput.readOnly = true;
                qtyInput.style.background = "#eeeeee";
            }
        } 
        else if (kelompokNonScan.includes(jenis)) {
            // Untuk Non-Scan: Sembunyikan area fisik, tampilkan qty manual
            if (rowScanLabel) rowScanLabel.style.display = 'none';
            if (areaFisik) areaFisik.style.display = 'none';
            
            // Qty input bisa diedit
            if (qtyInput) {
                qtyInput.readOnly = false;
                qtyInput.style.background = "white";
                document.getElementById('p_scan_label').value = "NON-SCAN";
            }
        } 
        else {
            // Untuk KONTAINER, TAG I: Tampilkan hanya scan label
            if (rowScanLabel) {
                rowScanLabel.style.display = 'flex';
            }
            if (areaFisik) areaFisik.style.display = 'none';
            
            // Qty input readonly
            if (qtyInput) {
                qtyInput.readOnly = true;
                qtyInput.style.background = "#eeeeee";
            }
        }
        
        // Jalankan fokus kursor
        fokusKeInputScan();
        
    } else {
        document.getElementById('group_header').style.display = 'block';
        document.getElementById('group_scan').style.display = 'none';
        setTimeout(() => { document.getElementById('p_kode').focus(); }, 300);
    }
}


function fokusKeInputScan() {
    const jenis = document.getElementById('p_jenis').value;
    const kelompokNonScan = ["NON-PTL", "TELUR", "MKT", "ATK GS", "MATERAI"];

    setTimeout(() => {
        if (kelompokNonScan.includes(jenis)) {
            document.getElementById('p_qty_input').focus();
        } else if (jenis === "DOS" || jenis === "MANUAL") {
            document.getElementById('p_scan_fisik').focus();
        } else {
            document.getElementById('p_scan_label').focus();
        }
    }, 300);
}

async function sinkronDataServer() {
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'flex'; 

    try {
        // Tambahkan timestamp ?t= agar bypass cache browser
        const res = await fetch(G_GITHUB_URL + "?t=" + new Date().getTime());
        if (!res.ok) throw new Error("GitHub sedang sibuk");

        const out = await res.json();
        
        // --- PROSES PENGGABUNGAN (MERGE) ---
        let serverData = out.dataSudahPolcek || [];
        let localTemp = JSON.parse(localStorage.getItem('temp_final_polcek') || "[]");

        // Satukan data server dengan data yang baru saja dikirim di HP ini
        dbSudahPolcek = [...serverData, ...localTemp];

        // Cleanup: Hapus data di localStorage jika di server sudah muncul (sudah sinkron)
        const filteredLocal = localTemp.filter(l => 
            !serverData.some(s => 
                String(s.faktur).trim() === String(l.faktur).trim() && 
                String(s.kode).trim() === String(l.kode).trim() &&
                String(s.jenis).trim().toUpperCase() === String(l.jenis).trim().toUpperCase()
            )
        );
        localStorage.setItem('temp_final_polcek', JSON.stringify(filteredLocal));
        
        console.log("Sinkronisasi Berhasil: Data Server & Lokal digabungkan.");

    } catch (e) {
        console.warn("Gagal ambil dari GitHub, menggunakan data lokal yang ada.");
        // Jika offline, pastikan RAM tetap berisi data kuncian terakhir
        let localTemp = JSON.parse(localStorage.getItem('temp_final_polcek') || "[]");
        if (dbSudahPolcek.length === 0) dbSudahPolcek = localTemp;
    } finally {
        if (loader) loader.style.display = 'none'; 
    }
}

async function ambilDataLangsungGSheet() {
    try {
        const res = await fetch(G_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "getMonitoring" })
        });
        const out = await res.json();
        if (out.status === "success") {
            dbSudahPolcek = out.dataSudahPolcek || [];
        }
    } catch (err) {
        console.error("GSheet juga gagal:", err);
    }
}

async function revisiQty(index) {
    // 1. Ambil data asli dari LocalStorage
    let allData = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    let item = allData[index];

    if (!item) return Swal.fire("Error", "Data tidak ditemukan!", "error");

    // 2. Tutup modal utama agar tidak menumpuk
    document.getElementById('modal_report').style.display = 'none';

    // 3. Minta OTP (Keamanan)
    const { value: otp } = await Swal.fire({ 
        title: 'Otoritas Revisi', 
        input: 'password', 
        inputLabel: 'Masukkan PIN Revisi (OTP)', 
        showCancelButton: true 
    });

    // Cek OTP
    if (otp !== "234") {
        if (otp !== undefined) await Swal.fire("Error", "OTP Salah!", "error");
        showReport(); // Kembalikan ke modal report
        return;
    }

    // 4. Jika OTP Benar, Munculkan Form Gabungan (Qty + Keterangan)
    const { value: formValues } = await Swal.fire({
        title: 'Form Revisi Data',
        html:
            `<div style="text-align:left; font-size:14px;">` +
            `<p>Item: <b>${item.descp || item.plu}</b></p>` +
            `<p>Target Faktur: <b>${item.qty_data}</b></p>` +
            `<hr>` +
            `<label><b>Qty Scan Baru:</b></label>` +
            `<input id="swal-qty" class="swal2-input" type="number" value="${item.qty_scan}">` +
            `<label><b>Keterangan Selisih:</b></label>` +
            `<textarea id="swal-ket" class="swal2-textarea" placeholder="Wajib diisi jika Qty Scan tidak sesuai Target">${item.keterangan || ""}</textarea>` +
            `</div>`,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Simpan Perubahan',
        preConfirm: () => {
            const nQty = parseInt(document.getElementById('swal-qty').value);
            const nKet = document.getElementById('swal-ket').value.trim();
            
            // Validasi 1: Qty tidak boleh lebih besar dari target (untuk DOS/MANUAL)
            if ((item.jenis === "DOS" || item.jenis === "MANUAL") && nQty > item.qty_data) {
                Swal.showValidationMessage(`Qty (${nQty}) melebihi target (${item.qty_data})!`);
                return false;
            }
            
            // Validasi 2: Wajib isi keterangan jika tidak match
            if (nQty !== item.qty_data && nKet === "") {
                Swal.showValidationMessage(`Keterangan wajib diisi jika ada selisih!`);
                return false;
            }
            
            return { qty: nQty, ket: nKet };
        }
    });

    // 5. Eksekusi Update Data
    if (formValues) {
        let qtyBaru = formValues.qty;
        let ketBaru = formValues.ket;

        if (item.jenis === "DOS" || item.jenis === "MANUAL") {
            // Logika anti-double: bersihkan baris lain dengan PLU & Faktur yang sama
            allData = allData.filter((val, idx) => {
                if (idx === index) return true; // Simpan baris ini
                return !(val.plu === item.plu && val.faktur === item.faktur);
            });
            
            // Update baris yang tersisa
            const targetIdx = allData.findIndex(x => x === item);
            if (targetIdx !== -1) {
                allData[targetIdx].qty_scan = qtyBaru;
                allData[targetIdx].keterangan = ketBaru;
            }
        } else {
            // Untuk KONTAINER dsb, update langsung berdasarkan index
            allData[index].qty_scan = qtyBaru;
            allData[index].keterangan = ketBaru;
        }

        // Simpan ke LocalStorage
        localStorage.setItem('q_polcek', JSON.stringify(allData));
        
        await Swal.fire({ icon: "success", title: "Berhasil", text: "Data diperbarui", timer: 1000, showConfirmButton: false });
    }

    // 6. Apapun hasilnya, kembali buka modal report
    showReport(); 
}

function showReport() {
    const tglRaw = document.getElementById('p_tgl').value;
    const kode = document.getElementById('p_kode').value.trim().toUpperCase();
    const jenis = document.getElementById('p_jenis').value;
    const faktur = document.getElementById('p_faktur').value;
    
    if (!tglRaw || !kode || !faktur) return Swal.fire("Peringatan", "Lengkapi data Toko dan Faktur!", "warning");

    // DATA ANTRIAN LOKAL SAJA (Untuk keperluan Revisi/Finalisasi)
    const scanDB = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    const aktualData = scanDB.filter(i => i.tgl === tglRaw && i.kode === kode && i.faktur === faktur && i.jenis === jenis);

    // LOGIKA PERBANDINGAN DATA (REPORT TABLE)
    const d = new Date(tglRaw);
    const tglCheck = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
    
    let reportMap = {};
    let isAllMatch = true; 
    let isComparisonType = ["KONTAINER", "DOS", "MANUAL"].includes(jenis);

if (isComparisonType) {
        const currentDB = (jenis === "MANUAL") ? dbManual : dbPickAuto;
        const targetData = currentDB.filter(i => {
            if (!(i.tglInput === tglCheck && i.kodeToko === kode && i.faktur === faktur)) return false;
            const kVal = (i.kontainer || "").toUpperCase();
            const isD = kVal.includes("DOS");
            return jenis === "KONTAINER" ? !isD : (jenis === "DOS" ? isD : true);
        });

        // 1. MEMBENTUK TARGET (Gunakan PLU sebagai Kunci Utama untuk DOS & MANUAL)
        targetData.forEach(item => {
            const kMaster = (item.kontainer || "MANUAL").toUpperCase();
            
            // KUNCI: Untuk DOS kita gabung Kontainer|PLU, Untuk MANUAL cukup PLU
            let key = (jenis === "KONTAINER") ? kMaster : (jenis === "DOS" ? `${kMaster} | ${item.plu}` : item.plu);
            
            if (!reportMap[key]) {
                reportMap[key] = { 
                    desc: (jenis === "KONTAINER") ? "" : (item.descp || kMaster), 
                    target: 0, 
                    scan: 0,
                    pluAsli: item.plu // Simpan PLU murni untuk pencocokan scan nanti
                };
            }
            reportMap[key].target += (jenis === "KONTAINER") ? 1 : parseInt(item.qtyData || 0);
        });

        // 2. MENGISI SCAN KE TARGET YANG MATCH
        aktualData.forEach(item => {
            let foundMatch = false;
            let keyScan = "";

            // --- LOGIKA PENENTUAN KEY SCAN BERDASARKAN JENIS ---
            if (jenis === "KONTAINER") {
                // Untuk Kontainer, kita ambil bagian depan barcode (misal: A1 dari A1-MKS-...)
                const parts = (item.barcode || "").split('-').filter(Boolean);
                keyScan = (parts[0] || "").toUpperCase();
                
                if (reportMap[keyScan]) {
                    reportMap[keyScan].scan += parseInt(item.qty_scan || 0);
                    foundMatch = true;
                }
            } 
            else {
                // UNTUK DOS & MANUAL (Sudah Oke)
                const itemPlu = String(item.plu).trim();
                Object.keys(reportMap).forEach(key => {
                    // Cek apakah PLU ada di dalam Key Target (misal: "DOS-A6 | 892360")
                    if (key === itemPlu || key.endsWith("| " + itemPlu) || key.includes(itemPlu)) {
                        reportMap[key].scan += parseInt(item.qty_scan || 0);
                        foundMatch = true;
                    }
                });
            }

            // 3. JIKA TIDAK MATCH (TETAP BUAT BARIS OVER SEBAGAI PERINGATAN)
            if (!foundMatch) {
                const itemPlu = String(item.plu).trim();
                const labelOver = (jenis === "KONTAINER") ? (item.barcode || "ERR") : itemPlu;
                reportMap[labelOver] = { 
                    desc: item.descp || "BARANG LUAR/SALAH SCAN", 
                    target: 0, 
                    scan: parseInt(item.qty_scan || 0) 
                };
            }
        });

// --- 2. KHUSUS JENIS TAG I (PENDATAAN MURNI) ---
    } else if (jenis === "TAG I") {
        aktualData.forEach(item => {
            // Gunakan Barcode sebagai Key agar setiap scan barcode yang berbeda muncul per baris
            let keyTag = item.barcode || "TANPA BARCODE";
            if (!reportMap[keyTag]) {
                reportMap[keyTag] = { 
                    desc: item.descp || "PENDATAAN TAG I", 
                    target: 0, // Tag I tidak punya target
                    scan: 0 
                };
            }
            reportMap[keyTag].scan += parseInt(item.qty_scan || 0);
        });
    }

    // GENERATE HTML TABEL
    let html = "";
    Object.keys(reportMap).forEach(key => {
        const r = reportMap[key];
        const itemDitemukan = aktualData.find(i => (i.plu === key || (i.barcode && i.barcode.includes(key)) || (key.includes(' | ') && i.plu === key.split(' | ')[1])));
        const indexAsli = scanDB.findIndex(x => x === itemDitemukan);
        const itemPunyaKet = itemDitemukan && itemDitemukan.keterangan ? itemDitemukan.keterangan : "";

        let status;

if (jenis === "TAG I") {
            // Untuk Tag I, asal sudah ada scan, langsung dianggap DONE agar bisa final
            status = r.scan > 0 ? "DONE" : "PENDING";
        }

else if (r.target === "N/A" || r.scan === r.target) {
            status = "DONE";
        } else if (itemPunyaKet !== "") {
            status = "SELISIH"; 
        } else {
            status = (r.scan < r.target ? "PENDING" : "OVER");
        }
        
        // Baris ini tetap (menentukan tombol final aktif/tidak)
        if (status !== "DONE" && status !== "SELISIH") isAllMatch = false;        
        const colorBg = status === 'DONE' ? '#d4edda' : (status === 'SELISIH' ? '#ffcc80' : (status === 'PENDING' ? '#f8d7da' : '#fff3cd'));
        const displayDesc = (jenis === "KONTAINER" || !r.desc) ? "" : `<br><small>${r.desc}</small>`;
        const ketTampil = itemPunyaKet ? `<br><i style="font-size:9px; color:brown;">Ket: ${itemPunyaKet}</i>` : "";

        html += `<tr style="background:${colorBg}">
            <td style="text-align:left; padding:5px;"><b>${key}</b>${displayDesc}${ketTampil}</td>
            <td>${r.target}</td>
            <td>${r.scan}</td>
            <td>
                <b>${status}</b><br>
                <button onclick="revisiQty(${indexAsli})" style="font-size:10px; background:#f39c12; color:white; border:none; border-radius:3px; padding:3px 8px;">REVISI</button>
            </td>
        </tr>`;
    });

    // --- BAGIAN UPDATE UI ---
    document.getElementById('report_info').innerHTML = `<b>${jenis}</b> | ${kode} | ${faktur}`;
    document.getElementById('report_body').innerHTML = html || "<tr><td colspan='4'>Belum ada data di antrian</td></tr>";
    document.getElementById('modal_report').style.display = 'block';

    // Update tombol Finalisasi
    const btnFin = document.getElementById('btn_finalisasi');
    if (btnFin) {
        btnFin.disabled = !(Object.keys(reportMap).length > 0 && isAllMatch);
        btnFin.style.opacity = btnFin.disabled ? "0.3" : "1";
    }

    // --- BAGIAN RIWAYAT (LIST ANTRIAN) ---
    const listAntrian = document.getElementById('list_antrian');
    if (listAntrian) {
        listAntrian.innerHTML = "";
        let gabungan = [...scanDB, ...dbSudahPolcek];
        gabungan.forEach((item) => {
            const namaPetugas = String(item.petugas || "ANONIM").toUpperCase();
            const userAktif = String(currentUser || "").toUpperCase();
            if (namaPetugas === userAktif) {
                let li = document.createElement('li');
                li.style.fontSize = "10px";
                listAntrian.appendChild(li);
            }
        });
    }
}

async function processStoreInput() {
    const kodeInput = document.getElementById('p_kode');
    if (kodeInput && kodeInput.value.trim() !== "") {
        let rawVal = kodeInput.value.trim().toUpperCase();
        const parts = rawVal.split('-').filter(Boolean);

        // --- LOGIKA EKSTRAKSI BARCODE LABEL ---
        if (parts.length > 1) {
            if (rawVal.includes("KONTAINER") || parts.length === 2) {
                rawVal = parts[1];
            } else if (rawVal.includes("DOS") || parts.length >= 4) {
                rawVal = parts[2];
            }
        }
        kodeInput.value = rawVal; 

        // Jalankan filter asli
        const found = runFilter(); 

        if (found) {
            // --- TAMBAHAN: LOGIKA POP UP TOKO KHUSUS ---
            const tokoKhusus = [
                "R053","R021","R454","R002","R089","R153","R339","R017","R512","R003","R264",
		"R152","R608","R451","R750","R472","R470","R130","R309","R590","R653","R617",
		"R829","R616","R154","R202","R103","R565","R184","R354","R385","R287","R236",
		"R672","R446","R363","R314","R323","R341","R151","R387","R444","R473","R474",
		"R283","R876","R860","R047","R640","R044","R430","R728","R632","R435"
            ];

            if (tokoKhusus.includes(rawVal)) {
                const namaToko = document.getElementById('p_nama').value || "";
                
                // Gunakan await Swal agar eksekusi berhenti sampai user klik OK
                await Swal.fire({
                    title: 'ðŸ“¢ PERHATIAN INI TOKO SAPA !!',
                    html: `Pastikan NO Order yang sudah di Lapak di Data !!`,
                    icon: 'warning',
                    confirmButtonText: 'SIAP, LANJUT',
                    confirmButtonColor: '#3085d6',
                    allowOutsideClick: false // User wajib klik tombol
                });
            }

            setFocus('p_faktur');
        } else {
            notify("âš ï¸ Toko tidak ditemukan!", "error", "p_kode");
        }
    }
}
function alurFokus(currentStep) {
    if (currentStep === 'tgl') {
        setFocus('p_jenis');
    } else if (currentStep === 'jenis') {
        setFocus('p_kode');
    } else if (currentStep === 'kode') {
        // runFilter() dipanggil di sini untuk mengisi No Faktur
        runFilter(); 
        setFocus('p_faktur');
    } else if (currentStep === 'faktur') {
        setFocus('p_scan_label');
    }
}

function clearAllFields(isManual = true) {
    if(isManual) {
        // Jika ditekan tombol Clear (Point 12)
        const yakin = confirm("Hapus Semua Inputan?");
        if(!yakin) return;
    }

    // Reset Dropdown ke default
    document.getElementById('p_jenis').value = "";
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
    
    // Kosongkan semua inputan teks
    const ids = ['p_kode','p_nama','p_urpick','p_scan_label','p_scan_fisik','p_plu','p_descp','p_zona','p_qty_input','p_qty_data'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = "";
    });

    // Reset area fisik & readonly qty
    document.getElementById('area_fisik').style.display = 'none';
    const qtyInp = document.getElementById('p_qty_input');
    qtyInp.readOnly = true; 
    qtyInp.style.background = "#dcdcdc";

    // Fokus kembali ke TGL atau JENIS
    setFocus('p_tgl');
}

// Tambahkan listener pada TGL dan JENIS untuk trigger reset (Point 9)
document.getElementById('p_tgl').addEventListener('change', () => {
    // Jika ganti tanggal, reset semua field di bawahnya
    ['p_kode','p_nama','p_urpick','p_scan_label'].forEach(id => document.getElementById(id).value = "");
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
});

async function refreshMonitoringData() {
    const loader = document.getElementById('loader');
    const modalMonitor = document.getElementById('modal_monitor');

    modalMonitor.style.display = 'none'; // Tutup dulu
    loader.style.display = 'flex';       // Muncul loader

    try {
        const res = await fetch(G_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "getAllData" })
        });
        const out = await res.json();

        if (out.status === "success") {
            // Update dbSudahPolcek
            dbSudahPolcek = (out.dataSudahPolcek || []).map(r => ({
                tgl: String(r.tgl || "").substring(0, 10),
                kode: String(r.kode || "").trim().toUpperCase(),
                jenis: String(r.jenis || "").trim().toUpperCase(),
                barcode: String(r.barcode || "").trim().toUpperCase(), 
                qty_scan: Number(r.qty_scan || 0)
            }));
            localStorage.setItem("db_sudah_polcek", JSON.stringify(dbSudahPolcek));
        }
    } catch (e) {
        Swal.fire("Gagal", "Koneksi Bermasalah", "error");
    } finally {
        loader.style.display = 'none'; // Matikan loader
        
        // JALANKAN INI UNTUK MEMBUKA KEMBALI MODAL
        showMonitoring(); 
    }
}

function openResetModal() {
    document.getElementById('modal_reset').style.display = 'flex';
}

function closeResetModal() {
    document.getElementById('modal_reset').style.display = 'none';
    document.getElementById('r_nik').value = "";
    document.getElementById('r_pass_lama').value = "";
    document.getElementById('r_pass_baru').value = "";
}

async function processResetPassword() {
    const nik = document.getElementById('r_nik').value;
    const passLama = document.getElementById('r_pass_lama').value;
    const passBaru = document.getElementById('r_pass_baru').value;

    if (!nik || !passLama || !passBaru) {
        return Swal.fire("Gagal", "Semua field harus diisi!", "error");
    }

    // Tampilkan Loader
    document.getElementById('loader').style.display = 'flex';

    try {
        const res = await fetch(G_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: "updatePassword", 
                nik: nik, 
                passLama: passLama, 
                passBaru: passBaru 
            })
        });
        const out = await res.json();

        if (out.status === "success") {
            Swal.fire("Berhasil", "Password berhasil diperbarui!", "success");
            closeResetModal();
        } else {
            Swal.fire("Gagal", out.message || "Password lama salah!", "error");
        }
    } catch (e) {
        Swal.fire("Error", "Koneksi ke server bermasalah", "error");
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
}

window.onbeforeunload = function() {
    if (localStorage.getItem("isLoggedIn") === "true") {
        return "Proses Polcek sedang berjalan. Anda yakin ingin menutup halaman?";
    }
};

// Fungsi untuk membunyikan suara peringatan/error
function playError() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    oscillator.type = 'sawtooth'; // Suara agak kasar untuk menandakan error
    oscillator.frequency.setValueAtTime(150, audioCtx.currentTime); // Nada rendah
    
    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);

    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.5); // Bunyi selama 0.5 detik
}

async function editItemAntrian(key) {
    // SEMBUNYIKAN MODAL REPORT TERLEBIH DAHULU
    document.getElementById('modal_report').style.display = 'none';

    // 1. Tanyakan Opsi Revisi
    const { value: opsi } = await Swal.fire({
        title: 'OPSI REVISI',
        text: `Pilih tindakan untuk item ${key}`,
        icon: 'question',
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: 'REVISI QTY',
        denyButtonText: 'FINAL SELISIH',
        cancelButtonText: 'BATAL',
        confirmButtonColor: '#3085d6',
        denyButtonColor: '#f39c12',
        allowOutsideClick: false // Mencegah klik luar agar modal report tidak "nyangkut"
    });

    // JIKA USER TEKAN BATAL / CANCEL
    if (opsi === undefined) {
        document.getElementById('modal_report').style.display = 'block';
        return;
    }

    if (opsi === true) { 
        const { value: otp } = await Swal.fire({
            title: 'VERIFIKASI OTP',
            input: 'password',
            inputPlaceholder: 'Masukkan OTP Supervisor',
            showCancelButton: true
        });

        if (otp === "1234") { 
            const { value: qtyBaru } = await Swal.fire({
                title: 'INPUT QTY BARU',
                input: 'number',
                inputAttributes: { min: 0 },
                showCancelButton: true
            });

            if (qtyBaru !== undefined) {
                updateQtyLokal(key, parseInt(qtyBaru), "");
                await Swal.fire('Berhasil', 'Qty telah diperbarui', 'success');
            }
        } else if (otp) {
            await Swal.fire('Gagal', 'OTP Salah!', 'error');
        }
    } 

    else if (opsi === false) { 
        const { value: formValues } = await Swal.fire({
            title: 'FINAL SELISIH',
            html:
                '<input id="swal-otp" class="swal2-input" placeholder="OTP Supervisor" type="password">' +
                '<textarea id="swal-ket" class="swal2-textarea" placeholder="Keterangan Wajib (Pecah/Hilang/dll)"></textarea>',
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'OK PAKSA FINAL',
            preConfirm: () => {
                const otp = document.getElementById('swal-otp').value;
                const ket = document.getElementById('swal-ket').value;
                if (!otp || !ket) {
                    Swal.showValidationMessage('OTP dan Keterangan WAJIB diisi!');
                }
                return { otp: otp, ket: ket };
            }
        });

        if (formValues) {
            if (formValues.otp === "1234") {
                updateQtyLokal(key, null, formValues.ket);
                await Swal.fire('Tersimpan', 'Status: Paksa Final (Selisih)', 'warning');
            } else {
                await Swal.fire('Gagal', 'OTP Salah!', 'error');
            }
        }
    }

       showReport(); 
}

function updateQtyLokal(key, qtyBaru, keterangan) {
    let antrian = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    antrian.forEach(item => {
        if (item.plu === key || item.barcode === key || item.kontainer === key) {
            if (qtyBaru !== null) item.qty_scan = qtyBaru;
            if (keterangan) item.keterangan = keterangan;
        }
    });
    localStorage.setItem('q_polcek', JSON.stringify(antrian));
}

function handleScanToko(val) {
    if (!val) return;

    // Pecah barcode berdasarkan tanda strip '-'
    const parts = val.split('-').filter(Boolean);
    let hasilKode = val.toUpperCase().trim();

    // 1. Logika Ekstraksi Kode Toko
    if (parts.length > 1) {
        if (val.toUpperCase().includes("KONTAINER") || parts.length === 2) {
            // Contoh: A0001-R665 -> Toko di parts[1]
            hasilKode = parts[1].toUpperCase();
        } 
        else if (val.toUpperCase().includes("DOS") || parts.length >= 4) {
            // Contoh: DOS-C5-R665-432296 -> Toko di parts[2]
            hasilKode = parts[2].toUpperCase();
        }
    }

    // 2. Masukkan hasil ke input KD STORE
    document.getElementById('p_kode').value = hasilKode;

    // 3. Jalankan filter toko (agar list faktur terisi)
    if (typeof filterToko === "function") {
        filterToko(); 
    }

    // 4. PINDAHKAN FOKUS KE NO FAKTUR
    // Gunakan setTimeout sedikit agar browser sempat merender list faktur terlebih dahulu
    setTimeout(() => {
        const elFaktur = document.getElementById('p_faktur');
        if (elFaktur) {
            elFaktur.focus();
            // Jika p_faktur adalah dropdown/select, kita bisa memicu pembukaan list
            console.log("Fokus pindah ke No Faktur");
        }
    }, 300);
}


// Fungsi untuk menampilkan Area Scan dan menyembunyikan Header
function toggleAreaScan() {
    const tgl = document.getElementById('p_tgl').value;
    const kode = document.getElementById('p_kode').value;
    const faktur = document.getElementById('p_faktur').value;

    // Jika ketiga data utama sudah terisi
    if (tgl && kode && faktur) {
        document.getElementById('section_header').style.display = 'none'; // Sembunyikan Atas
        document.getElementById('section_scan').style.display = 'block'; // Tampilkan Bawah
        
        // Langsung fokuskan ke tempat scan label agar user tidak klik lagi
        setTimeout(() => {
            document.getElementById('p_scan_label').focus();
        }, 300);
    }
}

// Fungsi untuk kembali ke layar utama (setelah final atau klik tombol kembali)
function backToHeader() {
    document.getElementById('section_header').style.display = 'block'; // Tampilkan Atas
    document.getElementById('section_scan').style.display = 'none';   // Sembunyikan Bawah
    
    // Reset input agar bersih untuk input toko baru
    document.getElementById('p_kode').value = "";
    document.getElementById('p_nama').value = "";
    document.getElementById('p_faktur').innerHTML = '<option value="">-- PILIH FAKTUR --</option>';
}

function kembaliKeHeader() {
    document.getElementById('group_header').style.display = 'block';
    document.getElementById('group_scan').style.display = 'none';
    setFocus('p_faktur');
}

// Pastikan saat Clear data atau setelah Final, tampilan kembali ke Header
function resetTampilanLayar() {
    document.getElementById('group_header').style.display = 'block';
    document.getElementById('group_scan').style.display = 'none';
}

function showAntrianModal() {
    const scanDB = JSON.parse(localStorage.getItem('q_polcek') || "[]");
    const tbody = document.getElementById('antrian_body');
    tbody.innerHTML = "";

    // Update summary
    const summary = document.getElementById('antrian_summary');
    if (summary) {
        summary.innerText = `Total ${scanDB.length} item dalam antrian`;
    }

    if (scanDB.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4' style='padding:30px; text-align:center; color:#7f8c8d;'>Tidak ada antrian data</td></tr>";
        
        // Sembunyikan footer action jika kosong
        const footerAction = document.getElementById('footer_antrian_action');
        if (footerAction) footerAction.innerHTML = '';
    } else {
        // ðŸ”¥ PERBAIKAN: Group berdasarkan (faktur + kode + jenis)
        const groups = new Map();
        
        scanDB.forEach(item => {
            const key = `${item.faktur}|${item.kode}|${item.jenis}`;
            
            if (!groups.has(key)) {
                groups.set(key, {
                    urpick: item.urpick || "-",
                    kode: item.kode,
                    nama: item.nama || "",
                    tgl: item.tgl,
                    faktur: item.faktur,
                    jenis: item.jenis,
                    items: [item]
                });
            } else {
                const group = groups.get(key);
                group.items.push(item);
            }
        });

        // Konversi Map ke array dan urutkan
        const groupArray = Array.from(groups.values());
        
        // Urut berdasarkan URPICK (numerik)
        groupArray.sort((a, b) => {
            const numA = parseInt(String(a.urpick).replace(/[^0-9]/g, '')) || 0;
            const numB = parseInt(String(b.urpick).replace(/[^0-9]/g, '')) || 0;
            return numA - numB;
        });

        // Tampilkanæ¯ç»„
        groupArray.forEach(group => {
            // Warna border berdasarkan jenis
            let borderColor = '#3498db'; // default biru
            let bgColor = '#f8f9fa';
            
            switch(group.jenis) {
                case 'KONTAINER':
                    borderColor = '#2980b9';
                    bgColor = '#ebf5fb';
                    break;
                case 'DOS':
                    borderColor = '#27ae60';
                    bgColor = '#eafaf1';
                    break;
                case 'MANUAL':
                    borderColor = '#e67e22';
                    bgColor = '#fef5e7';
                    break;
                case 'TAG I':
                    borderColor = '#8e44ad';
                    bgColor = '#f5eef8';
                    break;
                default:
                    borderColor = '#7f8c8d';
                    bgColor = '#f8f9fa';
            }
            
            const itemCount = group.items.length;
            const totalQty = group.items.reduce((sum, item) => sum + (item.qty_scan || 0), 0);
            
            const row = `<tr style="background-color: ${bgColor}; border-left: 4px solid ${borderColor};">
                <td style="padding:10px; font-weight:bold;">${group.urpick}</td>
                <td style="padding:10px; text-align:left;">
                    <b>${group.kode}</b><br>
                    <span style="font-size:9px; color:#555;">${group.nama}</span>
                </td>
                <td style="padding:10px;">
                    <span style="background:${borderColor}; color:white; padding:3px 8px; border-radius:12px; font-size:10px; font-weight:bold; display:inline-block; margin-bottom:3px;">
                        ${group.jenis}
                    </span>
                    <br>
                    <span style="font-size:10px; color:#2c3e50;">
                    </span>
                </td>
                <td style="padding:10px;">
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <button onclick="pilihAntrian('${group.tgl}', '${group.kode}', '${group.faktur}', '${group.jenis}')" 
                                style="background:#27ae60; color:white; border:none; padding:8px; border-radius:4px; font-size:10px; cursor:pointer; width:100%; font-weight:bold;">
                            PROSES
                        </button>
                        <button onclick="hapusSatuAntrian('${group.faktur}', '${group.kode}', '${group.jenis}')" 
                                style="background:#e74c3c; color:white; border:none; padding:5px; border-radius:4px; font-size:9px; cursor:pointer; width:100%;">
                            HAPUS
                        </button>
                    </div>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });

        // Footer action buttons
        const footerAction = document.getElementById('footer_antrian_action');
        if (footerAction) {
            footerAction.innerHTML = `
                <button onclick="hapusSemuaAntrian()" style="background: #c0392b; flex: 1; padding: 12px; border-radius: 5px; color: white; border: none; font-weight: bold; cursor: pointer; font-size:11px;">
                    ðŸ—‘ï¸ BERSIHKAN SEMUA
                </button>
                <button onclick="document.getElementById('modal_antrian').style.display='none'" style="background: #34495e; flex: 1; padding: 12px; border-radius: 5px; color: white; border: none; font-weight: bold; cursor: pointer; font-size:11px;">
                    TUTUP
                </button>
            `;
        }
    }
    
    document.getElementById('modal_antrian').style.display = 'block';
    updateBadge(); // Pastikan badge update setelah modal dibuka
}

// ðŸ”¥ FUNGSI BARU: Helper untuk warna berdasarkan jenis
function getJenisColor(jenis) {
    const colors = {
        'KONTAINER': '#2980b9',
        'DOS': '#27ae60',
        'MANUAL': '#e67e22',
        'TAG I': '#8e44ad',
        'NON-PTL': '#7f8c8d',
        'TELUR': '#f1c40f',
        'MKT': '#e74c3c',
        'ATK GS': '#95a5a6',
        'MATERAI': '#2c3e50'
    };
    return colors[jenis] || '#34495e';
}

function hapusSatuAntrian(faktur, kode, jenis) {
    Swal.fire({
        title: 'Hapus Antrian?',
        html: `Faktur: <b>${faktur}</b><br>Toko: <b>${kode}</b><br>Jenis: <b>${jenis}</b>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Ya, Hapus!',
        didOpen: () => {
            const container = Swal.getContainer();
            if (container) container.style.zIndex = '99999';
        }
    }).then((result) => {
        if (result.isConfirmed) {
            let db = JSON.parse(localStorage.getItem('q_polcek') || "[]");
            
            // Filter berdasarkan faktur, kode, DAN jenis
            let filtered = db.filter(item => 
                !(item.faktur === faktur && 
                  item.kode === kode && 
                  item.jenis === jenis)
            );
            
            localStorage.setItem('q_polcek', JSON.stringify(filtered));
            
            updateBadge();
            showAntrianModal();

            Swal.fire({
                title: 'Terhapus!',
                text: 'Data antrian telah dihapus',
                icon: 'success',
                timer: 800,
                showConfirmButton: false
            });
        }
    });
}

function hapusSemuaAntrian() {
    Swal.fire({
        title: 'Kosongkan Antrian?',
        text: "Semua data akan dihapus untuk pembersihan data harian!",
        icon: 'warning', // Diubah dari 'danger' ke 'warning'
        showCancelButton: true,
        confirmButtonColor: '#c0392b',
        confirmButtonText: 'YA, BERSIHKAN!',
        // Memastikan z-index SweetAlert lebih tinggi dari modal (20000)
        didOpen: () => {
            const container = Swal.getContainer();
            if (container) {
                container.style.zIndex = '99999';
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            localStorage.removeItem('q_polcek');
            if (typeof updateBadge === "function") updateBadge();
            showAntrianModal(); 
            
            Swal.fire({
                title: 'Bersih!',
                text: 'Data antrian telah dikosongkan.',
                icon: 'success',
                didOpen: () => { Swal.getContainer().style.zIndex = '99999'; }
            });
        }
    });
}

function pilihAntrian(tgl, kode, faktur, jenis) {
    // Isi form dengan data yang dipilih
    document.getElementById('p_tgl').value = tgl;
    document.getElementById('p_kode').value = kode;
    document.getElementById('p_jenis').value = jenis;
    
    // Jalankan filter untuk mendapatkan nama toko dan faktur
    setTimeout(() => {
        // Panggil processStoreInput untuk mengisi nama toko
        if (typeof processStoreInput === 'function') {
            // Simulasi input kode toko
            const event = { target: { value: kode } };
            processStoreInput(event);
        }
        
        // Set faktur setelah filter jalan
        setTimeout(() => {
            const fakturSelect = document.getElementById('p_faktur');
            if (fakturSelect) {
                fakturSelect.value = faktur;
                // Trigger change event
                const changeEvent = new Event('change', { bubbles: true });
                fakturSelect.dispatchEvent(changeEvent);
            }
            
            // Tutup modal antrian
            document.getElementById('modal_antrian').style.display = 'none';
            
            // Buka modal report
            setTimeout(() => {
                if (typeof showReport === 'function') {
                    showReport();
                }
            }, 500);
        }, 500);
    }, 300);
}

function toggleArea(target) {
    const header = document.getElementById('group_header');
    const scan = document.getElementById('group_scan');

    if (target === 'HEADER') {
        header.style.display = 'block';
        scan.style.display = 'none';
    } else {
        header.style.display = 'none';
        scan.style.display = 'block';
    }
}

window.onload = function() {
    const loginStatus = localStorage.getItem("isLoggedIn");
    const savedUser = localStorage.getItem("activeUser");

    if (loginStatus === "true" && savedUser) {
        // Langsung masuk ke aplikasi tanpa login ulang
        currentUser = savedUser;
        document.getElementById('login_screen').style.display = 'none';
        document.getElementById('main_app').style.display = 'block';
        document.getElementById('display_user').innerText = savedUser;
        
        // Tarik data terbaru
        loadInitialData();
    }
};

</script>
</body>
</html>
